<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDS 化學系統流力計算器 (Engineering Calculation v2.2)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (Pinned v18.2.0) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Recharts (Pinned v2.12.7) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        /* Custom Scrollbar */
        .prose-content::-webkit-scrollbar { width: 6px; }
        .prose-content::-webkit-scrollbar-track { background: transparent; }
        .prose-content::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .prose-content::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Select Group Styling */
        optgroup { font-weight: bold; color: #475569; background-color: #f1f5f9; }
        option { color: #1e293b; background-color: #ffffff; padding: 4px; }

        /* Dark Mode Scrollbar for Engineering Check */
        .dark-scrollbar::-webkit-scrollbar { width: 4px; }
        .dark-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .dark-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        .dark-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer, ReferenceLine, ReferenceArea } = window.Recharts || {};

        // --- Icons ---
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Beaker = (props) => <IconBase {...props}><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></IconBase>;
        const Activity = (props) => <IconBase {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const HelpCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const FilterIcon = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;

        // --- Constants & Database ---
        const CONSTANTS = { G: 9.81, BAR_TO_PA: 100000 };

        const MATERIAL_DB = {
            "PFA": { name: "PFA (Schedule 40)", epsilon: 1.5e-6, type: "Plastic" },
            "SUS316L_EP": { name: "SUS316L EP (BA/EP)", epsilon: 0.5e-6, type: "Metal" },
            "PVC": { name: "Clean PVC", epsilon: 1.5e-6, type: "Plastic" },
            "PVDF": { name: "PVDF", epsilon: 1.5e-6, type: "Plastic" }
        };

        // Updated Chemical Database v2.1
        const CHEMICAL_DB = {
            // --- Group 1: Organic Solvents ---
            "PGMEA": { 
                group: "Organic Solvents (有機溶劑)", name: "PGMEA (丙二醇甲醚乙酯)", 
                sg: 0.967, visc: 1.19, type: "Solvent", 
                risk: "易燃 / 刺激性", defaultMat: "SUS316L_EP",
                note: "建議：鋁/錫/玻璃/HDPE/鋼。注意：需防靜電接地。" 
            },
            "PK_HUZ": { 
                group: "Organic Solvents (有機溶劑)", name: "PK-HUZ (PGMEA 89-99%)", 
                sg: 0.97, visc: 1.2, type: "Solvent", 
                risk: "易燃 / 嚴重眼刺激 / 暈眩", defaultMat: "SUS316L_EP",
                note: "注意：不可使用塑膠水桶 (易產生靜電)，金屬設備需接地。不相容：氧化性物質。"
            },
            "FN_DP001": { 
                group: "Organic Solvents (有機溶劑)", name: "FN-DP001 (醋酸丁酯 >99%)", 
                sg: 0.88, visc: 0.74, type: "Solvent", 
                risk: "易燃 / 呼吸道刺激", defaultMat: "SUS316L_EP",
                note: "建議：容器密閉。不相容：強氧化劑、強酸、強鹼、硝酸鹽。"
            },
            "FN_RP002": { 
                group: "Organic Solvents (有機溶劑)", name: "FN-RP002 (MIBC >99%)", 
                sg: 0.82, visc: 5.8, type: "Solvent", 
                risk: "易燃 / 吸入有害 / 眼刺激", defaultMat: "SUS316L_EP",
                note: "建議：儲存於陰涼黑暗處。不相容：強氧化劑。"
            },
            "IPA": { 
                group: "Organic Solvents (有機溶劑)", name: "IPA (異丙醇 >99%)", 
                sg: 0.785, visc: 2.0, type: "Solvent", 
                risk: "高度易燃 / 暈眩", defaultMat: "SUS316L_EP",
                note: "建議：需接地。不相容：強氧化劑、鐵鹽、氫-鈀、強酸。"
            },
            "RER_900": { 
                group: "Organic Solvents (有機溶劑)", name: "RER 900 (環己酮 >95%)", 
                sg: 0.942, visc: 2.01, type: "Solvent", 
                risk: "易燃 / 吸入吞食有害", defaultMat: "SUS316L_EP",
                note: "建議：密封的原始容器。不相容：強氧化劑、硝酸。"
            },
            "SST_A47": { 
                group: "Organic Solvents (有機溶劑)", name: "SST-A47 (NMP 75%)", 
                sg: 1.03, visc: 1.65, type: "Solvent", 
                risk: "生殖毒性 / 眼刺激", defaultMat: "PFA",
                note: "注意：金屬部份需接地。不相容：氧化劑、還原劑。"
            },
            "LA95": { 
                group: "Organic Solvents (有機溶劑)", name: "LA95 THINNER (GBL 95%)", 
                sg: 1.12, visc: 1.7, type: "Solvent", 
                risk: "吞食有害 / 眼刺激", defaultMat: "SUS316L_EP",
                note: "注意：金屬部份需接地以防靜電；避免接觸氧化劑。"
            },

            // --- Group 2: Acids ---
            "H2SO4_96": { 
                group: "Acids (酸類)", name: "硫酸 (H2SO4 96%)", 
                sg: 1.839, visc: 25.0, type: "Acid", 
                risk: "劇毒 / 嚴重灼傷 / 高黏度 / 油性", defaultMat: "PFA",
                note: "建議：抗腐蝕材料。不相容：大部分金屬(不鏽鋼/鋁/鎳)、水(劇烈放熱)、有機物。"
            },
            "HNO3_70": { 
                group: "Acids (酸類)", name: "硝酸 (HNO3 70%)", 
                sg: 1.41, visc: 2.0, type: "Acid", 
                risk: "氧化性 / 吸入致命 / 灼傷", defaultMat: "PFA",
                note: "建議：抗蝕建材、合格貯櫃/玻璃瓶。不相容：金屬粉末、有機物(易燃/爆炸)、還原劑。"
            },
            "HCL_37": { 
                group: "Acids (酸類)", name: "鹽酸 (HCl 36.5%)", 
                sg: 1.18, visc: 1.9, type: "Acid", 
                risk: "發煙 / 吸入有毒 / 金屬腐蝕", defaultMat: "PFA",
                note: "建議：防蝕建材。不相容：金屬(生成氫氣)、鹼、氰化物。"
            },
            "H3PO4_86": { 
                group: "Acids (酸類)", name: "磷酸 (H3PO4 86%)", 
                sg: 1.71, visc: 45.0, type: "Acid", 
                risk: "極高黏度 / 吞食有害", defaultMat: "PFA",
                note: "建議：HDPE, 玻璃, 搪瓷, PP。不相容：金屬(生成氫氣)、鹼類。"
            },
            "HF_49": { 
                group: "Acids (酸類)", name: "氫氟酸 (HF 49%)", 
                sg: 1.185, visc: 1.0, type: "Acid", 
                risk: "劇毒 / 蝕骨 / 致命", defaultMat: "PFA",
                note: "建議：抗腐蝕材質(如塑膠)。絕對禁用：玻璃、陶器、含矽金屬 (溶解)。"
            },
            "LAL_6500": { 
                group: "Acids (酸類)", name: "LAL 6500 (NH4F 57% / HF)", 
                sg: 1.1, visc: 1.5, type: "Acid", 
                risk: "劇毒 / 嚴重灼傷", defaultMat: "PFA",
                note: "建議：抗腐蝕容器。不相容：玻璃、鋁、水泥、強酸/鹼。"
            },
            "LAL_30": { 
                group: "Acids (酸類)", name: "LAL 30 (NH4F / HF)", 
                sg: 1.1, visc: 1.2, type: "Acid", 
                risk: "吞食有毒 / 骨骼傷害", defaultMat: "PFA",
                note: "建議：抗腐蝕容器。不相容：玻璃、鋁、水泥、強酸/鹼。"
            },
            "CMP_M02": { 
                group: "Acids (酸類)", name: "CMP-M02 (有機酸 <5%)", 
                sg: 1.018, visc: 1.0, type: "Acid", 
                risk: "皮膚灼傷 / 生殖危害疑慮", defaultMat: "PFA",
                note: "不相容：鹼性物質、氧化劑、加熱的金屬。"
            },

            // --- Group 3: Bases, Developers & Plating ---
            "TMAH_25": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "TMAH 25% (顯影液)", 
                sg: 1.014, visc: 3.13, type: "Base", 
                risk: "皮膚吸收劇毒 / 嚴重灼傷", defaultMat: "PFA",
                note: "建議：原容器(通常為塑膠)。不相容：鋁、銅、鋼、強氧化劑、強酸。"
            },
            "AD_10": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "AD-10 (TMAH 2.38%)", 
                sg: 1.0, visc: 1.0, type: "Base", 
                risk: "神經毒性 / 嚴重灼傷", defaultMat: "PFA",
                note: "建議：原容器(塑膠)。不相容：酸、含氯有機溶劑、金屬。"
            },
            "AD_1063": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "AD-1063 (TMAH 0.063%)", 
                sg: 1.0, visc: 1.0, type: "Base", 
                risk: "皮膚接觸有毒 / 灼傷", defaultMat: "PFA",
                note: "建議：塑膠瓶/塑膠袋。不相容：酸、金屬、氧化性物質。"
            },
            "NH4OH_29": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "氨水 (NH4OH 29%)", 
                sg: 0.9, visc: 1.0, type: "Base", 
                risk: "刺鼻 / 嚴重灼傷 / 水生毒性", defaultMat: "PFA",
                note: "建議：HDPE, 不鏽鋼。不相容：銅、銀、鋅(及合金)、鹵化物、酸。"
            },
            "NAOH_30": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "氫氧化鈉 (NaOH 30%)", 
                sg: 1.33, visc: 4.0, type: "Base", 
                risk: "嚴重灼傷 / 金屬腐蝕", defaultMat: "PFA",
                note: "建議：容器須密封防潮。不相容：鋁/輕金屬(產生氫氣)、酸、強氧化劑。"
            },
            "JSR_CMS": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "JSR CMS-AC010 (KOH/Amine)", 
                sg: 1.05, visc: 1.5, type: "Base", 
                risk: "吸入危害 / 特定器官毒性", defaultMat: "PFA",
                note: "建議：抗腐蝕材質容器。不相容：電解質溶液、強酸、強鹼。"
            },
            "BAKER_REZI": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "BAKER REZI-38", 
                sg: 1.0, visc: 1.2, type: "Base", 
                risk: "嚴重灼傷 / 器官傷害", defaultMat: "PFA",
                note: "注意：不得儲存於金屬容器中。不相容：酸、氧化劑、金屬。"
            },
            "MCPQ_66HD": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "MCPQ-66HD-01 (CuSO4)", 
                sg: 1.186, visc: 1.2, type: "Acidic Salt", 
                risk: "嚴重灼傷 / 水生毒性", defaultMat: "PFA",
                note: "不相容：強酸、強鹼、氧化劑。"
            },
            "MCPQ_71": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "MCPQ-71-02 (CuSO4)", 
                sg: 1.106, visc: 1.1, type: "Acidic Salt", 
                risk: "嚴重眼損傷 / 水生毒性", defaultMat: "PFA",
                note: "不相容：強酸、鹼、氧化劑。"
            },
            "MCPQ_45L": { 
                group: "Bases/Plating (鹼/顯影/電鍍)", name: "MCPQ-45L (CuSO4)", 
                sg: 1.141, visc: 1.1, type: "Acidic Salt", 
                risk: "皮膚刺激 / 水生毒性", defaultMat: "PFA",
                note: "建議：密封在乾燥通風處。"
            },

            // --- Group 4: Others ---
            "H2O2_31": { 
                group: "Others (其他)", name: "過氧化氫 (H2O2 31%)", 
                sg: 1.11, visc: 1.1, type: "Oxidizer", 
                risk: "氧化性 / 產氣風險 / 灼傷", defaultMat: "PFA",
                note: "建議：HDPE, 玻璃, 鋁。不相容：紙、易燃物、鹼類、金屬粉末、銅合金。"
            },
            "OPD_4000": { 
                group: "Others (其他)", name: "OPD 4000SC (界面活性劑)", 
                sg: 0.98, visc: 5.0, type: "Surfactant", 
                risk: "嚴重眼損傷 / 發泡風險", defaultMat: "PFA",
                note: "不相容：氧化劑、醛類。"
            },
            "DIW": { 
                group: "Others (其他)", name: "純水 (DIW - Test Only)", 
                sg: 1.0, visc: 1.0, type: "Water", 
                risk: "無", defaultMat: "PVC",
                note: "標準測試介質。"
            },
        };

        const PIPE_SIZES = [
            { label: "15A (1/2\")", id_mm: 15.8 }, 
            { label: "20A (3/4\")", id_mm: 20.9 }, 
            { label: "25A (1\")", id_mm: 26.6 }, 
            { label: "40A (1.5\")", id_mm: 40.9 }, 
            { label: "50A (2\")", id_mm: 52.5 }, 
            { label: "80A (3\")", id_mm: 77.9 }, 
        ];

        // --- Helper Components ---
        const SectionHeader = ({ number, title, icon }) => (
            <div className="flex items-center gap-3 mb-6">
                <div className="flex items-center justify-center w-8 h-8 rounded-lg bg-blue-50 text-blue-600 font-bold text-sm border border-blue-100">
                    {number}
                </div>
                <h2 className="text-lg font-bold text-slate-800 tracking-tight">{title}</h2>
            </div>
        );

        const PrimaryInputWrapper = ({ label, children, unit }) => (
            <div className="relative group">
                <label className="flex items-center justify-between text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">
                    {label}
                    <span className="text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold">必填</span>
                </label>
                <div className="relative">
                    {children}
                    {unit && <span className="absolute right-3 top-3 text-xs text-slate-400 font-bold pointer-events-none">{unit}</span>}
                </div>
            </div>
        );

        // --- Custom Tooltip for Engineering Data ---
        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                const data = payload[0].payload;
                return (
                    <div className="bg-slate-800/95 backdrop-blur-sm p-4 rounded-xl border border-slate-700 shadow-xl text-xs text-slate-300 z-50">
                        <p className="font-bold text-white text-sm mb-2 border-b border-slate-600 pb-2">{label}</p>
                        <div className="space-y-1.5">
                            <div className="flex justify-between gap-4">
                                <span>流速 (Velocity):</span>
                                <span className={`font-mono font-bold ${data.vSafe ? 'text-emerald-400' : 'text-red-400'}`}>{data.v} m/s</span>
                            </div>
                            <div className="flex justify-between gap-4">
                                <span>總揚程 (TDH):</span>
                                <span className="font-mono font-bold text-white">{data.TDH_m} m</span>
                            </div>
                            <div className="flex justify-between gap-4">
                                <span>雷諾數 (Re):</span>
                                <span className="font-mono text-indigo-300">{data.Re}</span>
                            </div>
                            <div className="flex justify-between gap-4 mt-2 pt-2 border-t border-slate-700">
                                <span>總壓損 (Pump Req):</span>
                                <span className="font-mono font-bold text-amber-400">{data.P_pump_bar} Bar</span>
                            </div>
                        </div>
                        {data.isRecommended && (
                            <div className="mt-3 bg-emerald-500/20 text-emerald-300 px-2 py-1 rounded text-center font-bold border border-emerald-500/30">
                                ⭐ Recommended
                            </div>
                        )}
                    </div>
                );
            }
            return null;
        };

        const HelpModal = ({ onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col relative overflow-hidden">
                    <div className="bg-slate-900 text-white p-6 flex items-center justify-between shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="bg-white/10 p-2 rounded-lg">
                                <Beaker size={20} className="text-blue-400" />
                            </div>
                            <h3 className="text-lg font-bold">工程設計邏輯與警示說明</h3>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors"><X size={20} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto space-y-6 text-sm text-slate-600 leading-relaxed">
                        <section>
                            <h4 className="font-bold text-slate-900 text-base mb-2 flex items-center gap-2">
                                <span className="w-1.5 h-6 bg-blue-500 rounded-full"></span>
                                1. 流況判斷 (Flow Regime Logic)
                            </h4>
                            <p>依據 Reynolds Number (Re) 進行判斷：</p>
                            <ul className="list-disc pl-5 mt-2 space-y-1">
                                <li><strong>Re &lt; 2000 (Laminar):</strong> 使用層流公式 \( f = 64/Re \)。</li>
                                <li><strong>2000 ≤ Re &lt; 4000 (Transition):</strong> 保守視為層流計算，標示為 Transition (Conservative)。</li>
                                <li><strong>Re ≥ 4000 (Turbulent):</strong> 使用 Swamee-Jain 公式計算。</li>
                            </ul>
                        </section>
                        <section>
                            <h4 className="font-bold text-slate-900 text-base mb-2 flex items-center gap-2">
                                <span className="w-1.5 h-6 bg-amber-500 rounded-full"></span>
                                2. 管件與元件假設 (Fittings & Components)
                            </h4>
                            <ul className="list-disc pl-5 mt-2 space-y-1">
                                <li><strong>Elbow (彎頭):</strong> 假設為 Long Radius 90° Elbow (K=0.9)。若是 Short Radius 或特殊管件，請自行保守評估。</li>
                                <li><strong>Filter/Instrument:</strong> 假設為額定流量下的 Nominal ΔP。</li>
                            </ul>
                        </section>
                        <section>
                            <h4 className="font-bold text-slate-900 text-base mb-2 flex items-center gap-2">
                                <span className="w-1.5 h-6 bg-emerald-500 rounded-full"></span>
                                3. 安全警示 (Safety Check)
                            </h4>
                            <ul className="list-disc pl-5 space-y-1">
                                <li><strong className="text-red-500">流速上限:</strong> 塑膠管 &gt; 2.0 m/s，金屬管 &gt; 2.5 m/s。</li>
                                <li><strong className="text-amber-500">高黏度風險:</strong> 黏度 &gt; 20cP 時，需特別檢查吸入端 NPSHa > NPSHr。</li>
                            </ul>
                        </section>
                    </div>
                    <div className="bg-slate-50 p-4 border-t border-slate-200 text-right">
                        <button onClick={onClose} className="px-6 py-2 bg-slate-900 text-white font-bold rounded-lg hover:bg-slate-800 transition-colors">了解</button>
                    </div>
                </div>
            </div>
        );

        function App() {
            // Default to H2SO4 as it's a common critical chemical
            const [chemKey, setChemKey] = useState("H2SO4_96");
            const [materialKey, setMaterialKey] = useState("PFA");
            const [showHelp, setShowHelp] = useState(false);
            
            const [params, setParams] = useState({
                flowLPM: 40,      
                length: 100,      
                elevation: 10,    
                elbows: 10,       
                reqPressure: 2.5, 
                filterQty: 1,
                filterDP: 0.5,    
                instrumentQty: 1,
                instrumentDP: 0.2 
            });

            useEffect(() => {
                const chem = CHEMICAL_DB[chemKey];
                if (chem && chem.defaultMat) {
                    setMaterialKey(chem.defaultMat);
                }
            }, [chemKey]);

            // Group Chemicals for Select Dropdown
            const groupedChemicals = useMemo(() => {
                const groups = {};
                Object.entries(CHEMICAL_DB).forEach(([key, chem]) => {
                    if (!groups[chem.group]) groups[chem.group] = [];
                    groups[chem.group].push({ key, ...chem });
                });
                return groups;
            }, []);

            // Core Calculation with Scoring
            const calculation = useMemo(() => {
                const chem = CHEMICAL_DB[chemKey];
                const material = MATERIAL_DB[materialKey];
                const densityKgM3 = chem.sg * 1000;
                const viscosityPaS = chem.visc / 1000; 
                const Q_m3s = params.flowLPM / 60000; 

                // Material Velocity Limit
                const maxV = material.type === "Metal" ? 2.5 : 2.0;

                const results = PIPE_SIZES.map(pipe => {
                    const D_m = pipe.id_mm / 1000;
                    const Area = Math.PI * Math.pow(D_m/2, 2);
                    const v = Q_m3s / Area; 
                    const Re = (densityKgM3 * v * D_m) / viscosityPaS;

                    // Friction Factor Logic
                    let f = 0.02;
                    let regime = "Turbulent";
                    
                    if (Re < 2000) {
                        f = 64 / Re;
                        regime = "Laminar";
                    } else if (Re < 4000) {
                        // Conservative Transition
                        f = 64 / Re;
                        regime = "Transition (Conservative)";
                    } else {
                        // Swamee-Jain for Turbulent
                        const epsilon = material.epsilon;
                        f = 0.25 / Math.pow(Math.log10((epsilon/(3.7*D_m)) + (5.74/Math.pow(Re, 0.9))), 2);
                    }

                    // Head Loss Components
                    const hf = f * (params.length / D_m) * (Math.pow(v, 2) / (2 * CONSTANTS.G));
                    
                    // Fitting Head (K=0.9 for Long Radius Elbows)
                    const K_total = params.elbows * 0.9; 
                    const hm = K_total * (Math.pow(v, 2) / (2 * CONSTANTS.G));
                    
                    const h_static = params.elevation; 
                    const dP_components_bar = (params.filterQty * params.filterDP) + (params.instrumentQty * params.instrumentDP);
                    const h_components = (dP_components_bar * 1e5) / (densityKgM3 * CONSTANTS.G);
                    const h_pressure_end = (params.reqPressure * 1e5) / (densityKgM3 * CONSTANTS.G);
                    
                    const TDH_m = h_static + hf + hm + h_components + h_pressure_end;
                    const P_pump_bar = (densityKgM3 * CONSTANTS.G * TDH_m) / 1e5;

                    const dP_friction = (densityKgM3 * CONSTANTS.G * hf) / 1e5;
                    const dP_elevation = (densityKgM3 * CONSTANTS.G * h_static) / 1e5;
                    const dP_fitting = (densityKgM3 * CONSTANTS.G * hm) / 1e5;

                    // Safety Checks
                    const pSafe = P_pump_bar <= 6.0; 
                    const vSafeCheck = v >= 0.4 && v <= maxV; // Safe range: 0.4 ~ Max
                    
                    // Velocity Zone Logic
                    let vZone = "Safe";
                    let vColor = "#10b981"; // Green
                    if (v < 0.4) { vZone = "Risk (<0.4)"; vColor = "#ef4444"; } // Red
                    else if (v > maxV) { vZone = "Exceeded Max"; vColor = "#ef4444"; } // Red
                    else if (v < 0.5) { vZone = "Marginal"; vColor = "#f59e0b"; } // Amber

                    // Scoring Algorithm
                    let score = 100;
                    score -= Math.abs(v - 1.0) * 30; // Preference: Velocity ~ 1.0 m/s
                    if (P_pump_bar < 6.0) score += (6.0 - P_pump_bar) * 10; // Pressure margin bonus
                    
                    // Penalties
                    if (v < 0.4) score -= 200; 
                    if (v > maxV) score -= 500; // Violation of material limit
                    if (!pSafe) score -= 1000; 

                    return {
                        ...pipe, v: parseFloat(v.toFixed(2)), Re: Math.round(Re), regime,
                        TDH_m: parseFloat(TDH_m.toFixed(1)), P_pump_bar: parseFloat(P_pump_bar.toFixed(2)),
                        dP_friction, dP_elevation, dP_fitting, dP_components: dP_components_bar,
                        vSafe: vSafeCheck,
                        pSafe,
                        vZone, vColor, score
                    };
                });

                // Select Best Pipe based on Score
                const sortedResults = [...results].sort((a, b) => b.score - a.score);
                const optimal = sortedResults[0];
                
                const finalResults = results.map(r => ({
                    ...r,
                    isRecommended: r.label === optimal.label
                }));

                // Warnings & Status
                const warnings = [];
                if (chem.type === "Acid" && optimal.v < 0.4) warnings.push("⚠️ 流速過低 (<0.4 m/s)：酸液可能有沉積或結晶風險。");
                if (optimal.v >= 0.4 && optimal.v < 0.5) warnings.push("⚠️ 流速邊緣 (Marginal)：建議監控是否產生沉積。");
                if (optimal.v > maxV) warnings.push(`⚠️ 流速過高 (>${maxV} m/s)：超過 ${material.type} 材質允許上限，有磨損或靜電風險。`);
                
                if (optimal.regime.includes("Laminar") && params.length > 100) warnings.push("⚠️ 長距離層流 (>100m)：可能有脈動或反應延遲風險。");
                if (optimal.dP_components > optimal.dP_friction) warnings.push("⚠️ 元件壓損過大：請檢查過濾器尺寸，目前大於管路摩擦損耗。");
                
                if (chem.visc > 20) {
                     warnings.push(`⚠️ 高黏度流體 (${chem.visc}cP)：請確認吸入管徑足夠，並檢查 NPSHa > NPSHr。`);
                }

                if (chem.group.includes("Solvent") && material.type !== "Metal") {
                    warnings.push(`⚠️ 材質注意：有機溶劑建議優先使用金屬管 (SUS316L)，目前使用 ${material.name}。`);
                }

                let sysStatus = "PASS";
                let statusColor = "bg-emerald-500";
                let statusIcon = <CheckCircle size={16} />;
                
                if (!optimal.pSafe || optimal.v > maxV || optimal.v < 0.4) {
                    sysStatus = "REVIEW REQUIRED";
                    statusColor = "bg-red-500";
                    statusIcon = <XCircle size={16} />;
                } else if (warnings.length > 0) {
                    sysStatus = "PASS WITH WARNING";
                    statusColor = "bg-amber-500";
                    statusIcon = <AlertTriangle size={16} />;
                }

                return { results: finalResults, optimal, chem, material, warnings, sysStatus, statusColor, statusIcon };
            }, [chemKey, materialKey, params]);

            const { results, optimal, chem, warnings, sysStatus, statusColor, statusIcon } = calculation;

            return (
                <div className="min-h-screen font-sans text-slate-800 pb-20 bg-slate-50">
                    
                    {/* Top Navigation / Hero Header */}
                    <div className="w-full bg-slate-50 pt-6 px-4 md:px-8 pb-8">
                        <div className="max-w-7xl mx-auto">
                            <div className="bg-[#1e293b] rounded-2xl shadow-xl p-5 md:p-6 text-white flex flex-col md:flex-row items-start md:items-center justify-between gap-6 relative overflow-hidden">
                                {/* Background decoration */}
                                <div className="absolute top-0 right-0 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>

                                <div className="flex items-center gap-5 relative z-10">
                                    <div className="bg-white/10 p-3 rounded-xl border border-white/10 backdrop-blur-sm">
                                        <Beaker size={28} className="text-blue-400" />
                                    </div>
                                    <div>
                                        <h1 className="text-2xl font-bold tracking-tight">CDS 化學供應系統</h1>
                                        <div className="flex items-center gap-2 text-xs font-medium text-slate-400 mt-1 uppercase tracking-wider">
                                            <span className="text-emerald-400 font-bold">Phase 2.5</span>
                                            <span className="w-1 h-1 bg-slate-500 rounded-full"></span>
                                            <span>Engineering Edition v2.2</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex items-center gap-3 relative z-10">
                                    <button 
                                        onClick={() => setShowHelp(true)}
                                        className="flex items-center gap-2 px-4 py-2.5 bg-white/5 border border-white/10 rounded-full text-slate-300 hover:bg-white/10 hover:text-white transition-all"
                                    >
                                        <HelpCircle size={18} />
                                        <span className="text-xs font-bold">設計規範</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}

                    <div className="max-w-7xl mx-auto px-4 md:px-8 space-y-8">
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Hazard Alert */}
                            {chem.risk && (
                                <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-4 h-full">
                                    <div className="p-2 bg-amber-100 text-amber-700 rounded-lg shrink-0">
                                        <AlertTriangle size={20} />
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-amber-900 uppercase tracking-wide text-xs mb-1">化學品特性提示 (Chemical Hazard)</h4>
                                        <p className="text-sm text-amber-800 font-medium leading-relaxed">{chem.risk}</p>
                                    </div>
                                </div>
                            )}

                            {/* Storage Compatibility Alert (NEW) */}
                            {chem.note && (
                                <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 flex items-start gap-4 h-full">
                                    <div className="p-2 bg-blue-100 text-blue-700 rounded-lg shrink-0">
                                        <Info size={20} />
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-blue-900 uppercase tracking-wide text-xs mb-1">儲存與相容性警示 (Storage & Compatibility)</h4>
                                        <p className="text-sm text-blue-800 font-medium leading-relaxed">{chem.note}</p>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            {/* --- 01 Design Parameters --- */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8">
                                <SectionHeader number="01" title="化學品與材質設定 (Parameters)" />
                                
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">化學品種類 (Select Chemical)</label>
                                        <select 
                                            className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all cursor-pointer hover:bg-slate-100"
                                            value={chemKey} onChange={e => setChemKey(e.target.value)}
                                        >
                                            {Object.entries(groupedChemicals).map(([groupName, items]) => (
                                                <optgroup key={groupName} label={groupName}>
                                                    {items.map(item => (
                                                        <option key={item.key} value={item.key}>{item.name}</option>
                                                    ))}
                                                </optgroup>
                                            ))}
                                        </select>

                                        {/* Physical Properties Display (NEW) */}
                                        <div className="mt-3 grid grid-cols-2 gap-3">
                                            <div className="bg-slate-100/50 p-2 rounded-lg border border-slate-200 flex flex-col items-center justify-center">
                                                <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">比重 (S.G.)</span>
                                                <span className="text-sm font-mono font-bold text-slate-700">{chem.sg}</span>
                                            </div>
                                            <div className="bg-slate-100/50 p-2 rounded-lg border border-slate-200 flex flex-col items-center justify-center">
                                                <span className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">動力黏度 (Viscosity)</span>
                                                <div className="flex items-baseline gap-1">
                                                    <span className={`text-sm font-mono font-bold ${chem.visc > 20 ? 'text-amber-600' : 'text-slate-700'}`}>{chem.visc}</span>
                                                    <span className="text-[10px] text-slate-400 font-bold">cP</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">管材材質 (Material)</label>
                                        <select 
                                            className="w-full px-4 py-3 bg-white border border-slate-300 rounded-xl text-sm font-semibold text-blue-700 outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 shadow-sm cursor-pointer"
                                            value={materialKey} onChange={e => setMaterialKey(e.target.value)}
                                        >
                                            {Object.entries(MATERIAL_DB).map(([k, v]) => (
                                                <option key={k} value={k}>{v.name} (ε: {v.epsilon}m)</option>
                                            ))}
                                        </select>
                                        <div className="mt-2 text-[10px] text-slate-400 flex items-center gap-1">
                                            <CheckCircle size={10} className="text-emerald-500"/>
                                            建議材質: {CHEMICAL_DB[chemKey].defaultMat}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-6">
                                        <PrimaryInputWrapper label="設計流量 (Flow Rate)" unit="LPM">
                                            <input type="number" className="w-full p-3 bg-blue-50/50 border border-blue-200 focus:border-blue-500 rounded-xl text-xl font-mono text-blue-700 font-bold outline-none transition-all"
                                                value={params.flowLPM} onChange={e => setParams({...params, flowLPM: parseFloat(e.target.value) || 0})}/>
                                        </PrimaryInputWrapper>
                                        <PrimaryInputWrapper label="需求壓力 (Req. Pressure)" unit="Bar">
                                            <input type="number" step="0.1" className="w-full p-3 bg-white border border-slate-300 focus:border-blue-500 rounded-xl text-lg font-bold text-slate-800 outline-none transition-all"
                                                value={params.reqPressure} onChange={e => setParams({...params, reqPressure: parseFloat(e.target.value) || 0})}/>
                                        </PrimaryInputWrapper>
                                    </div>
                                </div>
                            </div>

                            {/* --- 02 Piping & Components --- */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 flex flex-col">
                                <SectionHeader number="02" title="管路與元件配置 (Config)" />
                                
                                <div className="space-y-6 flex-1">
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="col-span-2">
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">管路總長度 (Total Length)</label>
                                            <div className="relative">
                                                <input type="number" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-lg font-mono text-slate-700 outline-none"
                                                    value={params.length} onChange={e => setParams({...params, length: parseFloat(e.target.value) || 0})}/>
                                                <span className="absolute right-3 top-4 text-xs text-slate-400 font-bold pointer-events-none">m</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">爬升高度 (Elevation)</label>
                                            <div className="relative">
                                                <input type="number" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-base font-mono text-center outline-none"
                                                    value={params.elevation} onChange={e => setParams({...params, elevation: parseFloat(e.target.value) || 0})}/>
                                                <span className="absolute right-3 top-3.5 text-xs text-slate-400 font-bold">m</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">彎頭數量 (Elbows)</label>
                                            <input type="number" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-base font-mono text-center outline-none"
                                                value={params.elbows} onChange={e => setParams({...params, elbows: parseInt(e.target.value) || 0})}/>
                                        </div>
                                    </div>

                                    {/* Components */}
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <label className="block text-[10px] font-bold text-slate-400 uppercase mb-3 flex items-center gap-1">
                                            <FilterIcon size={10} /> 元件損耗 (Filter & Instrument)
                                        </label>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <span className="text-xs text-slate-500 block mb-1">過濾器數量</span>
                                                <input type="number" className="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm font-mono text-center"
                                                    value={params.filterQty} onChange={e => setParams({...params, filterQty: parseFloat(e.target.value) || 0})}/>
                                            </div>
                                            <div>
                                                <span className="text-xs text-slate-500 block mb-1">單顆壓損 (Bar)</span>
                                                <input type="number" step="0.1" className="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm font-mono text-center"
                                                    value={params.filterDP} onChange={e => setParams({...params, filterDP: parseFloat(e.target.value) || 0})}/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* --- 03 Result (Dark Section, Redesigned) --- */}
                        <div className="rounded-3xl overflow-hidden shadow-2xl bg-[#0f172a] text-white">
                            <div className="p-6 md:p-8 border-b border-white/10 flex items-center justify-between">
                                <h2 className="text-xl font-bold flex items-center gap-3">
                                    <span className="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold">03</span>
                                    計算結果 (Analysis Result)
                                </h2>
                                <div className={`px-4 py-1.5 ${statusColor}/20 border ${statusColor}/30 rounded-full text-xs font-bold ${statusColor === 'bg-red-500' ? 'text-red-300' : (statusColor === 'bg-amber-500' ? 'text-amber-300' : 'text-emerald-300')} flex items-center gap-2 uppercase tracking-wider`}>
                                    {statusIcon} {sysStatus}
                                </div>
                            </div>

                            <div className="p-6 md:p-8 space-y-8">
                                
                                {/* Row 1: Metrics & Engineering Check */}
                                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                    
                                    {/* 1.1: Recommended Pipe & Key Metrics (Left, larger) */}
                                    <div className="lg:col-span-7 flex flex-col justify-between">
                                        <div>
                                            <div className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">建議管徑 (Recommended)</div>
                                            <div className="flex items-baseline gap-4 mb-6">
                                                <span className="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
                                                    {optimal.label.split(' ')[0]}
                                                </span>
                                                <span className="text-xl text-slate-400 font-medium">{optimal.label.split(' ')[1]}</span>
                                            </div>
                                        </div>

                                        {/* Metrics Grid (Card Style) */}
                                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                            <div className="bg-white/5 rounded-xl p-4 border border-white/5 hover:bg-white/10 transition-colors">
                                                <div className="text-slate-400 text-xs mb-1 font-bold">總揚程 (Total Head)</div>
                                                <div className="text-2xl font-mono font-bold">{optimal.TDH_m} <span className="text-sm text-slate-500">m</span></div>
                                            </div>
                                            <div className="bg-white/5 rounded-xl p-4 border border-white/5 hover:bg-white/10 transition-colors">
                                                <div className="text-slate-400 text-xs mb-1 font-bold">幫浦出口壓力</div>
                                                <div className={`text-2xl font-mono font-bold ${optimal.P_pump_bar > 6 ? 'text-red-400' : 'text-emerald-400'}`}>
                                                    {optimal.P_pump_bar} <span className="text-sm">Bar</span>
                                                </div>
                                            </div>
                                            <div className="bg-white/5 rounded-xl p-4 border border-white/5 hover:bg-white/10 transition-colors">
                                                <div className="text-slate-400 text-xs mb-1 font-bold">管內流速</div>
                                                <div className="text-2xl font-mono font-bold" style={{color: optimal.vColor}}>
                                                    {optimal.v} <span className="text-sm text-slate-500">m/s</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 1.2: Engineering Check (Right) */}
                                    <div className="lg:col-span-5">
                                        <div className="bg-slate-800/50 rounded-2xl p-5 border border-white/10 h-full flex flex-col">
                                            <div className="flex items-center gap-2 mb-4 shrink-0">
                                                <Activity size={18} className="text-blue-400"/>
                                                <span className="text-xs font-bold text-slate-300 uppercase tracking-widest">Engineering Check</span>
                                            </div>
                                            <div className="space-y-3 flex-1 overflow-y-auto pr-2 dark-scrollbar max-h-[160px] lg:max-h-[200px]">
                                                {warnings.length > 0 ? (
                                                    warnings.map((warn, i) => (
                                                        <div key={i} className="flex items-start gap-3 text-xs text-amber-300 bg-amber-500/10 p-2 rounded-lg border border-amber-500/20">
                                                            <AlertTriangle size={14} className="shrink-0 mt-0.5" />
                                                            <span>{warn}</span>
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div className="flex items-center gap-3 text-xs text-emerald-400 bg-emerald-500/10 p-3 rounded-lg border border-emerald-500/20">
                                                        <CheckCircle size={16} className="shrink-0" />
                                                        <span>系統參數設計優良，無潛在風險。</span>
                                                    </div>
                                                )}
                                            </div>
                                            {/* Info Footer */}
                                            <div className="text-[10px] text-slate-500 mt-4 pt-4 border-t border-white/5 grid grid-cols-2 gap-2 shrink-0">
                                                <div>流速狀態: <span className="font-bold" style={{color: optimal.vColor}}>{optimal.vZone}</span></div>
                                                <div>雷諾數: <span className="font-mono text-slate-300">{optimal.Re}</span></div>
                                                <div className="col-span-2">流況區間: <span className="font-mono text-slate-300">{optimal.regime}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Row 2: Chart (Full Width) */}
                                <div>
                                    <div className="text-xs font-bold text-slate-500 uppercase mb-4 flex items-center gap-2">
                                        <span className="w-2 h-2 rounded-full bg-blue-500"></span>
                                        壓損分佈分析 (Pressure Drop Breakdown)
                                    </div>
                                    <div className="h-[300px] w-full bg-slate-800/30 rounded-2xl p-4 border border-white/5">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <BarChart data={results} margin={{ top: 10, right: 10, left: 10, bottom: 0 }}>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" />
                                                <XAxis dataKey="label" tick={{fontSize: 12, fill: '#94a3b8'}} axisLine={{stroke: '#334155'}} tickLine={false} />
                                                <YAxis tick={{fontSize: 11, fill: '#64748b'}} axisLine={false} tickLine={false} />
                                                <RechartsTooltip content={<CustomTooltip />} cursor={{fill: '#334155'}} />
                                                
                                                <Bar dataKey="dP_elevation" name="高度損耗" stackId="a" fill="#6366f1" />
                                                <Bar dataKey="dP_components" name="元件損耗" stackId="a" fill="#f59e0b" />
                                                <Bar dataKey="dP_friction" name="摩擦損耗" stackId="a" fill="#3b82f6" />
                                                <Bar dataKey="dP_fitting" name="管件損耗" stackId="a" fill="#0ea5e9" />
                                                
                                                <ReferenceLine y={6.0} label={{ value: 'Pump Max (6 bar)', fill: '#ef4444', fontSize: 11, position: 'insideTopRight' }} stroke="#ef4444" strokeDasharray="3 3" />
                                            </BarChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
