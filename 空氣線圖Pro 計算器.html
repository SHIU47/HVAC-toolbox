<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsychroSolver Pro-V7.5 - 緊湊核算優化版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Montserrat:ital,wght@0,700;0,800;0,900;1,800&family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');
        
        :root {
            --font-main: 'Inter', 'Noto Sans TC', system-ui, sans-serif;
            --font-heading: 'Montserrat', 'Noto Sans TC', sans-serif;
            --font-mono: 'JetBrains+Mono', monospace;
        }

        body { 
            font-family: var(--font-main); 
            background-color: #f8fafc; 
            margin: 0; 
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
        }
        
        .font-heading { font-family: var(--font-heading); letter-spacing: -0.02em; }
        .font-data { font-family: 'JetBrains+Mono', monospace; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 20px -10px rgba(0, 0, 0, 0.1); }
        
        select { appearance: none; }
        
        .process-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 2s ease-out forwards;
        }

        @keyframes dash { to { stroke-dashoffset: 0; } }

        .data-value {
            font-family: 'JetBrains+Mono', monospace;
            font-weight: 700;
            letter-spacing: -0.04em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const Icon = ({ name, className = "w-4 h-4" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const PsychroLib = {
            P: 101.325,
            getPsat: (T_db) => {
                const T = (T_db || 0) + 273.15;
                const C = T_db >= 0 
                    ? [-5.8002206e3, 1.3914993, -4.8640239e-2, 4.1764768e-5, -1.4452093e-8, 6.5459673]
                    : [-5.6745359e3, 6.3925247, -9.677843e-3, 6.2215701e-7, 2.0747825e-9, -9.484024e-13, 4.1635019];
                const lnP = T_db >= 0 
                    ? C[0]/T + C[1] + C[2]*T + C[3]*T*T + C[4]*T*T*T + C[5]*Math.log(T)
                    : C[0]/T + C[1] + C[2]*T + C[3]*T*T + C[4]*T*T*T + C[5]*T*T*T*T + C[6]*Math.log(T);
                return Math.exp(lnP) / 1000;
            },
            calculateByDBRH: (db, rh) => {
                const psat = PsychroLib.getPsat(db);
                const pw = (Math.max(0.001, Math.min(100, rh || 0)) / 100) * psat;
                const w = 0.621945 * pw / (PsychroLib.P - pw);
                const h = 1.006 * db + w * (2501 + 1.86 * db);
                const v = 0.287042 * (db + 273.15) * (1 + 1.6078 * w) / PsychroLib.P;
                const alpha = Math.log(pw);
                const dp = 6.54 + 14.526 * alpha + 0.7389 * Math.pow(alpha, 2) + 0.09486 * Math.pow(alpha, 3) + 0.4569 * Math.pow(pw, 0.1984);
                let wb = db;
                for(let i=0; i<15; i++) {
                    const pswb = PsychroLib.getPsat(wb);
                    const w_star = 0.621945 * pswb / (PsychroLib.P - pswb);
                    const f = (1.006 * wb + w_star * (2501 + 1.86 * wb)) - h;
                    wb = wb - f / (1.5 + 2.5 * w_star); 
                    if (Math.abs(f) < 0.0001) break;
                }
                return { db, rh, w, h, v, dp, wb, pw };
            },
            calculateByDBW: (db, w) => {
                const psat = PsychroLib.getPsat(db);
                const w_sat = 0.621945 * psat / (PsychroLib.P - psat);
                const w_final = Math.max(0, Math.min(w || 0, w_sat)); 
                const pw = (w_final * PsychroLib.P) / (0.621945 + w_final);
                let rh = (pw / psat) * 100;
                return PsychroLib.calculateByDBRH(db, rh);
            },
            mix: (oa, ra, oa_ratio_percent) => {
                const ratio = (oa_ratio_percent || 0) / 100;
                const hMix = (oa?.h || 0) * ratio + (ra?.h || 0) * (1 - ratio);
                const wMix = (oa?.w || 0) * ratio + (ra?.w || 0) * (1 - ratio);
                const dbMix = (hMix - 2501 * wMix) / (1.006 + 1.86 * wMix);
                return PsychroLib.calculateByDBW(dbMix, wMix);
            }
        };

        const getPipeSize = (lpm) => {
            if (!lpm || lpm <= 0) return "---";
            const val = Math.abs(lpm);
            if (val <= 19.5) return "20A";
            if (val <= 31.0) return "25A";
            if (val <= 90.0) return "32A";
            if (val <= 140.0) return "40A";
            if (val <= 219.0) return "50A";
            if (val <= 370.0) return "65A";
            if (val <= 560.0) return "80A";
            if (val <= 1020.0) return "100A";
            if (val <= 1594.0) return "125A";
            if (val <= 2295.0) return "150A";
            if (val <= 4080.0) return "200A";
            if (val <= 6375.0) return "250A";
            if (val <= 9180.0) return "300A";
            if (val <= 16064.0) return "350A";
            return "400A+";
        };

        const INSIDE = 0, LEFT = 1, RIGHT = 2, BOTTOM = 4, TOP = 8;
        const computeCode = (db, w, VIEW) => {
            let code = INSIDE;
            if (db < VIEW.dbMin) code |= LEFT;
            else if (db > VIEW.dbMax) code |= RIGHT;
            if (w < VIEW.wMin) code |= BOTTOM;
            else if (w > VIEW.wMax) code |= TOP;
            return code;
        };

        const clipLineToView = (p1, p2, VIEW) => {
            const BUFFER = 0.0001; 
            let x1 = p1.db, y1 = p1.w, x2 = p2.db, y2 = p2.w;
            let code1 = computeCode(x1, y1, VIEW), code2 = computeCode(x2, y2, VIEW);
            while (true) {
                if (!(code1 | code2)) return { x1, y1, x2, y2 };
                if (code1 & code2) return null;
                let codeOut = code1 ? code1 : code2;
                let x, y;
                if (codeOut & TOP) { x = x1 + (x2 - x1) * (VIEW.wMax - BUFFER - y1) / (y2 - y1); y = VIEW.wMax - BUFFER; }
                else if (codeOut & BOTTOM) { x = x1 + (x2 - x1) * (VIEW.wMin + BUFFER - y1) / (y2 - y1); y = VIEW.wMin + BUFFER; }
                else if (codeOut & RIGHT) { y = y1 + (y2 - y1) * (VIEW.dbMax - BUFFER - x1) / (x2 - x1); x = VIEW.dbMax - BUFFER; }
                else if (codeOut & LEFT) { y = y1 + (y2 - y1) * (VIEW.dbMin + BUFFER - x1) / (x2 - x1); x = VIEW.dbMin + BUFFER; }
                if (codeOut === code1) { x1 = x; y1 = y; code1 = computeCode(x1, y1, VIEW); }
                else { x2 = x; y2 = y; code2 = computeCode(x2, y2, VIEW); }
            }
        };

        const App = () => {
            const [mode, setMode] = useState('MAU'); 
            const [airFlow, setAirFlow] = useState(35000); 
            const [oa, setOa] = useState({ db: 35, rh: 75 });
            const [ra, setRa] = useState({ db: 26, rh: 50 }); 
            const [room, setRoom] = useState({ db: 23, rh: 50 }); 
            const [mixRatio, setMixRatio] = useState(30); 
            const [waterConfig, setWaterConfig] = useState({
                CHW_L: { in: 7, out: 12.5 },
                CHW_M: { in: 15, out: 20.5 },
                HW: { in: 60, out: 50 }
            });
            const [hoveredPoint, setHoveredPoint] = useState(null);
            
            const [coils, setCoils] = useState([
                { id: 1, energy: 'HW', label: '預熱 (Pre-Heat)', db: 35.1, rh: 74, active: true },
                { id: 2, energy: 'CHW_M', label: '預冷 (Pre-Cool)', db: 18, rh: 95, active: true },
                { id: 3, energy: 'CHW_L', label: '除濕 (Main Cool)', db: 11, rh: 98, active: true },
                { id: 4, energy: 'HW', label: '再熱 (Re-Heat)', db: 22, rh: 45, active: true }
            ]);

            const VIEW = { dbMin: -1, dbMax: 51, wMin: -0.001, wMax: 0.036 };

            const calcResults = useMemo(() => {
                const oaS = PsychroLib.calculateByDBRH(oa.db || 0, oa.rh || 0);
                const raS = PsychroLib.calculateByDBRH(ra.db || 0, ra.rh || 0);
                const roomS = PsychroLib.calculateByDBRH(room.db || 0, room.rh || 0);
                
                let startPoint;
                let maS = null;
                
                if (mode === 'MAU') {
                    startPoint = oaS;
                } else {
                    maS = PsychroLib.mix(oaS, raS, mixRatio);
                    startPoint = maS;
                }

                const stages = [{ 
                    label: mode === 'MAU' ? 'OA 外氣入口' : 'MA 混風狀態', 
                    state: startPoint, 
                    type: 'START' 
                }];

                const results = coils.map(coil => {
                    if (!coil.active) return null;
                    const start = stages[stages.length - 1].state;
                    const end = PsychroLib.calculateByDBRH(coil.db || 0, coil.rh || 0);
                    const massFlow = (airFlow || 0) / ((start.v || 0.8) * 3600); 
                    const load = massFlow * (end.h - start.h); 
                    const rt = Math.abs(load) / 3.51685;
                    const wc = waterConfig[coil.energy] || { in: 7, out: 12 };
                    const dt = Math.abs(wc.out - wc.in) || 5;
                    const lpm = (Math.abs(load) * 60) / (4.186 * dt);
                    const pipeSize = getPipeSize(lpm);
                    stages.push({ label: coil.label, state: end, energy: coil.energy });
                    return { ...coil, start, end, load, rt, lpm, pipeSize, dt };
                }).filter(Boolean);

                return { stages, results, oaState: oaS, raState: raS, maState: maS, roomState: roomS };
            }, [mode, oa, ra, room, mixRatio, coils, airFlow, waterConfig]);

            const handleExportExcel = () => {
                const wb = XLSX.utils.book_new();
                const systemSummary = [
                    ["PsychroSolver Pro 工程核算報告 (V7.5)", ""],
                    ["報告產出時間", new Date().toLocaleString()],
                    ["運作模式", mode],
                    ["設計風量 (CMH)", airFlow],
                    ["外氣比 (OA %)", mode === 'MAU' ? 100 : mixRatio],
                    ["外氣 (OA) DB/RH", `${oa.db}℃ / ${oa.rh}%`],
                    ["回風 (RA) DB/RH", mode === 'AHU' ? `${ra.db}℃ / ${ra.rh}%` : "N/A"],
                    ["目標 (Room) DB/RH", `${room.db}℃ / ${room.rh}%`],
                ];
                const ws = XLSX.utils.aoa_to_sheet([...systemSummary]);
                XLSX.utils.book_append_sheet(wb, ws, "Audit Report");
                XLSX.writeFile(wb, `PsychroAudit_${airFlow}CMH.xlsx`);
            };

            const svgW = 1000, svgH = 500; 
            const margin = { top: 30, right: 80, bottom: 40, left: 70 };
            const xScale = (db) => ((db - VIEW.dbMin) / (VIEW.dbMax - VIEW.dbMin)) * (svgW - margin.left - margin.right) + margin.left;
            const yScale = (w) => svgH - margin.bottom - ((w - VIEW.wMin) / (VIEW.wMax - VIEW.wMin)) * (svgH - margin.top - margin.bottom);

            const chartAssets = useMemo(() => {
                const step = 0.1; 
                let satPath = "";
                for (let t = VIEW.dbMin; t < VIEW.dbMax; t += step) {
                    const p1 = { db: t, w: PsychroLib.calculateByDBRH(t, 100).w };
                    const p2 = { db: t + step, w: PsychroLib.calculateByDBRH(t + step, 100).w };
                    const clipped = clipLineToView(p1, p2, VIEW);
                    if (clipped) satPath += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                }
                const rhLines = [10, 30, 50, 70, 90].map(rh => {
                    let path = "";
                    for (let t = VIEW.dbMin; t < VIEW.dbMax; t += step) {
                        const p1 = { db: t, w: PsychroLib.calculateByDBRH(t, rh).w };
                        const p2 = { db: t + step, w: PsychroLib.calculateByDBRH(t + step, rh).w };
                        const clipped = clipLineToView(p1, p2, VIEW);
                        if (clipped) path += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                    }
                    return { path, rh };
                });
                return { satPath, rhLines };
            }, [VIEW]);

            const processPaths = useMemo(() => {
                const steps = 40; 
                return calcResults.stages.slice(1).map((s, i) => {
                    const prev = calcResults.stages[i].state;
                    const isHeating = s.energy === 'HW';
                    let pathD = "";
                    for (let j = 0; j < steps; j++) {
                        const r1 = j / steps, r2 = (j + 1) / steps;
                        let db1 = prev.db + (s.state.db - prev.db) * r1, db2 = prev.db + (s.state.db - prev.db) * r2;
                        let w1, w2;
                        if (!isHeating) {
                            const w1_sat = PsychroLib.calculateByDBRH(db1, 100).w, w2_sat = PsychroLib.calculateByDBRH(db2, 100).w;
                            w1 = Math.min(prev.w + (s.state.w - prev.w) * Math.pow(r1, 1.15), w1_sat);
                            w2 = Math.min(prev.w + (s.state.w - prev.w) * Math.pow(r2, 1.15), w2_sat);
                        } else {
                            w1 = prev.w + (s.state.w - prev.w) * r1; w2 = prev.w + (s.state.w - prev.w) * r2;
                        }
                        const clipped = clipLineToView({ db: db1, w: w1 }, { db: db2, w: w2 }, VIEW);
                        if (clipped) pathD += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                    }
                    return { d: pathD, isHeating };
                });
            }, [calcResults, VIEW]);

            return (
                <div className="flex flex-col h-screen overflow-hidden antialiased text-sm">
                    {/* Header - Compact */}
                    <header className="px-6 py-3 bg-slate-950 border-b border-blue-900 flex justify-between items-center shadow-lg z-40 shrink-0">
                        <div className="flex items-center gap-4">
                            <div className="bg-blue-600 p-1.5 rounded-lg shadow-blue-500/20">
                                <Icon name="Zap" className="w-6 h-6 text-white" />
                            </div>
                            <div>
                                <h1 className="text-xl font-black font-heading tracking-tighter text-white uppercase italic leading-none">
                                    Psychro<span className="text-blue-400">Solver</span> <span className="text-blue-200/40 font-light not-italic ml-1 tracking-widest text-sm">V7.5</span>
                                </h1>
                            </div>
                        </div>
                        <div className="flex gap-2 bg-white/5 p-1 rounded-xl">
                            {['MAU', 'AHU'].map(m => (
                                <button key={m} onClick={() => setMode(m)} className={`px-6 py-1.5 rounded-lg text-[11px] font-black transition-all ${mode === m ? 'bg-white text-slate-900 shadow-lg scale-105' : 'text-white/40 hover:text-white'}`}>
                                    {m}
                                </button>
                            ))}
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden bg-slate-100">
                        {/* Sidebar - Compact Width (300px) */}
                        <aside className="w-[300px] border-r border-slate-200 bg-white overflow-y-auto p-4 space-y-6 custom-scrollbar shrink-0 shadow-md z-30">
                            <section className="space-y-4">
                                <div className="bg-slate-900 p-5 rounded-3xl shadow-lg text-center">
                                    <label className="text-[9px] font-black text-blue-400/60 uppercase block mb-1">Air Flow (CMH)</label>
                                    <div className="flex items-center justify-center gap-2">
                                        <input type="number" value={airFlow || ''} onChange={e => setAirFlow(Number(e.target.value))} className="bg-transparent text-3xl font-black text-white outline-none w-32 text-center font-heading" />
                                        <span className="text-blue-500/40 font-black text-xs font-heading">m³/h</span>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <div className="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm space-y-3 card-hover">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><div className="w-1 h-4 bg-blue-500 rounded-full"/>OA 外氣規格</p>
                                        <div className="grid grid-cols-2 gap-2">
                                            <input type="number" value={oa.db} onChange={e => setOa({...oa, db: Number(e.target.value)})} className="bg-slate-50 text-center py-2 rounded-xl border border-slate-100 font-bold text-blue-700 outline-none text-xs font-data" />
                                            <input type="number" value={oa.rh} onChange={e => setOa({...oa, rh: Number(e.target.value)})} className="bg-slate-50 text-center py-2 rounded-xl border border-slate-100 font-bold text-blue-700 outline-none text-xs font-data" />
                                        </div>
                                    </div>

                                    {mode === 'AHU' && (
                                        <div className="p-4 bg-emerald-50/50 rounded-2xl border border-emerald-100 space-y-3 card-hover">
                                            <p className="text-[10px] font-black text-emerald-800 uppercase tracking-widest flex items-center gap-2"><div className="w-1 h-4 bg-emerald-500 rounded-full"/>RA 回風 & OA%</p>
                                            <div className="grid grid-cols-2 gap-2">
                                                <input type="number" value={ra.db} onChange={e => setRa({...ra, db: Number(e.target.value)})} className="bg-white text-center py-2 rounded-xl border border-emerald-100 font-bold text-emerald-600 outline-none text-xs font-data" />
                                                <input type="number" value={ra.rh} onChange={e => setRa({...ra, rh: Number(e.target.value)})} className="bg-white text-center py-2 rounded-xl border border-emerald-100 font-bold text-emerald-600 outline-none text-xs font-data" />
                                            </div>
                                            <input type="number" value={mixRatio} onChange={e => setMixRatio(Number(e.target.value))} className="w-full bg-emerald-600 text-white py-2 rounded-xl font-black text-center outline-none text-xs font-data" />
                                        </div>
                                    )}

                                    <div className="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm space-y-3 card-hover">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-2"><div className="w-1 h-4 bg-slate-900 rounded-full"/>目標控制點</p>
                                        <div className="grid grid-cols-2 gap-2">
                                            <input type="number" value={room.db} onChange={e => setRoom({...room, db: Number(e.target.value)})} className="bg-slate-50 text-center py-2 rounded-xl border border-slate-100 font-bold text-slate-700 outline-none text-xs font-data" />
                                            <input type="number" value={room.rh} onChange={e => setRoom({...room, rh: Number(e.target.value)})} className="bg-slate-50 text-center py-2 rounded-xl border border-slate-100 font-bold text-slate-700 outline-none text-xs font-data" />
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section className="space-y-3 pb-10">
                                <div className="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-50 pb-2">
                                    <span>Coil Stages</span>
                                    <button onClick={() => setCoils([...coils, { id: Date.now(), energy: 'HW', label: '新增段位', db: 25, rh: 50, active: true }])} className="p-1 bg-blue-600 rounded-md text-white shadow-md scale-90"><Icon name="Plus"/></button>
                                </div>
                                {coils.map((c, i) => (
                                    <div key={c.id} className="p-4 bg-white border border-slate-100 rounded-2xl relative overflow-hidden shadow-sm transition-all hover:border-blue-300 group card-hover">
                                        <div className={`absolute top-0 left-0 w-1 h-full ${c.energy === 'CHW_L' ? 'bg-blue-600' : c.energy === 'CHW_M' ? 'bg-sky-400' : 'bg-rose-500'}`} />
                                        <div className="flex justify-between items-center mb-3">
                                            <div className="flex items-center gap-2">
                                                <span className="w-5 h-5 flex items-center justify-center text-[9px] font-black text-white bg-slate-900 rounded-md">{i+1}</span>
                                                <input type="text" value={c.label} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, label: e.target.value} : item))} className="bg-transparent text-[11px] font-black text-slate-800 outline-none w-32" />
                                            </div>
                                            <button onClick={() => setCoils(coils.filter(item => item.id !== c.id))} className="text-slate-200 hover:text-rose-500 opacity-0 group-hover:opacity-100"><Icon name="Trash2" className="w-3 h-3"/></button>
                                        </div>
                                        <select value={c.energy} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, energy: e.target.value} : item))} className="w-full bg-slate-50 text-[10px] font-bold text-slate-600 p-1.5 rounded-lg border border-slate-100 outline-none mb-3">
                                            <option value="HW">熱水 (HW)</option>
                                            <option value="CHW_M">中溫 (M)</option>
                                            <option value="CHW_L">低溫 (L)</option>
                                        </select>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div className="bg-slate-50 p-1.5 rounded-lg border border-slate-100 text-center"><label className="text-[8px] font-black text-slate-400 uppercase block">DB</label><input type="number" value={c.db} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, db: Number(e.target.value)} : item))} className="bg-transparent w-full font-black text-blue-600 outline-none text-xs font-data" /></div>
                                            <div className="bg-slate-50 p-1.5 rounded-lg border border-slate-100 text-center"><label className="text-[8px] font-black text-slate-400 uppercase block">RH</label><input type="number" value={c.rh} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, rh: Number(e.target.value)} : item))} className="bg-transparent w-full font-black text-blue-600 outline-none text-xs font-data" /></div>
                                        </div>
                                    </div>
                                ))}
                            </section>
                        </aside>

                        <main className="flex-1 overflow-y-auto bg-slate-50 custom-scrollbar p-6">
                            {/* Chart Area - Compact Height (450px) */}
                            <div className="bg-white rounded-[2rem] border border-slate-200 relative shadow-xl overflow-hidden flex flex-col h-[450px] shrink-0 mb-6">
                                <div className="absolute top-6 left-8 z-20 flex items-center gap-4">
                                    <div className="bg-slate-900 text-white px-4 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest shadow-lg flex items-center gap-2">
                                        <span className="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse"></span>Mapping Active
                                    </div>
                                </div>
                                
                                <svg width="100%" height="100%" viewBox={`0 0 ${svgW} ${svgH}`} preserveAspectRatio="xMidYMid meet">
                                    <g stroke="#f1f5f9" strokeWidth="1">
                                        {[0, 10, 20, 30, 40, 50].map(t => (
                                            <React.Fragment key={t}>
                                                <line x1={xScale(t)} y1={margin.top} x2={xScale(t)} y2={svgH-margin.bottom} />
                                                <text x={xScale(t)} y={svgH-margin.bottom + 20} textAnchor="middle" className="text-[10px] fill-slate-300 font-bold font-mono">{t}℃</text>
                                            </React.Fragment>
                                        ))}
                                    </g>
                                    <path d={chartAssets.satPath} fill="none" stroke="#94a3b8" strokeWidth="2" strokeDasharray="6 3" opacity="0.15" />
                                    {chartAssets.rhLines.map((rh) => (
                                        <path key={rh.rh} d={rh.path} fill="none" stroke="#e2e8f0" strokeWidth="1" strokeDasharray="3 3" />
                                    ))}
                                    {mode === 'AHU' && (
                                        <g>
                                            <line x1={xScale(calcResults.oaState.db)} y1={yScale(calcResults.oaState.w)} x2={xScale(calcResults.raState.db)} y2={yScale(calcResults.raState.w)} stroke="#cbd5e1" strokeWidth="1.5" strokeDasharray="8 4" />
                                            <circle cx={xScale(calcResults.raState.db)} cy={yScale(calcResults.raState.w)} r="6" fill="white" stroke="#10b981" strokeWidth="2" />
                                            <circle cx={xScale(calcResults.oaState.db)} cy={yScale(calcResults.oaState.w)} r="6" fill="white" stroke="#3b82f6" strokeWidth="2" />
                                        </g>
                                    )}
                                    {processPaths.map((p, i) => (
                                        <path key={i} d={p.d} stroke={p.isHeating ? "#f43f5e" : "#2563eb"} strokeWidth="5" fill="none" strokeLinecap="round" className="process-line" />
                                    ))}
                                    {calcResults.stages.map((s, i) => (
                                        <g key={i} onMouseEnter={() => setHoveredPoint(s)} onMouseLeave={() => setHoveredPoint(null)} className="cursor-pointer">
                                            <circle cx={xScale(s.state.db)} cy={yScale(s.state.w)} r="10" fill="white" stroke={i === 0 && mode === 'AHU' ? "#10b981" : "#1e293b"} strokeWidth="3" className="shadow-lg transition-all hover:r-12" />
                                            <text x={xScale(s.state.db)} y={yScale(s.state.w)} dy="3.5" textAnchor="middle" className="text-[10px] font-black fill-slate-900 pointer-events-none font-heading">{i+1}</text>
                                        </g>
                                    ))}
                                </svg>
                            </div>

                            {/* Summary Table Area - Compact Padding */}
                            <div className="bg-white border border-slate-200 rounded-[2rem] p-8 shadow-xl m-1 relative overflow-hidden">
                                <div className="flex flex-col gap-6 mb-8">
                                    <div className="flex justify-between items-end">
                                        <div className="flex items-center gap-5">
                                            <div className="bg-slate-950 p-4 rounded-2xl shadow-xl text-white transform -rotate-2"><Icon name="ClipboardCheck" className="w-6 h-6" /></div>
                                            <div>
                                                <h3 className="text-xl font-black font-heading uppercase text-slate-900 tracking-tight leading-none">工程設計能源核算表</h3>
                                                <p className="text-[9px] text-slate-400 font-black uppercase tracking-widest mt-2">{mode} Audit Report</p>
                                            </div>
                                        </div>
                                        <button onClick={handleExportExcel} className="bg-emerald-600 hover:bg-emerald-700 px-8 py-3 rounded-2xl text-[10px] font-black text-white uppercase flex items-center gap-3 shadow-emerald-500/20 active:scale-95 transition-all">
                                            <Icon name="DownloadCloud"/> 導出完整報表 (.XLSX)
                                        </button>
                                    </div>

                                    {/* Water Parameters - Compact Grid */}
                                    <div className="grid grid-cols-3 gap-6 bg-slate-50 p-6 rounded-2xl border border-slate-100">
                                        {['CHW_L', 'CHW_M', 'HW'].map(k => (
                                            <div key={k} className="space-y-3">
                                                <div className="text-[9px] font-black uppercase tracking-widest border-b border-slate-200 pb-2 flex items-center gap-2 text-slate-500">
                                                    <div className={`w-1.5 h-1.5 rounded-full ${k === 'HW' ? 'bg-rose-500' : 'bg-blue-500'}`} />
                                                    {k === 'CHW_L' ? '低溫冰水' : k === 'CHW_M' ? '中溫冰水' : '熱水系統'}
                                                </div>
                                                <div className="grid grid-cols-2 gap-3 font-mono text-xs">
                                                    <div className="flex flex-col">
                                                        <span className="text-[7px] text-slate-400 font-black uppercase mb-1">Tin</span>
                                                        <input type="number" value={waterConfig[k].in} onChange={e => setWaterConfig({...waterConfig, [k]: {...waterConfig[k], in: Number(e.target.value)}})} className="bg-white border border-slate-200 p-2 rounded-xl font-bold text-center outline-none" />
                                                    </div>
                                                    <div className="flex flex-col">
                                                        <span className="text-[7px] text-slate-400 font-black uppercase mb-1">Tout</span>
                                                        <input type="number" value={waterConfig[k].out} onChange={e => setWaterConfig({...waterConfig, [k]: {...waterConfig[k], out: Number(e.target.value)}})} className="bg-white border border-slate-200 p-2 rounded-xl font-bold text-center outline-none" />
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Table - Reduced Cell Padding & Font Scaling */}
                                <div className="w-full border border-slate-100 rounded-3xl overflow-hidden shadow-sm bg-white">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-950 text-white uppercase tracking-widest text-[8px] font-black font-heading">
                                                <th className="p-5 px-8">System Component</th>
                                                <th className="p-5 text-center border-l border-white/5 bg-slate-900">負荷 (kW)</th>
                                                <th className="p-5 text-center border-l border-white/5 bg-slate-900">負荷 (RT)</th>
                                                <th className="p-5 text-center border-l border-white/5 bg-slate-900">水量 (LPM)</th>
                                                <th className="p-5 text-center border-l border-white/5 bg-blue-800 text-blue-100">管徑 (A)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {['CHW_L', 'CHW_M', 'HW'].map(type => {
                                                const group = calcResults.results.filter(r => r.energy === type);
                                                if (group.length === 0) return null;
                                                const dotColor = type === 'CHW_L' ? 'bg-blue-600' : type === 'CHW_M' ? 'bg-sky-400' : 'bg-rose-500';
                                                return (
                                                    <React.Fragment key={type}>
                                                        <tr className="bg-slate-50/50">
                                                            <td colSpan="5" className="p-3 px-8 text-[8px] font-black text-slate-400 uppercase border-y border-slate-100 tracking-widest">
                                                                {type} Section (ΔT: {(group[0]?.dt || 5).toFixed(1)}℃)
                                                            </td>
                                                        </tr>
                                                        {group.map((res) => (
                                                            <tr key={res.id} className="border-b border-slate-50 hover:bg-blue-50/20 transition-all group">
                                                                <td className="p-5 px-8 font-black flex items-center gap-4 italic group-hover:text-blue-700">
                                                                    <div className={`w-2 h-2 rounded-full ${dotColor}`} />
                                                                    <span className="text-sm font-heading">{res.label}</span>
                                                                </td>
                                                                <td className="p-5 text-slate-900 text-2xl font-bold text-center border-l border-slate-50 font-data tracking-tighter">
                                                                    {Math.abs(res.load).toFixed(2)}
                                                                </td>
                                                                <td className="p-5 text-slate-900 text-2xl font-bold text-center border-l border-slate-50 font-data tracking-tighter">
                                                                    {(Math.abs(res.load)/3.51685).toFixed(2)}
                                                                </td>
                                                                <td className="p-5 text-slate-900 text-2xl font-bold text-center border-l border-slate-50 font-data tracking-tighter">
                                                                    {res.lpm.toFixed(2)}
                                                                </td>
                                                                <td className="p-5 text-emerald-600 text-3xl font-black text-center border-l border-slate-50 bg-emerald-50/5 font-heading italic tracking-tighter">
                                                                    {res.pipeSize}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </React.Fragment>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div className="h-20 shrink-0" />
                        </main>
                    </div>

                    {/* Tooltip - Compact */}
                    {hoveredPoint && (
                        <div className="fixed pointer-events-none z-50 transition-all duration-300" style={{ left: xScale(hoveredPoint.state.db) + 320 + 'px', top: yScale(hoveredPoint.state.w) + 100 + 'px' }}>
                            <div className="bg-slate-950/95 text-white p-5 rounded-3xl shadow-2xl w-[220px] backdrop-blur-xl border border-white/5">
                                <h4 className="text-[12px] font-black uppercase text-blue-400 italic mb-3 font-heading">{hoveredPoint.label}</h4>
                                <div className="space-y-2 text-[10px] font-mono">
                                    <div className="flex justify-between"><span>DB/WB</span><span>{hoveredPoint.state.db.toFixed(1)}/{hoveredPoint.state.wb.toFixed(1)}℃</span></div>
                                    <div className="flex justify-between border-t border-white/10 pt-2"><span className="text-slate-500 uppercase">h</span><span className="text-emerald-400 font-bold">{hoveredPoint.state.h.toFixed(2)} kJ/kg</span></div>
                                    <div className="flex justify-between"><span className="text-slate-500 uppercase">w</span><span className="text-blue-400 font-bold">{(hoveredPoint.state.w * 1000).toFixed(2)} g/kg</span></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
