<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsychroSolver Pro-V7.1 - 混風系統核算版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Montserrat:wght@700;800;900&family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@500&display=swap');
        
        :root {
            --font-main: 'Inter', 'Noto Sans TC', sans-serif;
            --font-heading: 'Montserrat', 'Noto Sans TC', sans-serif;
        }

        body { 
            font-family: var(--font-main); 
            background-color: #f8fafc; 
            margin: 0; 
            color: #1e293b;
        }
        
        .font-heading { font-family: var(--font-heading); }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        
        select { appearance: none; }
        
        .process-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 2s ease-out forwards;
        }

        @keyframes dash { to { stroke-dashoffset: 0; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const Icon = ({ name, className = "w-5 h-5" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const PsychroLib = {
            P: 101.325,
            getPsat: (T_db) => {
                const T = (T_db || 0) + 273.15;
                const C = T_db >= 0 
                    ? [-5.8002206e3, 1.3914993, -4.8640239e-2, 4.1764768e-5, -1.4452093e-8, 6.5459673]
                    : [-5.6745359e3, 6.3925247, -9.677843e-3, 6.2215701e-7, 2.0747825e-9, -9.484024e-13, 4.1635019];
                const lnP = T_db >= 0 
                    ? C[0]/T + C[1] + C[2]*T + C[3]*T*T + C[4]*T*T*T + C[5]*Math.log(T)
                    : C[0]/T + C[1] + C[2]*T + C[3]*T*T + C[4]*T*T*T + C[5]*T*T*T*T + C[6]*Math.log(T);
                return Math.exp(lnP) / 1000;
            },
            calculateByDBRH: (db, rh) => {
                const psat = PsychroLib.getPsat(db);
                const pw = (Math.max(0.001, Math.min(100, rh || 0)) / 100) * psat;
                const w = 0.621945 * pw / (PsychroLib.P - pw);
                const h = 1.006 * db + w * (2501 + 1.86 * db);
                const v = 0.287042 * (db + 273.15) * (1 + 1.6078 * w) / PsychroLib.P;
                const alpha = Math.log(pw);
                const dp = 6.54 + 14.526 * alpha + 0.7389 * Math.pow(alpha, 2) + 0.09486 * Math.pow(alpha, 3) + 0.4569 * Math.pow(pw, 0.1984);
                let wb = db;
                for(let i=0; i<15; i++) {
                    const pswb = PsychroLib.getPsat(wb);
                    const w_star = 0.621945 * pswb / (PsychroLib.P - pswb);
                    const f = (1.006 * wb + w_star * (2501 + 1.86 * wb)) - h;
                    wb = wb - f / (1.5 + 2.5 * w_star); 
                    if (Math.abs(f) < 0.0001) break;
                }
                return { db, rh, w, h, v, dp, wb, pw };
            },
            calculateByDBW: (db, w) => {
                const psat = PsychroLib.getPsat(db);
                const w_sat = 0.621945 * psat / (PsychroLib.P - psat);
                const w_final = Math.max(0, Math.min(w || 0, w_sat)); 
                const pw = (w_final * PsychroLib.P) / (0.621945 + w_final);
                let rh = (pw / psat) * 100;
                return PsychroLib.calculateByDBRH(db, rh);
            },
            mix: (oa, ra, oa_ratio_percent) => {
                const ratio = (oa_ratio_percent || 0) / 100;
                // 使用質量平衡概念進行混風
                const hMix = (oa?.h || 0) * ratio + (ra?.h || 0) * (1 - ratio);
                const wMix = (oa?.w || 0) * ratio + (ra?.w || 0) * (1 - ratio);
                const dbMix = (hMix - 2501 * wMix) / (1.006 + 1.86 * wMix);
                return PsychroLib.calculateByDBW(dbMix, wMix);
            }
        };

        const getPipeSize = (lpm) => {
            if (!lpm || lpm <= 0) return "---";
            const val = Math.abs(lpm);
            if (val <= 19.5) return "20A";
            if (val <= 31.0) return "25A";
            if (val <= 90.0) return "32A";
            if (val <= 140.0) return "40A";
            if (val <= 219.0) return "50A";
            if (val <= 370.0) return "65A";
            if (val <= 560.0) return "80A";
            if (val <= 1020.0) return "100A";
            if (val <= 1594.0) return "125A";
            if (val <= 2295.0) return "150A";
            if (val <= 4080.0) return "200A";
            if (val <= 6375.0) return "250A";
            if (val <= 9180.0) return "300A";
            if (val <= 16064.0) return "350A";
            return "400A+";
        };

        const INSIDE = 0, LEFT = 1, RIGHT = 2, BOTTOM = 4, TOP = 8;
        const computeCode = (db, w, VIEW) => {
            let code = INSIDE;
            if (db < VIEW.dbMin) code |= LEFT;
            else if (db > VIEW.dbMax) code |= RIGHT;
            if (w < VIEW.wMin) code |= BOTTOM;
            else if (w > VIEW.wMax) code |= TOP;
            return code;
        };

        const clipLineToView = (p1, p2, VIEW) => {
            const BUFFER = 0.0001; 
            let x1 = p1.db, y1 = p1.w, x2 = p2.db, y2 = p2.w;
            let code1 = computeCode(x1, y1, VIEW), code2 = computeCode(x2, y2, VIEW);
            while (true) {
                if (!(code1 | code2)) return { x1, y1, x2, y2 };
                if (code1 & code2) return null;
                let codeOut = code1 ? code1 : code2;
                let x, y;
                if (codeOut & TOP) { x = x1 + (x2 - x1) * (VIEW.wMax - BUFFER - y1) / (y2 - y1); y = VIEW.wMax - BUFFER; }
                else if (codeOut & BOTTOM) { x = x1 + (x2 - x1) * (VIEW.wMin + BUFFER - y1) / (y2 - y1); y = VIEW.wMin + BUFFER; }
                else if (codeOut & RIGHT) { y = y1 + (y2 - y1) * (VIEW.dbMax - BUFFER - x1) / (x2 - x1); x = VIEW.dbMax - BUFFER; }
                else if (codeOut & LEFT) { y = y1 + (y2 - y1) * (VIEW.dbMin + BUFFER - x1) / (x2 - x1); x = VIEW.dbMin + BUFFER; }
                if (codeOut === code1) { x1 = x; y1 = y; code1 = computeCode(x1, y1, VIEW); }
                else { x2 = x; y2 = y; code2 = computeCode(x2, y2, VIEW); }
            }
        };

        const App = () => {
            const [mode, setMode] = useState('MAU'); 
            const [airFlow, setAirFlow] = useState(35000); 
            const [oa, setOa] = useState({ db: 35, rh: 75 });
            const [ra, setRa] = useState({ db: 26, rh: 50 }); // 新增回風狀態
            const [room, setRoom] = useState({ db: 23, rh: 50 }); 
            const [mixRatio, setMixRatio] = useState(30); 
            const [waterConfig, setWaterConfig] = useState({
                CHW_L: { in: 7, out: 12.5 },
                CHW_M: { in: 15, out: 20.5 },
                HW: { in: 60, out: 50 }
            });
            const [hoveredPoint, setHoveredPoint] = useState(null);
            const [coils, setCoils] = useState([
                { id: 1, energy: 'CHW_M', label: '1st Pre-Cooling', db: 18, rh: 95, active: true },
                { id: 2, energy: 'CHW_L', label: 'Main Dehumidification', db: 11, rh: 98, active: true },
                { id: 3, energy: 'HW', label: 'Reheating Coil', db: 22, rh: 55, active: true }
            ]);

            const VIEW = { dbMin: -1, dbMax: 51, wMin: -0.001, wMax: 0.036 };

            const calcResults = useMemo(() => {
                const oaS = PsychroLib.calculateByDBRH(oa.db || 0, oa.rh || 0);
                const raS = PsychroLib.calculateByDBRH(ra.db || 0, ra.rh || 0);
                const roomS = PsychroLib.calculateByDBRH(room.db || 0, room.rh || 0);
                
                let startPoint;
                let maS = null;
                
                if (mode === 'MAU') {
                    startPoint = oaS;
                } else {
                    maS = PsychroLib.mix(oaS, raS, mixRatio);
                    startPoint = maS;
                }

                const stages = [{ 
                    label: mode === 'MAU' ? 'OA Entrance' : 'Mixed Air (MA)', 
                    state: startPoint, 
                    type: 'START' 
                }];

                const results = coils.map(coil => {
                    if (!coil.active) return null;
                    const start = stages[stages.length - 1].state;
                    const end = PsychroLib.calculateByDBRH(coil.db || 0, coil.rh || 0);
                    const massFlow = (airFlow || 0) / ((start.v || 0.8) * 3600); 
                    const load = massFlow * (end.h - start.h); 
                    const rt = Math.abs(load) / 3.51685;
                    const wc = waterConfig[coil.energy] || { in: 7, out: 12 };
                    const dt = Math.abs(wc.out - wc.in) || 5;
                    const lpm = (Math.abs(load) * 60) / (4.186 * dt);
                    const pipeSize = getPipeSize(lpm);
                    stages.push({ label: coil.label, state: end, energy: coil.energy });
                    return { ...coil, start, end, load, rt, lpm, pipeSize, dt };
                }).filter(Boolean);

                return { stages, results, oaState: oaS, raState: raS, maState: maS, roomState: roomS };
            }, [mode, oa, ra, room, mixRatio, coils, airFlow, waterConfig]);

            const svgW = 1000, svgH = 500; 
            const margin = { top: 30, right: 80, bottom: 40, left: 70 };
            const xScale = (db) => ((db - VIEW.dbMin) / (VIEW.dbMax - VIEW.dbMin)) * (svgW - margin.left - margin.right) + margin.left;
            const yScale = (w) => svgH - margin.bottom - ((w - VIEW.wMin) / (VIEW.wMax - VIEW.wMin)) * (svgH - margin.top - margin.bottom);

            const chartAssets = useMemo(() => {
                const step = 0.05; 
                let satPath = "";
                for (let t = VIEW.dbMin; t < VIEW.dbMax; t += step) {
                    const p1 = { db: t, w: PsychroLib.calculateByDBRH(t, 100).w };
                    const p2 = { db: t + step, w: PsychroLib.calculateByDBRH(t + step, 100).w };
                    const clipped = clipLineToView(p1, p2, VIEW);
                    if (clipped) satPath += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                }
                const rhLines = [10, 30, 50, 70, 90].map(rh => {
                    let path = "";
                    let lastPoint = null;
                    for (let t = VIEW.dbMin; t < VIEW.dbMax; t += step) {
                        const p1 = { db: t, w: PsychroLib.calculateByDBRH(t, rh).w };
                        const p2 = { db: t + step, w: PsychroLib.calculateByDBRH(t + step, rh).w };
                        const clipped = clipLineToView(p1, p2, VIEW);
                        if (clipped) {
                            path += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                            lastPoint = { x: xScale(clipped.x2), y: yScale(clipped.y2) };
                        }
                    }
                    return { path, rh, lastPoint };
                });
                return { satPath, rhLines };
            }, [VIEW]);

            const processPaths = useMemo(() => {
                const steps = 60; 
                return calcResults.stages.slice(1).map((s, i) => {
                    const prev = calcResults.stages[i].state;
                    const isHeating = s.energy === 'HW';
                    let pathD = "";
                    for (let j = 0; j < steps; j++) {
                        const r1 = j / steps, r2 = (j + 1) / steps;
                        let db1 = prev.db + (s.state.db - prev.db) * r1, db2 = prev.db + (s.state.db - prev.db) * r2;
                        let w1, w2;
                        if (!isHeating) {
                            const w1_sat = PsychroLib.calculateByDBRH(db1, 100).w, w2_sat = PsychroLib.calculateByDBRH(db2, 100).w;
                            w1 = Math.min(prev.w + (s.state.w - prev.w) * Math.pow(r1, 1.15), w1_sat);
                            w2 = Math.min(prev.w + (s.state.w - prev.w) * Math.pow(r2, 1.15), w2_sat);
                        } else {
                            w1 = prev.w + (s.state.w - prev.w) * r1;
                            w2 = prev.w + (s.state.w - prev.w) * r2;
                        }
                        const clipped = clipLineToView({ db: db1, w: w1 }, { db: db2, w: w2 }, VIEW);
                        if (clipped) pathD += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                    }
                    return { d: pathD, isHeating, prev, curr: s.state };
                });
            }, [calcResults, VIEW]);

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    <header className="px-8 py-5 bg-gradient-to-r from-slate-900 via-blue-900 to-slate-900 border-b border-blue-800 flex justify-between items-center shadow-2xl z-30 shrink-0">
                        <div className="flex items-center gap-5">
                            <div className="bg-white/10 p-2.5 rounded-2xl backdrop-blur-lg border border-white/20 shadow-inner">
                                <Icon name="Compass" className="w-8 h-8 text-blue-300" />
                            </div>
                            <div>
                                <h1 className="text-2xl font-black font-heading tracking-tight text-white italic leading-none">
                                    Psychro<span className="text-blue-400">Solver</span> <span className="text-blue-100 font-light ml-1 text-lg">PRO v7.1</span>
                                </h1>
                                <p className="text-[10px] text-blue-200/60 font-black uppercase tracking-[0.2em] mt-1.5 flex items-center gap-2">
                                    <span className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                                    High-Precision HVAC Engineering Audit Terminal
                                </p>
                            </div>
                        </div>
                        <div className="flex gap-2.5 bg-black/30 p-1.5 rounded-2xl border border-white/10">
                            {['MAU', 'AHU'].map(m => (
                                <button key={m} onClick={() => setMode(m)} className={`px-10 py-2.5 rounded-xl text-xs font-black transition-all ${mode === m ? 'bg-white text-blue-900 shadow-xl transform scale-105' : 'text-blue-100/50 hover:text-white'}`}>
                                    {m} MODE
                                </button>
                            ))}
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden bg-slate-50">
                        <aside className="w-[380px] border-r border-slate-200 bg-white overflow-y-auto p-5 space-y-7 custom-scrollbar shrink-0 shadow-lg z-20">
                            <section className="space-y-5">
                                <div className="flex items-center gap-2.5 font-black text-blue-900 uppercase text-[11px] tracking-widest border-b-2 border-slate-50 pb-3">
                                    <Icon name="Activity" className="w-4 h-4 text-blue-500" /> 系統原始數據
                                </div>
                                <div className="bg-gradient-to-br from-blue-50 to-indigo-50/30 p-6 rounded-[2rem] border border-blue-100 shadow-inner text-center">
                                    <label className="text-[10px] font-black text-slate-400 uppercase block mb-1 tracking-[0.1em]">設計風量 (CMH)</label>
                                    <div className="flex items-center justify-center gap-2">
                                        <input type="number" value={airFlow || ''} onChange={e => setAirFlow(Number(e.target.value))} className="bg-transparent text-4xl font-black text-blue-700 outline-none w-40 text-center font-heading" />
                                        <span className="text-slate-400 font-black text-sm">m³/h</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 gap-4">
                                    {/* OA 外氣 */}
                                    <div className="p-5 bg-white rounded-3xl border border-slate-100 shadow-sm space-y-4 card-hover">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-blue-600 w-1.5 h-6 rounded-full" />
                                            <p className="text-[12px] font-black text-slate-700 uppercase tracking-widest">OA 外氣規格</p>
                                        </div>
                                        <div className="flex justify-between items-center text-xs font-bold px-1">
                                            <span className="text-slate-400">乾球溫度 DB ℃</span>
                                            <input type="number" value={oa?.db || ''} onChange={e => setOa({...oa, db: Number(e.target.value)})} className="bg-slate-50 w-16 text-center py-2 rounded-xl border border-slate-200 font-black text-blue-600 outline-none focus:border-blue-400" />
                                        </div>
                                        <div className="flex justify-between items-center text-xs font-bold px-1">
                                            <span className="text-slate-400">相對濕度 RH %</span>
                                            <input type="number" value={oa?.rh || ''} onChange={e => setOa({...oa, rh: Number(e.target.value)})} className="bg-slate-50 w-16 text-center py-2 rounded-xl border border-slate-200 font-black text-blue-600 outline-none focus:border-blue-400" />
                                        </div>
                                    </div>

                                    {/* AHU 模式特有：RA 回風與混風比 */}
                                    {mode === 'AHU' && (
                                        <div className="p-5 bg-gradient-to-br from-emerald-50 to-teal-50/30 rounded-3xl border border-emerald-100 shadow-sm space-y-4 card-hover">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-emerald-500 w-1.5 h-6 rounded-full" />
                                                <p className="text-[12px] font-black text-emerald-800 uppercase tracking-widest">RA 回風與混風設定</p>
                                            </div>
                                            <div className="flex justify-between items-center text-xs font-bold px-1">
                                                <span className="text-emerald-600/60 font-black">回風溫度 DB ℃</span>
                                                <input type="number" value={ra?.db || ''} onChange={e => setRa({...ra, db: Number(e.target.value)})} className="bg-white w-16 text-center py-2 rounded-xl border border-emerald-100 font-black text-emerald-600 outline-none focus:border-emerald-400 shadow-sm" />
                                            </div>
                                            <div className="flex justify-between items-center text-xs font-bold px-1">
                                                <span className="text-emerald-600/60 font-black">回風濕度 RH %</span>
                                                <input type="number" value={ra?.rh || ''} onChange={e => setRa({...ra, rh: Number(e.target.value)})} className="bg-white w-16 text-center py-2 rounded-xl border border-emerald-100 font-black text-emerald-600 outline-none focus:border-emerald-400 shadow-sm" />
                                            </div>
                                            <div className="pt-2 border-t border-emerald-100">
                                                <div className="flex justify-between items-center text-xs font-bold px-1">
                                                    <span className="text-emerald-800 font-black">外氣比 OA %</span>
                                                    <div className="flex items-center gap-2">
                                                        <input type="number" value={mixRatio || ''} onChange={e => setMixRatio(Number(e.target.value))} className="bg-emerald-600 w-16 text-center py-2 rounded-xl font-black text-white outline-none shadow-md" />
                                                        <span className="text-emerald-600">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="p-5 bg-white rounded-3xl border border-blue-100 shadow-sm space-y-4 card-hover">
                                        <div className="flex items-center gap-3">
                                            <div className="bg-slate-900 w-1.5 h-6 rounded-full" />
                                            <p className="text-[12px] font-black text-slate-700 uppercase tracking-widest">房內控制目標</p>
                                        </div>
                                        <div className="flex justify-between items-center text-xs font-bold px-1">
                                            <span className="text-slate-400">目標 DB ℃</span>
                                            <input type="number" value={room?.db || ''} onChange={e => setRoom({...room, db: Number(e.target.value)})} className="bg-blue-50/30 w-16 text-center py-2 rounded-xl border border-blue-100 font-black text-blue-600 outline-none focus:border-blue-400" />
                                        </div>
                                        <div className="flex justify-between items-center text-xs font-bold px-1">
                                            <span className="text-slate-400">目標 RH %</span>
                                            <input type="number" value={room?.rh || ''} onChange={e => setRoom({...room, rh: Number(e.target.value)})} className="bg-blue-50/30 w-16 text-center py-2 rounded-xl border border-blue-100 font-black text-blue-600 outline-none focus:border-blue-400" />
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section className="space-y-4 pb-12">
                                <div className="flex justify-between items-center text-[11px] font-black text-slate-500 uppercase border-b border-slate-100 pb-3">
                                    <div className="flex items-center gap-2.5">
                                        <Icon name="Layers" className="w-4 h-4 text-blue-500" /> 盤管段出口定義
                                    </div>
                                    <button onClick={() => setCoils([...coils, { id: Date.now(), energy: 'CHW_L', label: 'New Coil Section', db: 20, rh: 50, active: true }])} className="p-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-white shadow-lg active:scale-95 transition-all">
                                        <Icon name="Plus" className="w-4 h-4"/>
                                    </button>
                                </div>
                                {coils.map((c, i) => (
                                    <div key={c.id} className="p-5 bg-white border border-slate-100 rounded-3xl relative overflow-hidden shadow-sm transition-all hover:border-blue-300 group">
                                        <div className={`absolute top-0 left-0 w-1.5 h-full ${c.energy === 'CHW_L' ? 'bg-blue-600' : c.energy === 'CHW_M' ? 'bg-sky-400' : 'bg-rose-500'}`} />
                                        <div className="flex justify-between items-center mb-4">
                                            <div className="flex items-center gap-3">
                                                <span className="w-6 h-6 flex items-center justify-center text-[10px] font-black text-white bg-slate-900 rounded-lg">{i+1}</span>
                                                <input type="text" value={c.label} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, label: e.target.value} : item))} className="bg-transparent text-[13px] font-black text-slate-800 outline-none w-44 focus:text-blue-600" />
                                            </div>
                                            <button onClick={() => setCoils(coils.filter(item => item.id !== c.id))} className="text-slate-200 hover:text-rose-500 transition-colors opacity-0 group-hover:opacity-100">
                                                <Icon name="XCircle" className="w-4 h-4"/>
                                            </button>
                                        </div>
                                        <div className="relative mb-3">
                                            <select value={c.energy} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, energy: e.target.value} : item))} className="w-full bg-slate-50 text-[11px] font-bold text-slate-600 p-2.5 rounded-xl border border-slate-100 outline-none focus:border-blue-300">
                                                <option value="CHW_L">低溫冰水 (CHW-L)</option>
                                                <option value="CHW_M">中溫冰水 (CHW-M)</option>
                                                <option value="HW">熱水系統 (HW)</option>
                                            </select>
                                            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-300"><Icon name="ChevronDown" className="w-3.5 h-3.5" /></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="bg-slate-50/50 p-2.5 rounded-2xl border border-slate-100">
                                                <label className="text-[9px] font-black text-slate-400 uppercase block mb-1">Outlet DB</label>
                                                <input type="number" value={c?.db ?? ''} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, db: Number(e.target.value)} : item))} className="bg-transparent w-full font-black text-blue-600 outline-none text-sm text-center" />
                                            </div>
                                            <div className="bg-slate-50/50 p-2.5 rounded-2xl border border-slate-100">
                                                <label className="text-[9px] font-black text-slate-400 uppercase block mb-1">Outlet RH%</label>
                                                <input type="number" value={c?.rh ?? ''} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, rh: Number(e.target.value)} : item))} className="bg-transparent w-full font-black text-blue-600 outline-none text-sm text-center" />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </section>
                        </aside>

                        <main className="flex-1 overflow-y-auto bg-slate-50 custom-scrollbar p-6">
                            {/* Psychrometric Chart */}
                            <div className="bg-white rounded-[3rem] border border-slate-200 relative shadow-2xl overflow-hidden flex flex-col m-2 h-[550px] shrink-0">
                                <div className="absolute top-8 left-10 z-10 flex items-center gap-4">
                                    <div className="bg-blue-600 text-white px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg">Live Psychro-Mapping</div>
                                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">LOGIC ENABLED</span>
                                </div>
                                
                                <svg width="100%" height="100%" viewBox={`0 0 ${svgW} ${svgH}`} preserveAspectRatio="xMidYMid meet" className="drop-shadow-sm">
                                    <g stroke="#f1f5f9" strokeWidth="1">
                                        {[0, 10, 20, 30, 40, 50].map(t => (
                                            <React.Fragment key={t}>
                                                <line x1={xScale(t)} y1={margin.top} x2={xScale(t)} y2={svgH-margin.bottom} vectorEffect="non-scaling-stroke" />
                                                <text x={xScale(t)} y={svgH-margin.bottom + 22} textAnchor="middle" className="text-[11px] fill-slate-400 font-black font-mono">{t}℃</text>
                                            </React.Fragment>
                                        ))}
                                        {[0, 0.005, 0.01, 0.015, 0.02, 0.025, 0.03, 0.035].map(w => (
                                            <React.Fragment key={w}>
                                                <line x1={margin.left} y1={yScale(w)} x2={svgW-margin.right} y2={yScale(w)} vectorEffect="non-scaling-stroke" />
                                                <text x={margin.left - 15} y={yScale(w) + 4} textAnchor="end" className="text-[11px] fill-slate-300 font-black">{(w*1000).toFixed(0)}</text>
                                            </React.Fragment>
                                        ))}
                                    </g>
                                    
                                    <path d={chartAssets.satPath} fill="none" stroke="#94a3b8" strokeWidth="2.5" strokeDasharray="6 3" opacity="0.3" />
                                    {chartAssets.rhLines.map((rh) => (
                                        <React.Fragment key={rh.rh}>
                                            <path d={rh.path} fill="none" stroke="#e2e8f0" strokeWidth="1" strokeDasharray="3 3" />
                                        </React.Fragment>
                                    ))}

                                    {/* AHU 模式：繪製 OA 到 RA 的混風連線 */}
                                    {mode === 'AHU' && (
                                        <g>
                                            <line x1={xScale(calcResults.oaState.db)} y1={yScale(calcResults.oaState.oaW ?? calcResults.oaState.w)} x2={xScale(calcResults.raState.db)} y2={yScale(calcResults.raState.w)} stroke="#cbd5e1" strokeWidth="2" strokeDasharray="8 4" />
                                            {/* 回風點 RA */}
                                            <circle cx={xScale(calcResults.raState.db)} cy={yScale(calcResults.raState.w)} r="8" fill="white" stroke="#10b981" strokeWidth="2" />
                                            <text x={xScale(calcResults.raState.db)} y={yScale(calcResults.raState.w) - 15} textAnchor="middle" className="text-[10px] font-black fill-emerald-600">RA</text>
                                            
                                            {/* 外氣點 OA */}
                                            <circle cx={xScale(calcResults.oaState.db)} cy={yScale(calcResults.oaState.w)} r="8" fill="white" stroke="#3b82f6" strokeWidth="2" />
                                            <text x={xScale(calcResults.oaState.db)} y={yScale(calcResults.oaState.w) - 15} textAnchor="middle" className="text-[10px] font-black fill-blue-600">OA</text>
                                        </g>
                                    )}

                                    {processPaths.map((p, i) => (
                                        <path key={i} d={p.d} stroke={p.isHeating ? "#f43f5e" : "#2563eb"} strokeWidth="6" fill="none" strokeLinecap="round" className="process-line" />
                                    ))}

                                    <g>
                                        <circle cx={xScale(calcResults.roomState.db)} cy={yScale(calcResults.roomState.w)} r="15" fill="none" stroke="#1e293b" strokeWidth="3" strokeDasharray="4 2" />
                                        <text x={xScale(calcResults.roomState.db) + 20} y={yScale(calcResults.roomState.w) + 5} className="text-[11px] font-black fill-slate-400 italic uppercase">Room Target</text>
                                    </g>

                                    {calcResults.stages.map((s, i) => (
                                        <g key={i} onMouseEnter={() => setHoveredPoint(s)} onMouseLeave={() => setHoveredPoint(null)} className="cursor-crosshair">
                                            <circle cx={xScale(s.state.db)} cy={yScale(s.state.w)} r="12" fill="white" stroke={i === 0 && mode === 'AHU' ? "#10b981" : "#1e293b"} strokeWidth="3" className="transition-all hover:r-15 shadow-xl" />
                                            <text x={xScale(s.state.db)} y={yScale(s.state.w)} dy="4" textAnchor="middle" className="text-[11px] font-black fill-slate-900 pointer-events-none">{i+1}</text>
                                            <text x={xScale(s.state.db)} y={yScale(s.state.w) + 32} textAnchor="middle" className="text-[10px] font-black fill-blue-700 bg-white/95 px-2 py-0.5 rounded-lg shadow-sm border border-blue-50">
                                                {s.state.db.toFixed(1)}℃ / {s.state.rh.toFixed(0)}%
                                            </text>
                                        </g>
                                    ))}
                                </svg>
                            </div>

                            <div className="bg-white border border-slate-200 rounded-[3rem] p-10 shadow-2xl m-2 shrink-0">
                                <div className="flex flex-col gap-8 mb-10">
                                    <div className="flex justify-between items-end">
                                        <div className="flex items-center gap-6">
                                            <div className="bg-blue-600 p-4 rounded-3xl shadow-xl text-white transform -rotate-2"><Icon name="FileText" className="w-8 h-8" /></div>
                                            <div>
                                                <h3 className="text-2xl font-black font-heading uppercase text-slate-900 tracking-tight">空調設計核算表</h3>
                                                <p className="text-xs text-slate-400 font-bold uppercase tracking-[0.2em] mt-2">{mode === 'AHU' ? `AHU MIXING AUDIT (OA ${mixRatio}% / RA ${100-mixRatio}%)` : 'MAU DIRECT AUDIT (100% OA)'}</p>
                                            </div>
                                        </div>
                                        <div className="flex gap-4">
                                            <button className="bg-slate-900 hover:bg-black px-10 py-5 rounded-3xl text-xs font-black text-white uppercase flex items-center gap-3 shadow-2xl transition-all active:scale-95">
                                                <Icon name="ExternalLink" className="w-5 h-5"/> 輸出技術報告
                                            </button>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-3 gap-8 bg-slate-50/50 p-8 rounded-[2.5rem] border border-slate-100">
                                        {['CHW_L', 'CHW_M', 'HW'].map(k => (
                                            <div key={k} className="space-y-4">
                                                <div className="text-[11px] font-black uppercase tracking-[0.2em] border-b border-slate-200 pb-3 flex items-center gap-3 text-slate-500">
                                                    {k === 'HW' ? <Icon name="Flame" className="w-4 h-4 text-rose-500" /> : <Icon name="Droplets" className="w-4 h-4 text-blue-500" />}
                                                    {k === 'CHW_L' ? '低溫冰水' : k === 'CHW_M' ? '中溫冰水' : '熱水系統'}
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div className="flex flex-col">
                                                        <span className="text-[9px] font-black text-slate-400 uppercase mb-1.5 ml-1">進水 ℃</span>
                                                        <input type="number" value={waterConfig[k]?.in ?? ''} onChange={e => setWaterConfig({...waterConfig, [k]: {...waterConfig[k], in: Number(e.target.value)}})} className="bg-white border border-slate-200 p-3 rounded-2xl font-black text-blue-700 text-center shadow-sm outline-none font-mono" />
                                                    </div>
                                                    <div className="flex flex-col">
                                                        <span className="text-[9px] font-black text-slate-400 uppercase mb-1.5 ml-1">出水 ℃</span>
                                                        <input type="number" value={waterConfig[k]?.out ?? ''} onChange={e => setWaterConfig({...waterConfig, [k]: {...waterConfig[k], out: Number(e.target.value)}})} className="bg-white border border-slate-200 p-3 rounded-2xl font-black text-blue-700 text-center shadow-sm outline-none font-mono" />
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="w-full border border-slate-100 rounded-[3rem] overflow-hidden shadow-inner bg-white">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-900 text-white uppercase tracking-[0.15em] text-[10px] font-black font-heading">
                                                <th className="p-7 px-10">Energy System / Coil Components</th>
                                                <th className="p-7 text-center border-l border-white/5 bg-slate-800">負荷 (kW)</th>
                                                <th className="p-7 text-center border-l border-white/5 bg-slate-800">負荷 (RT)</th>
                                                <th className="p-7 text-center border-l border-white/5 bg-slate-800">水量 (LPM)</th>
                                                <th className="p-7 text-center border-l border-white/5 bg-blue-700 text-blue-50 shadow-xl">建議管徑 (A)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {['CHW_L', 'CHW_M', 'HW'].map(type => {
                                                const group = calcResults.results.filter(r => r.energy === type);
                                                if (group.length === 0) return null;
                                                const typeLabel = type === 'CHW_L' ? 'Low-Temp CHW' : type === 'CHW_M' ? 'Med-Temp CHW' : 'Hot Water';
                                                const dotColor = type === 'CHW_L' ? 'bg-blue-600' : type === 'CHW_M' ? 'bg-sky-400' : 'bg-rose-500';
                                                return (
                                                    <React.Fragment key={type}>
                                                        <tr className="bg-slate-50/80">
                                                            <td colSpan="5" className="p-4 px-10 text-[11px] font-black text-slate-400 uppercase border-y border-slate-100 tracking-[0.2em] font-heading">
                                                                {typeLabel} Section (ΔT = {(group[0]?.dt || 5).toFixed(1)}℃)
                                                            </td>
                                                        </tr>
                                                        {group.map((res) => (
                                                            <tr key={res.id} className="border-b border-slate-50 hover:bg-blue-50/30 transition-all group">
                                                                <td className="p-7 px-10 font-black flex items-center gap-6 italic group-hover:text-blue-700 transition-all">
                                                                    <div className={`w-3.5 h-3.5 rounded-full ${dotColor} shadow-lg ring-4 ring-slate-100`} />
                                                                    <span className="text-lg tracking-tight uppercase">{res.label}</span>
                                                                </td>
                                                                <td className="p-7 text-slate-900 text-3xl font-black text-center border-l border-slate-50 font-heading tracking-tighter">
                                                                    {Math.abs(res.load || 0).toFixed(2)}
                                                                </td>
                                                                <td className="p-7 text-slate-900 text-3xl font-black text-center border-l border-slate-50 font-heading tracking-tighter">
                                                                    {(Math.abs(res.load || 0)/3.51685).toFixed(2)}
                                                                </td>
                                                                <td className="p-7 text-slate-900 text-3xl font-black text-center border-l border-slate-50 font-heading tracking-tighter">
                                                                    {(res.lpm || 0).toFixed(2)}
                                                                </td>
                                                                <td className="p-7 text-emerald-600 text-4xl font-black text-center border-l border-slate-50 bg-emerald-50/10 font-heading italic">
                                                                    {res.pipeSize}
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </React.Fragment>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div className="h-20 shrink-0" />
                        </main>
                    </div>

                    {hoveredPoint && (
                        <div className="fixed pointer-events-none z-50 transition-all" style={{ left: xScale(hoveredPoint.state.db) + 400 + 'px', top: yScale(hoveredPoint.state.w) + 120 + 'px' }}>
                            <div className="bg-slate-900/95 border border-blue-400 text-white p-6 rounded-[2rem] shadow-2xl w-[240px] backdrop-blur-xl">
                                <h4 className="text-[14px] font-black uppercase tracking-widest text-blue-400 italic mb-3 border-b border-white/10 pb-3">{hoveredPoint.label}</h4>
                                <div className="space-y-3 text-[11px] font-mono">
                                    <div className="flex justify-between items-center"><span className="text-slate-500 font-sans font-bold">DB / WB</span><span>{hoveredPoint.state.db.toFixed(1)} / {hoveredPoint.state.wb.toFixed(1)}℃</span></div>
                                    <div className="flex justify-between items-center"><span className="text-slate-500 font-sans font-bold">RH / DP</span><span>{hoveredPoint.state.rh.toFixed(0)}% / {hoveredPoint.state.dp.toFixed(1)}℃</span></div>
                                    <div className="flex justify-between items-center border-t border-white/5 pt-3"><span className="text-slate-500 font-sans font-bold">ENTHALPY</span><span className="text-emerald-400">{hoveredPoint.state.h.toFixed(2)} kJ/kg</span></div>
                                    <div className="flex justify-between items-center"><span className="text-slate-500 font-sans font-bold">HUMIDITY</span><span className="text-blue-400">{(hoveredPoint.state.w * 1000).toFixed(2)} g/kg</span></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
