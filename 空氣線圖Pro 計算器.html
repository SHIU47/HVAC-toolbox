<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsychroSolver Pro-V8.2 - 最終工程核算版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Montserrat:ital,wght@0,700;0,800;0,900;1,800&family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');
        
        :root {
            --font-main: 'Inter', 'Noto Sans TC', system-ui, sans-serif;
            --font-heading: 'Montserrat', 'Noto Sans TC', sans-serif;
            --font-mono: 'JetBrains+Mono', monospace;
        }

        body { 
            font-family: var(--font-main); 
            background-color: #f1f5f9; 
            margin: 0; 
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
        }
        
        .font-heading { font-family: var(--font-heading); letter-spacing: -0.02em; }
        .font-data { font-family: 'JetBrains+Mono', monospace; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }

        .custom-scrollbar::-webkit-scrollbar { width: 3px; height: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-1px); box-shadow: 0 4px 12px -5px rgba(0, 0, 0, 0.1); }
        
        select { appearance: none; }
        
        .process-line {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: dash 1.5s ease-out forwards;
        }

        @keyframes dash { to { stroke-dashoffset: 0; } }

        .dragging {
            opacity: 0.4;
            transform: scale(0.98);
            border: 2px dashed #4f46e5 !important;
        }

        /* Responsive UI Adjustments */
        .app-grid {
            display: grid;
            grid-template-columns: 1fr;
            height: calc(100vh - 56px);
        }
        @media (min-width: 1024px) {
            .app-grid {
                grid-template-columns: 320px 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const Icon = ({ name, className = "w-3.5 h-3.5" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const PsychroLib = {
            P: 101.325,
            getPsat: (T_db) => {
                const T = (T_db || 0) + 273.15;
                const C = T_db >= 0 
                    ? [-5.8002206e3, 1.3914993, -4.8640239e-2, 4.1764768e-5, -1.4452093e-8, 6.5459673]
                    : [-5.6745359e3, 6.3925247, -9.677843e-3, 6.2215701e-7, 2.0747825e-9, -9.484024e-13, 4.1635019];
                const lnP = T_db >= 0 
                    ? C[0]/T + C[1] + C[2]*T + C[3]*T*T + C[4]*T*T*T + C[5]*Math.log(T)
                    : C[0]/T + C[1] + C[2]*T + C[3]*T*T + C[4]*T*T*T + C[5]*T*T*T*T + C[6]*Math.log(T);
                return Math.exp(lnP) / 1000;
            },
            calculateByDBRH: (db, rh) => {
                const psat = PsychroLib.getPsat(db);
                const pw = (Math.max(0.001, Math.min(100, rh || 0)) / 100) * psat;
                const w = 0.621945 * pw / (PsychroLib.P - pw);
                const h = 1.006 * db + w * (2501 + 1.86 * db);
                const v = 0.287042 * (db + 273.15) * (1 + 1.6078 * w) / PsychroLib.P;
                const alpha = Math.log(pw);
                const dp = 6.54 + 14.526 * alpha + 0.7389 * Math.pow(alpha, 2) + 0.09486 * Math.pow(alpha, 3) + 0.4569 * Math.pow(pw, 0.1984);
                let wb = db;
                for(let i=0; i<15; i++) {
                    const pswb = PsychroLib.getPsat(wb);
                    const w_star = 0.621945 * pswb / (PsychroLib.P - pswb);
                    const f = (1.006 * wb + w_star * (2501 + 1.86 * wb)) - h;
                    wb = wb - f / (1.5 + 2.5 * w_star); 
                    if (Math.abs(f) < 0.0001) break;
                }
                return { db, rh, w, h, v, dp, wb, pw };
            },
            calculateByDBW: (db, w) => {
                const psat = PsychroLib.getPsat(db);
                const w_sat = 0.621945 * psat / (PsychroLib.P - psat);
                const w_final = Math.max(0, Math.min(w || 0, w_sat)); 
                const pw = (w_final * PsychroLib.P) / (0.621945 + w_final);
                let rh = (pw / psat) * 100;
                return PsychroLib.calculateByDBRH(db, rh);
            },
            mix: (oa, ra, oa_ratio_percent) => {
                const ratio = (oa_ratio_percent || 0) / 100;
                const hMix = (oa?.h || 0) * ratio + (ra?.h || 0) * (1 - ratio);
                const wMix = (oa?.w || 0) * ratio + (ra?.w || 0) * (1 - ratio);
                const dbMix = (hMix - 2501 * wMix) / (1.006 + 1.86 * wMix);
                return PsychroLib.calculateByDBW(dbMix, wMix);
            }
        };

        const getPipeSize = (lpm) => {
            if (!lpm || lpm <= 0) return "---";
            const val = Math.abs(lpm);
            if (val <= 19.5) return "20A";
            if (val <= 31.0) return "25A";
            if (val <= 90.0) return "32A";
            if (val <= 140.0) return "40A";
            if (val <= 219.0) return "50A";
            if (val <= 370.0) return "65A";
            if (val <= 560.0) return "80A";
            if (val <= 1020.0) return "100A";
            if (val <= 1594.0) return "125A";
            if (val <= 2295.0) return "150A";
            if (val <= 4080.0) return "200A";
            if (val <= 6375.0) return "250A";
            if (val <= 9180.0) return "300A";
            if (val <= 16064.0) return "350A";
            return "400A+";
        };

        const INSIDE = 0, LEFT = 1, RIGHT = 2, BOTTOM = 4, TOP = 8;
        const computeCode = (db, w, VIEW) => {
            let code = INSIDE;
            if (db < VIEW.dbMin) code |= LEFT;
            else if (db > VIEW.dbMax) code |= RIGHT;
            if (w < VIEW.wMin) code |= BOTTOM;
            else if (w > VIEW.wMax) code |= TOP;
            return code;
        };

        const clipLineToView = (p1, p2, VIEW) => {
            const BUFFER = 0.0001; 
            let x1 = p1.db, y1 = p1.w, x2 = p2.db, y2 = p2.w;
            let code1 = computeCode(x1, y1, VIEW), code2 = computeCode(x2, y2, VIEW);
            while (true) {
                if (!(code1 | code2)) return { x1, y1, x2, y2 };
                if (code1 & code2) return null;
                let codeOut = code1 ? code1 : code2;
                let x, y;
                if (codeOut & TOP) { x = x1 + (x2 - x1) * (VIEW.wMax - BUFFER - y1) / (y2 - y1); y = VIEW.wMax - BUFFER; }
                else if (codeOut & BOTTOM) { x = x1 + (x2 - x1) * (VIEW.wMin + BUFFER - y1) / (y2 - y1); y = VIEW.wMin + BUFFER; }
                else if (codeOut & RIGHT) { y = y1 + (y2 - y1) * (VIEW.dbMax - BUFFER - x1) / (x2 - x1); x = VIEW.dbMax - BUFFER; }
                else if (codeOut & LEFT) { y = y1 + (y2 - y1) * (VIEW.dbMin + BUFFER - x1) / (x2 - x1); x = VIEW.dbMin + BUFFER; }
                if (codeOut === code1) { x1 = x; y1 = y; code1 = computeCode(x1, y1, VIEW); }
                else { x2 = x; y2 = y; code2 = computeCode(x2, y2, VIEW); }
            }
        };

        const App = () => {
            const [mode, setMode] = useState('MAU'); 
            const [airFlow, setAirFlow] = useState(35000); 
            const [oa, setOa] = useState({ db: 35, rh: 75 });
            const [ra, setRa] = useState({ db: 26, rh: 50 }); 
            const [room, setRoom] = useState({ db: 23, rh: 50 }); 
            const [roomTol, setRoomTol] = useState({ db: 1, rh: 5 }); 
            const [mixRatio, setMixRatio] = useState(30); 
            const [waterConfig, setWaterConfig] = useState({
                CHW_L: { in: 7, out: 12.5 },
                CHW_M: { in: 15, out: 20.5 },
                HW: { in: 60, out: 50 },
                WW: { in: 25, out: 25 }
            });
            const [hoveredPoint, setHoveredPoint] = useState(null);
            const [draggingIndex, setDraggingIndex] = useState(null);
            
            const [coils, setCoils] = useState([
                { id: 1, energy: 'HW', label: '1.預熱 (Pre-Heat)', db: 36, rh: 70, active: true },
                { id: 2, energy: 'CHW_M', label: '2.預冷 (Pre-Cool)', db: 22, rh: 95, active: true },
                { id: 3, energy: 'WW', label: '3.水洗 (Water Wash)', db: 18, rh: 98, active: true },
                { id: 4, energy: 'CHW_L', label: '4.除濕 (Dehumidifier)', db: 11, rh: 98, active: true },
                { id: 5, energy: 'HW', label: '5.再熱 (Re-Heat)', db: 22, rh: 45, active: true }
            ]);

            const VIEW = { dbMin: -1, dbMax: 51, wMin: -0.001, wMax: 0.036 };

            const handleDragStart = (index) => setDraggingIndex(index);
            const handleDragOver = (e) => e.preventDefault();
            const handleDrop = (index) => {
                if (draggingIndex === null || draggingIndex === index) return;
                const newCoils = [...coils];
                const draggedItem = newCoils[draggingIndex];
                newCoils.splice(draggingIndex, 1);
                newCoils.splice(index, 0, draggedItem);
                setCoils(newCoils);
                setDraggingIndex(null);
            };

            const handleAddCoil = () => {
                setCoils([...coils, { id: Date.now(), energy: 'HW', label: `${coils.length + 1}.新階段`, db: 25, rh: 50, active: true }]);
            };

            const handleDeleteCoil = (id) => setCoils(coils.filter(c => c.id !== id));

            const calcResults = useMemo(() => {
                const oaS = PsychroLib.calculateByDBRH(oa.db || 0, oa.rh || 0);
                const raS = PsychroLib.calculateByDBRH(ra.db || 0, ra.rh || 0);
                const roomS = PsychroLib.calculateByDBRH(room.db || 0, room.rh || 0);
                let startPoint = mode === 'MAU' ? oaS : PsychroLib.mix(oaS, raS, mixRatio);
                const stages = [{ label: mode === 'MAU' ? 'OA入口' : 'MA混風', state: startPoint, type: 'START' }];
                
                let totalWaterRate = 0; 

                const results = coils.map(coil => {
                    if (!coil.active) return null;
                    const start = stages[stages.length - 1].state;
                    const end = PsychroLib.calculateByDBRH(coil.db || 0, coil.rh || 0);
                    
                    const massFlow = (airFlow || 0) / ((start.v || 0.8) * 3600); 
                    const load = massFlow * (end.h - start.h); 
                    const rt = Math.abs(load) / 3.51685;
                    const wc = waterConfig[coil.energy] || { in: 7, out: 12 };
                    const dt = Math.abs(wc.out - wc.in) || 1;
                    const lpm = (Math.abs(load) * 60) / (4.186 * dt);
                    const pipeSize = getPipeSize(lpm);
                    
                    if (start.w > end.w) {
                        const waterAmount = (airFlow / start.v) * (start.w - end.w);
                        totalWaterRate += waterAmount;
                    }

                    stages.push({ label: coil.label, state: end, energy: coil.energy });
                    return { ...coil, start, end, load, rt, lpm, pipeSize, dt };
                }).filter(Boolean);
                
                return { stages, results, oaState: oaS, raState: raS, roomState: roomS, totalWaterRate };
            }, [mode, oa, ra, room, mixRatio, coils, airFlow, waterConfig]);

            const handleExportExcel = () => {
                const wb = XLSX.utils.book_new();
                const systemSummary = [
                    ["PsychroSolver Pro V8.2 工程核算報告", ""],
                    ["目標設定", `${room.db}±${roomTol.db}℃ / ${room.rh}±${roomTol.rh}%`],
                    ["運作風量 (CMH)", airFlow], 
                    ["目前模式", mode], 
                    ["系統除濕總水量 (L/h)", calcResults.totalWaterRate.toFixed(2)],
                    ["報告時間", new Date().toLocaleString()]
                ];
                const coilHeader = [["盤管組件", "能源", "負荷(kW)", "負荷(RT)", "流量(LPM)", "管徑(A)"]];
                const coilData = calcResults.results.map(r => [r.label, r.energy, Math.abs(r.load).toFixed(2), r.rt.toFixed(2), r.lpm.toFixed(2), r.pipeSize]);
                const finalWS = XLSX.utils.aoa_to_sheet([...systemSummary, [""], ...coilHeader, ...coilData]);
                XLSX.utils.book_append_sheet(wb, finalWS, "AuditReport");
                XLSX.writeFile(wb, `PsychroSolver_V8_2_Export.xlsx`);
            };

            const svgW = 1000, svgH = 450; 
            const margin = { top: 20, right: 60, bottom: 40, left: 60 };
            const xScale = (db) => ((db - VIEW.dbMin) / (VIEW.dbMax - VIEW.dbMin)) * (svgW - margin.left - margin.right) + margin.left;
            const yScale = (w) => svgH - margin.bottom - ((w - VIEW.wMin) / (VIEW.wMax - VIEW.wMin)) * (svgH - margin.top - margin.bottom);

            const chartAssets = useMemo(() => {
                const step = 0.5; 
                let satPath = "";
                for (let t = VIEW.dbMin; t < VIEW.dbMax; t += step) {
                    const p1 = { db: t, w: PsychroLib.calculateByDBRH(t, 100).w };
                    const p2 = { db: t + step, w: PsychroLib.calculateByDBRH(t + step, 100).w };
                    const clipped = clipLineToView(p1, p2, VIEW);
                    if (clipped) satPath += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                }
                const rhLines = [10, 30, 50, 70, 90].map(rh => {
                    let path = "";
                    for (let t = VIEW.dbMin; t < VIEW.dbMax; t += step) {
                        const p1 = { db: t, w: PsychroLib.calculateByDBRH(t, rh).w };
                        const p2 = { db: t + step, w: PsychroLib.calculateByDBRH(t + step, rh).w };
                        const clipped = clipLineToView(p1, p2, VIEW);
                        if (clipped) path += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                    }
                    return { path, rh };
                });
                let zonePath = "";
                const dbMin = room.db - roomTol.db, dbMax = room.db + roomTol.db, rhMin = Math.max(1, room.rh - roomTol.rh), rhMax = Math.min(99, room.rh + roomTol.rh);
                const points = [];
                for(let t=dbMin; t<=dbMax; t+=0.5) points.push({db: t, w: Math.min(PsychroLib.calculateByDBRH(t, rhMin).w, PsychroLib.calculateByDBRH(t, 100).w)});
                for(let t=dbMax; t>=dbMin; t-=0.5) points.push({db: t, w: Math.min(PsychroLib.calculateByDBRH(t, rhMax).w, PsychroLib.calculateByDBRH(t, 100).w)});
                if (points.length > 0) {
                    zonePath = `M ${xScale(points[0].db)} ${yScale(points[0].w)} `;
                    points.slice(1).forEach(p => { zonePath += `L ${xScale(p.db)} ${yScale(p.w)} `; });
                    zonePath += "Z";
                }
                return { satPath, rhLines, zonePath };
            }, [VIEW, room, roomTol]);

            const processPaths = useMemo(() => {
                const steps = 60; 
                return calcResults.stages.slice(1).map((s, i) => {
                    const prev = calcResults.stages[i].state;
                    const isHeating = s.energy === 'HW', isWW = s.energy === 'WW';
                    let pathD = "";
                    for (let j = 0; j < steps; j++) {
                        const r1 = j / steps, r2 = (j + 1) / steps;
                        let db1 = prev.db + (s.state.db - prev.db) * r1, db2 = prev.db + (s.state.db - prev.db) * r2;
                        let w1, w2;
                        if (isHeating) { w1 = prev.w + (s.state.w - prev.w) * r1; w2 = prev.w + (s.state.w - prev.w) * r2; }
                        else { w1 = prev.w + (s.state.w - prev.w) * Math.pow(r1, isWW ? 1.0 : 1.1); w2 = prev.w + (s.state.w - prev.w) * Math.pow(r2, isWW ? 1.0 : 1.1); }
                        w1 = Math.min(w1, PsychroLib.calculateByDBRH(db1, 100).w); w2 = Math.min(w2, PsychroLib.calculateByDBRH(db2, 100).w);
                        const clipped = clipLineToView({ db: db1, w: w1 }, { db: db2, w: w2 }, VIEW);
                        if (clipped) pathD += `M ${xScale(clipped.x1)} ${yScale(clipped.y1)} L ${xScale(clipped.x2)} ${yScale(clipped.y2)} `;
                    }
                    return { d: pathD, color: isHeating ? "#f43f5e" : isWW ? "#14b8a6" : "#2563eb" };
                });
            }, [calcResults, VIEW]);

            return (
                <div className="flex flex-col h-screen overflow-hidden text-xs bg-[#f8fafc]">
                    <header className="px-4 py-3 bg-gradient-to-r from-slate-800 to-slate-900 flex justify-between items-center z-40 shrink-0 shadow-md">
                        <div className="flex items-center gap-2 md:gap-3">
                            <div className="bg-indigo-600 p-1.5 rounded-lg text-white shadow-[0_0_15px_rgba(79,70,229,0.4)] shrink-0"><Icon name="Target" /></div>
                            <h1 className="text-sm md:text-base font-black font-heading text-white uppercase italic tracking-tighter truncate">PsychroSolver V8.2 <span className="hidden sm:inline font-light text-[10px] opacity-40 ml-2 uppercase tracking-widest">Final Audit Pro</span></h1>
                        </div>
                        <div className="flex gap-1 bg-white/5 p-1 rounded-xl border border-white/10 backdrop-blur-sm shrink-0">
                            {['MAU', 'AHU'].map(m => (
                                <button key={m} onClick={() => setMode(m)} className={`px-3 md:px-6 py-1 md:py-1.5 rounded-lg text-[10px] font-black transition-all ${mode === m ? 'bg-white text-indigo-900 shadow-md transform scale-105' : 'text-white/40 hover:text-white'}`}>{m} 模式</button>
                            ))}
                        </div>
                    </header>

                    <div className="app-grid overflow-hidden">
                        {/* 左側欄 */}
                        <aside className="border-r border-slate-200 bg-white overflow-y-auto p-4 space-y-5 custom-scrollbar z-30 shadow-sm">
                            <div className="bg-gradient-to-br from-indigo-800 to-indigo-950 p-4 md:p-5 rounded-2xl md:rounded-3xl text-center shadow-lg border border-indigo-400/20">
                                <label className="text-[10px] font-black text-indigo-300/60 uppercase block mb-1">System Air Flow (CMH)</label>
                                <input type="number" value={airFlow} onChange={e => setAirFlow(Number(e.target.value))} className="bg-transparent text-2xl md:text-3xl font-black text-white outline-none w-full text-center font-heading" />
                            </div>

                            <div className="space-y-3">
                                <div className="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm space-y-3 border-l-4 border-l-blue-500 card-hover">
                                    <p className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2">OA 外氣條件</p>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="bg-slate-50 p-2 rounded-xl text-center shadow-inner"><span className="text-[9px] text-slate-400 block font-bold uppercase">DB ℃</span><input type="number" value={oa.db} onChange={e => setOa({...oa, db: Number(e.target.value)})} className="bg-transparent w-full text-center font-bold text-blue-600 outline-none text-xs font-data" /></div>
                                        <div className="bg-slate-50 p-2 rounded-xl text-center shadow-inner"><span className="text-[9px] text-slate-400 block font-bold uppercase">RH %</span><input type="number" value={oa.rh} onChange={e => setOa({...oa, rh: Number(e.target.value)})} className="bg-transparent w-full text-center font-bold text-blue-600 outline-none text-xs font-data" /></div>
                                    </div>
                                </div>

                                {mode === 'AHU' && (
                                    <div className="p-4 bg-white rounded-2xl border border-emerald-100 shadow-sm space-y-3 border-l-4 border-l-emerald-500 card-hover bg-emerald-50/20">
                                        <p className="text-xs font-black text-emerald-800 uppercase tracking-widest flex items-center gap-2">RA 回風 & 混風比</p>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="bg-white p-2 rounded-xl border border-emerald-100 text-center shadow-sm"><span className="text-[9px] text-emerald-400 block font-bold uppercase">RA DB ℃</span><input type="number" value={ra.db} onChange={e => setRa({...ra, db: Number(e.target.value)})} className="bg-transparent w-full text-center font-bold text-emerald-600 outline-none text-xs font-data" /></div>
                                            <div className="bg-white p-2 rounded-xl border border-emerald-100 text-center shadow-sm"><span className="text-[9px] text-emerald-400 block font-bold uppercase">RA RH %</span><input type="number" value={ra.rh} onChange={e => setRa({...ra, rh: Number(e.target.value)})} className="bg-transparent w-full text-center font-bold text-emerald-600 outline-none text-xs font-data" /></div>
                                        </div>
                                        <div className="flex justify-between items-center px-2 bg-emerald-600 text-white p-2 rounded-xl shadow-lg mt-1">
                                            <span className="text-[10px] font-black uppercase tracking-widest">外氣比 OA %</span>
                                            <input type="number" value={mixRatio} onChange={e => setMixRatio(Number(e.target.value))} className="bg-emerald-800 w-10 text-center py-1 rounded-lg outline-none text-[12px] font-data font-black" />
                                        </div>
                                    </div>
                                )}

                                <div className="p-4 bg-slate-800 text-white rounded-2xl border border-slate-700 space-y-4 shadow-xl card-hover">
                                    <p className="text-xs font-black text-indigo-300 uppercase tracking-widest flex items-center gap-2"><div className="w-1 h-3 bg-indigo-500 rounded-full animate-pulse"/>目標範圍設計</p>
                                    <div className="space-y-3">
                                        <div className="flex items-center gap-2">
                                            <div className="flex-1 bg-white/5 p-2 rounded-xl text-center border border-white/5 shadow-inner"><span className="text-[9px] text-slate-400 block uppercase">Base DB</span><input type="number" value={room.db} onChange={e => setRoom({...room, db: Number(e.target.value)})} className="bg-transparent w-full text-center font-bold text-white outline-none text-xs font-data" /></div>
                                            <span className="text-indigo-500 font-black">±</span>
                                            <input type="number" step="0.1" value={roomTol.db} onChange={e => setRoomTol({...roomTol, db: Number(e.target.value)})} className="w-12 bg-indigo-900/40 p-2 rounded-xl text-center font-black text-indigo-100 outline-none text-xs font-data border border-indigo-500/30" />
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div className="flex-1 bg-white/5 p-2 rounded-xl text-center border border-white/5 shadow-inner"><span className="text-[9px] text-slate-400 block uppercase">Base RH</span><input type="number" value={room.rh} onChange={e => setRoom({...room, rh: Number(e.target.value)})} className="bg-transparent w-full text-center font-bold text-white outline-none text-xs font-data" /></div>
                                            <span className="text-indigo-500 font-black">±</span>
                                            <input type="number" value={roomTol.rh} onChange={e => setRoomTol({...roomTol, rh: Number(e.target.value)})} className="w-12 bg-indigo-900/40 p-2 rounded-xl text-center font-black text-indigo-100 outline-none text-xs font-data border border-indigo-500/30" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <section className="space-y-2 pb-10">
                                <div className="flex justify-between items-center text-xs font-black text-slate-400 uppercase border-b border-slate-100 pb-2">
                                    <span>盤管處理序列</span>
                                    <button onClick={handleAddCoil} className="p-1 bg-indigo-600 text-white rounded active:scale-95 transition-all shadow-md"><Icon name="Plus" /></button>
                                </div>
                                {coils.map((c, i) => (
                                    <div key={c.id} draggable="true" onDragStart={() => handleDragStart(i)} onDragOver={(e) => handleDragOver(e)} onDrop={() => handleDrop(i)}
                                        className={`p-3 bg-white border border-slate-100 rounded-2xl relative overflow-hidden shadow-sm cursor-move card-hover group ${draggingIndex === i ? 'dragging' : ''}`}>
                                        <div className={`absolute top-0 left-0 w-1 h-full ${c.energy === 'CHW_L' ? 'bg-blue-600' : c.energy === 'CHW_M' ? 'bg-sky-400' : c.energy === 'WW' ? 'bg-teal-500' : 'bg-rose-500'}`} />
                                        <div className="flex justify-between items-center mb-2 px-1">
                                            <div className="flex items-center gap-2">
                                                <div className="text-slate-300 group-hover:text-indigo-400"><Icon name="GripVertical" className="w-4 h-4 shrink-0" /></div>
                                                <input type="text" value={c.label} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, label: e.target.value} : item))} className="bg-transparent text-xs font-black text-slate-700 outline-none w-28 focus:text-indigo-600 truncate" />
                                            </div>
                                            <button onClick={() => handleDeleteCoil(c.id)} className="text-slate-200 hover:text-rose-500"><Icon name="Trash2" className="w-3.5 h-3.5" /></button>
                                        </div>
                                        <select value={c.energy} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, energy: e.target.value} : item))} className="w-full bg-slate-50 text-[11px] font-bold text-slate-500 p-1.5 rounded-lg border border-slate-100 mb-2 cursor-pointer shadow-inner">
                                            <option value="HW">熱水系統 (HW)</option>
                                            <option value="CHW_M">中溫冰水 (CHW-M)</option>
                                            <option value="CHW_L">低溫冰水 (CHW-L)</option>
                                            <option value="WW">水洗段 (Wash)</option>
                                        </select>
                                        <div className="grid grid-cols-2 gap-2 mt-1">
                                            <div className="bg-slate-50/50 p-2 rounded-xl border border-slate-100 text-center"><label className="text-[9px] font-black text-slate-400 block uppercase mb-1">Outlet DB</label><input type="number" step="0.1" value={c.db} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, db: Number(e.target.value)} : item))} className="bg-transparent w-full font-black text-blue-600 text-center outline-none text-[11px] font-data" /></div>
                                            <div className="bg-slate-50/50 p-2 rounded-xl border border-slate-100 text-center"><label className="text-[9px] font-black text-slate-400 block uppercase mb-1">Outlet RH</label><input type="number" value={c.rh} onChange={e => setCoils(coils.map(item => item.id === c.id ? {...item, rh: Number(e.target.value)} : item))} className="bg-transparent w-full font-black text-blue-600 text-center outline-none text-[11px] font-data" /></div>
                                        </div>
                                    </div>
                                ))}
                            </section>
                        </aside>

                        {/* 主內容區域 */}
                        <main className="flex-1 overflow-y-auto bg-[#f1f5f9] custom-scrollbar p-3 md:p-6 space-y-6">
                            {/* 濕度圖表 */}
                            <div className="bg-white rounded-3xl md:rounded-[2.5rem] border border-slate-200 relative shadow-xl overflow-hidden flex flex-col w-full">
                                <svg width="100%" className="h-auto" viewBox={`0 0 ${svgW} ${svgH}`} preserveAspectRatio="xMidYMid meet">
                                    <g stroke="#f8fafc" strokeWidth="1">
                                        {[0, 10, 20, 30, 40, 50].map(t => (
                                            <React.Fragment key={t}>
                                                <line x1={xScale(t)} y1={margin.top} x2={xScale(t)} y2={svgH-margin.bottom} />
                                                <text x={xScale(t)} y={svgH-margin.bottom + 20} textAnchor="middle" className="text-[11px] fill-slate-300 font-bold font-mono tracking-tighter">{t}℃</text>
                                            </React.Fragment>
                                        ))}
                                    </g>
                                    <path d={chartAssets.satPath} fill="none" stroke="#94a3b8" strokeWidth="2" strokeDasharray="6 3" opacity="0.15" />
                                    {chartAssets.rhLines.map((rh) => <path key={rh.rh} d={rh.path} fill="none" stroke="#e2e8f0" strokeWidth="1" strokeDasharray="4 4" />)}
                                    {chartAssets.zonePath && <path d={chartAssets.zonePath} fill="#4f46e5" fillOpacity="0.05" stroke="#4f46e5" strokeWidth="1.5" strokeDasharray="6 4" />}
                                    
                                    {mode === 'AHU' && (
                                        <g>
                                            <line x1={xScale(calcResults.oaState.db)} y1={yScale(calcResults.oaState.w)} x2={xScale(calcResults.raState.db)} y2={yScale(calcResults.raState.w)} stroke="#cbd5e1" strokeWidth="2" strokeDasharray="8 4" />
                                            <circle cx={xScale(calcResults.raState.db)} cy={yScale(calcResults.raState.w)} r="8" fill="white" stroke="#10b981" strokeWidth="2" />
                                            <circle cx={xScale(calcResults.oaState.db)} cy={yScale(calcResults.oaState.w)} r="8" fill="white" stroke="#3b82f6" strokeWidth="2" />
                                        </g>
                                    )}
                                    
                                    {processPaths.map((p, i) => <path key={i} d={p.d} stroke={p.color} strokeWidth="6" fill="none" strokeLinecap="round" className="process-line shadow-sm" />)}
                                    {calcResults.stages.map((s, i) => (
                                        <g key={i} onMouseEnter={() => setHoveredPoint(s)} onMouseLeave={() => setHoveredPoint(null)} className="cursor-crosshair group">
                                            <circle cx={xScale(s.state.db)} cy={yScale(s.state.w)} r="11" fill="white" stroke={i === 0 && mode === 'AHU' ? "#10b981" : "#1e293b"} strokeWidth="3" className="shadow-2xl transition-all group-hover:r-14" />
                                            <text x={xScale(s.state.db)} y={yScale(s.state.w)} dy="4" textAnchor="middle" className="text-[10px] font-black fill-slate-800 pointer-events-none font-heading">{i+1}</text>
                                        </g>
                                    ))}
                                </svg>
                            </div>

                            {/* 核算報告區域 */}
                            <div className="bg-white border border-slate-200 rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-8 shadow-2xl relative overflow-hidden">
                                <div className="flex flex-col gap-6 md:gap-8 relative z-10">
                                    <div className="flex flex-col lg:flex-row lg:justify-between lg:items-end gap-6">
                                        <div className="flex items-center gap-4 md:gap-6">
                                            <div className="bg-gradient-to-br from-indigo-600 to-indigo-800 p-3 md:p-4 rounded-2xl shadow-xl text-white transform -rotate-3 border border-indigo-400/30 shrink-0"><Icon name="FileBarChart" className="w-6 h-6 md:w-7 md:h-7" /></div>
                                            <div>
                                                <h3 className="text-xl md:text-2xl font-black font-heading uppercase text-slate-800 tracking-tighter leading-none">空調設計核算總表</h3>
                                                <p className="text-[9px] md:text-[10px] text-slate-400 font-black uppercase mt-2 tracking-[0.2em] font-mono italic">Audit Report Cycle: {mode} active</p>
                                            </div>
                                        </div>
                                        <div className="flex flex-col sm:flex-row gap-4">
                                            <div className="bg-emerald-50 border border-emerald-100 p-3 md:p-4 rounded-3xl flex items-center gap-4 px-6 md:px-10 shadow-inner w-full sm:w-auto">
                                                <div className="bg-emerald-600 p-2 rounded-xl text-white shadow-md shadow-emerald-200 shrink-0"><Icon name="Droplets" className="w-5 h-5" /></div>
                                                <div className="text-right">
                                                    <p className="text-[8px] md:text-[10px] font-black text-emerald-800/40 uppercase leading-none mb-1 tracking-widest">Total Condensate</p>
                                                    <p className="text-2xl md:text-3xl font-black text-emerald-600 font-heading leading-none tracking-tighter">
                                                        {calcResults.totalWaterRate.toFixed(2)} <span className="text-[10px] md:text-xs italic font-bold">L/h</span>
                                                    </p>
                                                </div>
                                            </div>
                                            <button onClick={handleExportExcel} className="bg-slate-800 hover:bg-slate-900 px-6 md:px-8 py-3 md:py-4 rounded-3xl text-[10px] md:text-[11px] font-black text-white uppercase flex items-center justify-center gap-3 shadow-xl transition-all">
                                                <Icon name="DownloadCloud"/> 輸出 EXCEL
                                            </button>
                                        </div>
                                    </div>

                                    {/* 能源進出水溫配置 */}
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 bg-slate-50 p-4 md:p-6 rounded-3xl border border-slate-100 shadow-inner">
                                        {['CHW_L', 'CHW_M', 'HW', 'WW'].map(k => (
                                            <div key={k} className="space-y-3">
                                                <div className="text-[9px] font-black uppercase tracking-[0.1em] border-b border-slate-200/60 pb-2 flex items-center gap-2 text-slate-500">
                                                    <div className={`w-2 h-2 rounded-full ${k==='HW'?'bg-rose-500':k==='WW'?'bg-teal-400':'bg-blue-500'}`} /> {k === 'WW' ? '水洗段' : k === 'HW' ? '熱水段' : k === 'CHW_L' ? '低溫冰水' : '中溫冰水'}
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div className="flex flex-col"><span className="text-[8px] text-slate-400 mb-1 ml-1 font-bold">Tin</span><input type="number" value={waterConfig[k].in} onChange={e=>setWaterConfig({...waterConfig,[k]:{...waterConfig[k],in:Number(e.target.value)}})} className="bg-white border border-slate-200 rounded-xl p-1.5 text-center font-black text-indigo-700 outline-none text-xs font-data shadow-sm" /></div>
                                                    <div className="flex flex-col"><span className="text-[8px] text-slate-400 mb-1 ml-1 font-bold">Tout</span><input type="number" value={waterConfig[k].out} onChange={e=>setWaterConfig({...waterConfig,[k]:{...waterConfig[k],out:Number(e.target.value)}})} className="bg-white border border-slate-200 rounded-xl p-1.5 text-center font-black text-indigo-700 outline-none text-xs font-data shadow-sm" /></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* 數據表格 - 針對橫向空間優化 */}
                                    <div className="w-full border border-slate-100 rounded-3xl overflow-x-auto shadow-sm bg-white custom-scrollbar">
                                        <table className="w-full text-left border-collapse min-w-[700px]">
                                            <thead>
                                                <tr className="bg-slate-800 text-white uppercase text-[9px] font-black font-heading tracking-[0.1em]">
                                                    <th className="p-3 md:p-4 px-4 md:px-6 w-1/4">盤管組件</th>
                                                    <th className="p-3 md:p-4 text-center bg-slate-700 border-l border-white/5">負荷 (kW)</th>
                                                    <th className="p-3 md:p-4 text-center bg-slate-700 border-l border-white/5 uppercase">RT</th>
                                                    <th className="p-3 md:p-4 text-center bg-slate-700 border-l border-white/5">流量 (LPM)</th>
                                                    <th className="p-3 md:p-4 text-center bg-indigo-700 border-l border-white/5 shadow-2xl">建議管徑</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-[10px] md:text-[11px]">
                                                {calcResults.results.map((res, i) => (
                                                    <tr key={res.id} className="border-b border-slate-50 hover:bg-slate-50/80 transition-all group">
                                                        <td className="p-3 md:p-4 px-4 md:px-6 font-black flex items-center gap-2 italic text-slate-700">
                                                            <div className={`w-2.5 h-2.5 rounded-full ${res.energy==='HW'?'bg-rose-500':res.energy==='WW'?'bg-teal-500':res.energy==='CHW_M'?'bg-sky-400':'bg-blue-600'} shadow-sm shrink-0`} />
                                                            <span className="text-xs font-heading group-hover:text-indigo-600 uppercase truncate">{res.label}</span>
                                                        </td>
                                                        <td className="p-3 md:p-4 text-center font-data font-black text-slate-800 text-base md:text-xl tracking-tighter border-l border-slate-50">{Math.abs(res.load).toFixed(1)}</td>
                                                        <td className="p-3 md:p-4 text-center font-data font-black text-slate-800 text-base md:text-xl tracking-tighter border-l border-slate-50">{res.rt.toFixed(1)}</td>
                                                        <td className="p-3 md:p-4 text-center font-data font-black text-slate-800 text-base md:text-xl tracking-tighter border-l border-slate-50">{res.lpm.toFixed(1)}</td>
                                                        <td className="p-3 md:p-4 text-center font-heading font-black text-emerald-600 italic text-xl md:text-3xl bg-emerald-50/5 tracking-tighter border-l border-slate-50">{res.pipeSize}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div className="h-10 shrink-0" />
                        </main>
                    </div>

                    {hoveredPoint && (
                        <div className="fixed pointer-events-none z-50 transition-all duration-300 hidden sm:block" style={{ left: 'max(10px, min(80vw, ' + (xScale(hoveredPoint.state.db) + 320) + 'px))', top: yScale(hoveredPoint.state.w) + 100 + 'px' }}>
                            <div className="bg-slate-800/95 text-white p-5 md:p-6 rounded-[1.5rem] md:rounded-[2rem] shadow-2xl w-[180px] md:w-[210px] backdrop-blur-xl border border-white/10 shadow-indigo-900/30">
                                <h4 className="text-[10px] md:text-[12px] font-black uppercase text-indigo-400 italic mb-3 border-b border-white/5 pb-2 font-heading tracking-widest truncate">{hoveredPoint.label}</h4>
                                <div className="space-y-2 text-[9px] md:text-[10px] font-mono">
                                    <div className="flex justify-between text-slate-400 uppercase"><span>DB/WB</span><span className="text-white font-bold">{hoveredPoint.state.db.toFixed(1)}/{hoveredPoint.state.wb.toFixed(1)}℃</span></div>
                                    <div className="flex justify-between text-slate-400 uppercase"><span>RH/DP</span><span className="text-white font-bold">{hoveredPoint.state.rh.toFixed(0)}%/{hoveredPoint.state.dp.toFixed(1)}℃</span></div>
                                    <div className="flex justify-between border-t border-white/10 pt-3 text-slate-400 uppercase"><span>Enthalpy (h)</span><span className="text-teal-400 font-black">{hoveredPoint.state.h.toFixed(1)} kJ</span></div>
                                    <div className="flex justify-between text-slate-400 uppercase"><span>Abs Hum. (w)</span><span className="text-indigo-400 font-black">{(hoveredPoint.state.w * 1000).toFixed(1)} g</span></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
