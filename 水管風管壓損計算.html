<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC å°ˆæ¥­è¨­è¨ˆå¯©æŸ¥ç´šå£“æè¨ˆç®—æ›¸ (æ©Ÿé›»ä¸»ä»»å·¥ç¨‹å¸«ç‰ˆ)</title>
    
    <!-- è¼‰å…¥æ ¸å¿ƒèˆ‡å­—é«” -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #2563eb;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --bg-main: #f8fafc;
        }

        body { 
            font-family: 'Inter', 'Microsoft JhengHei', sans-serif; 
            background-color: var(--bg-main); 
            color: #1e293b;
            letter-spacing: -0.01em;
        }

        .mono { font-family: 'Roboto Mono', monospace; }
        
        .pro-card { 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .input-pro {
            border: 1px solid #cbd5e1;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.875rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-pro:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.12);
        }

        .tab-btn {
            padding: 10px 28px;
            font-size: 0.875rem;
            font-weight: 700;
            border-radius: 14px;
            transition: all 0.3s ease;
            color: #64748b;
        }
        .tab-active { 
            background: white; 
            color: var(--accent); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide { animation: slideUp 0.4s ease-out forwards; }

        .val-display { background: #f1f5f9; padding: 4px 10px; border-radius: 8px; font-weight: 700; color: #334155; }

        /* KaTeX ä¿®æ­£ */
        .katex { font-size: 1.05em !important; }

        @media print { .no-print { display: none !important; } body { background: white; padding: 0; } .pro-card { border: none; box-shadow: none; } }
    </style>
</head>
<body class="p-6 md:p-10">

    <div class="max-w-[1500px] mx-auto space-y-8">
        
        <!-- Header -->
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center bg-[#0f172a] p-10 rounded-[2.5rem] shadow-2xl animate-slide text-white relative overflow-hidden">
            <div class="absolute right-0 top-0 w-80 h-80 bg-blue-500/10 rounded-full blur-[100px]"></div>
            <div class="z-10 flex items-center gap-6">
                <div class="p-5 bg-blue-600 rounded-3xl shadow-2xl shadow-blue-500/20">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </div>
                <div>
                    <h1 class="text-3xl font-black tracking-tight">HVAC ç³»çµ±å£“åŠ›æå¤±å¯©æŸ¥è¨ˆç®—æ›¸</h1>
                    <div class="flex items-center gap-3 mt-2">
                        <span class="text-[11px] font-bold uppercase tracking-widest text-blue-400">Mechanical Engineering Suite</span>
                        <div class="h-1 w-1 rounded-full bg-slate-600"></div>
                        <span class="text-[11px] text-slate-400 font-mono">Standard: ASHRAE Fundamentals 2025</span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-4 mt-8 lg:mt-0 no-print z-10">
                <button onclick="toggleHelp()" class="flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-2xl transition-all font-bold text-sm backdrop-blur-md border border-white/10">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    è¨­è¨ˆæŒ‡å—
                </button>
                <div class="flex bg-slate-800/50 p-2 rounded-[1.5rem] backdrop-blur-md border border-white/5 shadow-inner">
                    <button onclick="switchTab('water')" id="btnWater" class="tab-btn tab-active">æ°´ç³»çµ±</button>
                    <button onclick="switchTab('air')" id="btnAir" class="tab-btn">é¢¨ç³»çµ±</button>
                </div>
            </div>
        </header>

        <main class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-start">
            
            <!-- Left Engine -->
            <div class="xl:col-span-9 space-y-8 animate-slide" style="animation-delay: 0.1s;">
                <div class="pro-card overflow-hidden">
                    <div class="p-6 border-b border-slate-100 flex flex-wrap justify-between items-center bg-slate-50/50 gap-6 no-print">
                        <div class="flex items-center gap-5">
                            <h2 class="text-sm font-black text-slate-800 uppercase tracking-widest flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                                é—œéµç’°è·¯å…ƒä»¶æ˜ç´°
                            </h2>
                            <div class="flex gap-2">
                                <span id="currentSystemTag" class="px-3 py-1 rounded-lg bg-blue-600 text-white text-[10px] font-black tracking-tighter uppercase">Water System</span>
                                <div id="airContext" class="hidden text-[10px] text-blue-700 font-bold bg-white px-3 py-1 rounded-lg border border-blue-200">ç©ºæ°£å¯†åº¦ $\rho = 1.204 \text{ kg/m}^3$</div>
                                <div id="waterContext" class="text-[10px] text-indigo-700 font-bold bg-white px-3 py-1 rounded-lg border border-indigo-200">æ¸…æ°´å¯†åº¦ $\rho = 998.2 \text{ kg/m}^3$</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="addRow('pipe')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-2xl text-xs font-black transition-all shadow-xl shadow-blue-500/20">â• æ–°å¢ç®¡æ®µ</button>
                            <button onclick="addRow('fitting')" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2.5 rounded-2xl text-xs font-black transition-all">â• é›¶ä»¶é¸ç”¨</button>
                            <button onclick="addRow('equipment')" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-2.5 rounded-2xl text-xs font-black transition-all">â• è¨­å‚™å£“æ</button>
                        </div>
                    </div>

                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-separate border-spacing-y-4">
                                <thead>
                                    <tr class="text-[11px] text-slate-400 font-black uppercase tracking-[0.2em] px-4">
                                        <th class="pb-2 pl-4">ç·¨è™Ÿèˆ‡è­˜åˆ¥</th>
                                        <th class="pb-2">å¹¾ä½•åƒæ•¸</th>
                                        <th class="pb-2">é•·åº¦ (m)</th>
                                        <th class="pb-2" id="thFlow">æµé‡ (mÂ³/h)</th>
                                        <th class="pb-2">é˜»åŠ›è¨­å®š (å¸¸ç”¨é¸å–®)</th>
                                        <th class="pb-2 pr-4 text-center">è¨ˆç®—èˆ‡æµæ…‹</th>
                                        <th class="pb-2 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody id="calcBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Footer Summary -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 animate-slide" style="animation-delay: 0.2s;">
                    <div class="pro-card p-8 border-t-8 border-blue-600">
                        <h3 class="font-black text-slate-800 text-xs uppercase tracking-widest mb-6 flex items-center gap-2">
                            <div class="w-2 h-4 bg-blue-600 rounded-sm"></div> æŠ€è¡“èˆ‡ç‰©ç†æ¨¡å‹ä¾æ“š
                        </h3>
                        <div class="space-y-4 text-[12px] leading-relaxed text-slate-500">
                            <div id="waterLogic" class="bg-slate-50 p-5 rounded-[1.5rem] border border-slate-100">
                                <p class="font-black text-slate-800 underline mb-2 tracking-tight">Hydronic System (æ°´ç³»çµ±):</p>
                                <p>â— ç•¶ $Re \ge 10^4$ æ™‚ï¼Œæ¡ç”¨ Hazen-Williams å…¬å¼è¨ˆç®—ç£¨æ“¦ã€‚</p>
                                <p>â— ä½é›·è«¾æ•¸æµæ…‹ä¸‹ï¼Œè‡ªå‹•æ”¹æ¡ Darcy-Weisbach ä»¥ç¶­è­·å¯©æŸ¥ç²¾åº¦ã€‚</p>
                            </div>
                            <div id="airLogic" class="hidden bg-slate-50 p-5 rounded-[1.5rem] border border-slate-100">
                                <p class="font-black text-slate-800 underline mb-2 tracking-tight">Air Distribution (é¢¨ç³»çµ±):</p>
                                <p>â— å…¨ç¨‹æ±‚è§£ Swamee-Jain æ‘©æ“¦å› å­ $f$ï¼Œç²—ç³™åº¦ $\epsilon = 0.15 \text{ mm}$ã€‚</p>
                                <p>â— æ–¹ç®¡æ¡ç”¨æ°´åŠ›ç›´å¾‘ $D_h = \frac{4A}{P}$ é€²è¡Œæµæ…‹åˆ†æã€‚</p>
                            </div>
                        </div>
                    </div>
                    <div class="pro-card p-8 border-t-8 border-red-500 bg-red-50/20">
                        <h3 class="font-black text-red-800 text-xs mb-6 uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            å¯©æŸ¥ç•°å¸¸èˆ‡è¨­è¨ˆè­¦å ±
                        </h3>
                        <div id="warningsContainer" class="space-y-3">
                            <p class="text-[11px] text-slate-400 italic">ç›®å‰è¨­è¨ˆåƒæ•¸å‡ç¬¦åˆæ©Ÿé›»å¯©æŸ¥æ¨™æº–...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <aside class="xl:col-span-3 space-y-8 no-print animate-slide" style="animation-delay: 0.3s;">
                <div class="pro-card p-8 sticky top-10 shadow-2xl border-blue-50/50">
                    <h2 class="text-xs font-black text-slate-400 mb-8 border-b pb-4 uppercase tracking-[0.2em]">Summary Dashboard</h2>
                    
                    <div class="space-y-8">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center group">
                                <span class="text-[11px] font-bold text-slate-400 uppercase tracking-tighter">ç›´ç®¡åˆè¨ˆ $H_f$</span>
                                <span class="mono text-slate-900 val-display" id="resFriction">0.000</span>
                            </div>
                            <div class="flex justify-between items-center group">
                                <span class="text-[11px] font-bold text-slate-400 uppercase tracking-tighter">å±€éƒ¨åˆè¨ˆ $H_m$</span>
                                <span class="mono text-slate-900 val-display" id="resFitting">0.000</span>
                            </div>
                            <div class="flex justify-between items-center group">
                                <span class="text-[11px] font-bold text-amber-600 uppercase tracking-tighter">è¨­å‚™å®šé¡ $H_e$</span>
                                <span class="mono font-bold text-amber-700 bg-amber-50 px-2 py-1 rounded" id="resEquip">0.000</span>
                            </div>
                        </div>

                        <div class="p-6 bg-slate-50 rounded-[2rem] border border-slate-100 space-y-3">
                            <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest font-bold">å®‰å…¨ä¿‚æ•¸ (Safety Factor)</label>
                            <input type="number" id="sfValue" value="1.15" step="0.01" class="font-mono w-full bg-white border border-slate-200 rounded-2xl p-4 font-black text-blue-600 input-pro" onchange="updateCalculations()">
                        </div>

                        <div class="relative overflow-hidden bg-[#0f172a] rounded-[2.5rem] p-10 text-white shadow-2xl">
                            <div class="absolute -right-8 -top-8 w-32 h-32 bg-blue-600/30 rounded-full blur-3xl"></div>
                            <p class="text-[11px] text-blue-400 uppercase font-black mb-2 tracking-widest">ç¸½æšç¨‹/éœå£“éœ€æ±‚</p>
                            <div class="flex items-baseline gap-2">
                                <span class="text-6xl font-black mono text-white tracking-tighter" id="totalResult">0.00</span>
                                <span id="mainUnit" class="text-lg font-bold text-slate-500 font-bold">mH2O</span>
                            </div>
                        </div>

                        <div id="dynamicPressureBox" class="hidden bg-blue-50/50 p-6 rounded-[2rem] border border-blue-100">
                            <span class="text-[11px] text-blue-800 font-black uppercase tracking-widest font-bold">ç³»çµ±å‡ºå£å‹•å£“ $P_d$</span>
                            <div class="flex items-baseline gap-2 mt-2">
                                <span class="text-4xl font-black text-blue-900 mono" id="resDynamic">0</span>
                                <span class="text-sm font-bold text-blue-800 font-bold">Pa</span>
                            </div>
                        </div>

                        <button onclick="window.print()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl transition-all shadow-2xl shadow-blue-200 uppercase text-xs tracking-widest">
                            ä¸‹è¼‰æ­£å¼å¯©æŸ¥å ±å‘Š (PDF)
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-50 flex items-center justify-center hidden p-6">
        <div class="bg-white w-full max-w-4xl rounded-[3.5rem] shadow-2xl overflow-hidden animate-slide">
            <div class="p-10 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 class="text-2xl font-black text-slate-900 tracking-tighter">HVAC å£“æè¨ˆç®—å™¨ï¼šå°ˆå®¶ä½¿ç”¨æŒ‡å—</h2>
                <button onclick="toggleHelp()" class="p-3 hover:bg-slate-200 rounded-full transition-all text-xl">âœ•</button>
            </div>
            <div class="p-12 max-h-[70vh] overflow-y-auto space-y-12">
                <section class="grid grid-cols-1 md:grid-cols-2 gap-12 text-slate-600">
                    <div class="space-y-4">
                        <h4 class="font-black text-blue-600 uppercase text-xs tracking-[0.2em] border-b pb-2 font-bold">æ°´ç³»çµ±æ“ä½œ SOP</h4>
                        <ol class="space-y-4 text-sm list-decimal ml-4">
                            <li><strong>è·¯å¾‘é¸å–</strong>ï¼šåƒ…è¼¸å…¥æœ€ä¸åˆ©è¿´è·¯ï¼ˆæ³µåˆ°æœ€é é»ï¼‰ã€‚</li>
                            <li><strong>æµé‡éºå‚³</strong>ï¼šåªéœ€è¼¸å…¥ç¬¬ä¸€æ®µæµé‡ï¼Œå¾ŒçºŒé›¶ä»¶è‡ªå‹•ç¹¼æ‰¿ã€‚</li>
                            <li><strong>é¸å–®åŠŸèƒ½</strong>ï¼šå„ªå…ˆå¾é è¨­é›¶ä»¶åº«é¸å– K å€¼ï¼Œç¢ºä¿å¯©æŸ¥ä¸€è‡´æ€§ã€‚</li>
                        </ol>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-black text-indigo-600 uppercase text-xs tracking-[0.2em] border-b pb-2 font-bold">é¢¨ç³»çµ±é‡é»</h4>
                        <ul class="space-y-4 text-sm list-disc ml-4">
                            <li><strong>å¹¾ä½•é¡å‹</strong>ï¼šåœ“ç®¡/æ–¹ç®¡è‡ªå‹•åˆ‡æ›è¨ˆç®—æ¨¡å‹ã€‚</li>
                            <li><strong>é¸å‹åŸºç¤</strong>ï¼šé¢¨æ©Ÿé¸å‹è«‹ä»¥å³å´ã€Œç¸½éœå£“éœ€æ±‚ã€ç‚ºæº–ã€‚</li>
                        </ul>
                    </div>
                </section>
                <div class="bg-red-50 p-10 rounded-[2.5rem] border border-red-100">
                    <h4 class="font-black text-red-800 uppercase text-xs tracking-widest mb-6 font-bold">âš ï¸ å·¥ç¨‹è¨­è¨ˆé˜²å‘†æª¢æŸ¥ (Audit)</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 text-[11px] font-bold text-red-700 leading-relaxed">
                        <div class="flex gap-3"><span>âœ•</span> <span>åˆ‡å‹¿æ¯ä¸€æ®µç®¡éƒ½è¼¸å…¥æµé‡ï¼Œé€™æœƒå°è‡´ç¹¼æ‰¿é‚è¼¯éŒ¯èª¤ã€‚</span></div>
                        <div class="flex gap-3"><span>âœ•</span> <span>æµé€Ÿè­¦å‘Šè‹¥é¡¯ç¤ºç´…è‰²ï¼Œä»£è¡¨å™ªéŸ³èˆ‡éœ‡å‹•éé«˜ï¼Œè«‹èª¿å¤§ç®¡å¾‘ã€‚</span></div>
                        <div class="flex gap-3"><span>âœ•</span> <span>å®‰å…¨ä¿‚æ•¸ SF åƒ…ä½œç”¨æ–¼ç®¡è·¯ç£¨æ“¦ï¼Œä¸å°è¨­å‚™å£“æé‡è¤‡è¨ˆç®—ã€‚</span></div>
                        <div class="flex gap-3"><span>âœ•</span> <span>è«‹ç¢ºèªé›¶ä»¶åº«é¸å–çš„é …ç›®æ˜¯å¦èˆ‡æ‚¨çš„åœ–ç´™è¦ç¯„ä¸€è‡´ã€‚</span></div>
                    </div>
                </div>
            </div>
            <div class="p-10 bg-slate-50 border-t flex justify-center">
                <button onclick="toggleHelp()" class="bg-slate-900 text-white px-20 py-5 rounded-[2rem] font-black hover:scale-105 transition-all shadow-2xl">é€²å…¥è¨­è¨ˆæ›¸</button>
            </div>
        </div>
    </div>

    <script>
        let mode = 'water';
        let rows = [];
        
        const LIBRARIES = {
            water: {
                fittings: [
                    { name: 'ğŸ”˜ è‡ªå®šç¾©è¼¸å…¥ (K)', value: 0 },
                    { name: 'ğŸ“ 90Â° å½é ­ (é•·åŠå¾‘)', value: 0.45 },
                    { name: 'ğŸ“ 90Â° å½é ­ (æ¨™æº–)', value: 0.90 },
                    { name: 'ğŸ“ 45Â° å½é ­', value: 0.35 },
                    { name: 'ğŸ”± ä¸‰é€š - åˆ†æµ (Branch)', value: 1.80 },
                    { name: 'ğŸ”± ä¸‰é€š - ç›´é€š (Through)', value: 0.60 },
                    { name: 'ğŸšï¸ é–˜é–¥ (å…¨é–‹)', value: 0.17 },
                    { name: 'ğŸšï¸ è¶é–¥ (å…¨é–‹)', value: 0.80 },
                    { name: 'ğŸ›¡ï¸ æ­¢å›é–¥ (æ—‹å•Ÿå¼)', value: 2.50 },
                    { name: 'ğŸ§¬ Yå‹éæ¿¾å™¨', value: 4.50 }
                ],
                equipment: [
                    { name: 'ğŸ”˜ è‡ªå®šç¾©è¼¸å…¥ (mH2O)', value: 0 },
                    { name: 'â„ï¸ å†°æ©Ÿè’¸ç™¼å™¨ (Chiller Evap)', value: 5.0 },
                    { name: 'ğŸ”¥ å†°æ©Ÿå†·å‡å™¨ (Chiller Cond)', value: 6.5 },
                    { name: 'ğŸ™ï¸ å†·å»æ°´å¡” (å…§éƒ¨æè€—)', value: 2.5 },
                    { name: 'ğŸ“¦ FCU ç›¤ç®¡', value: 2.2 },
                    { name: 'ğŸ—ï¸ AHU ç›¤ç®¡ (6 Row)', value: 4.8 },
                    { name: 'ğŸ”„ æ¿æ› (Heat Exchanger)', value: 4.0 }
                ]
            },
            air: {
                fittings: [
                    { name: 'ğŸ”˜ è‡ªå®šç¾©è¼¸å…¥ (K)', value: 0 },
                    { name: 'ğŸ“ 90Â° å½é ­ (å«å°æµç‰‡)', value: 0.25 },
                    { name: 'ğŸ“ 90Â° å½é ­ (ç„¡å°æµç‰‡)', value: 1.20 },
                    { name: 'ğŸ”± ä¸‰é€šåˆ†æµ (Take-off)', value: 1.50 },
                    { name: 'ğŸ“¤ å‡ºé¢¨å£ (Grille)', value: 2.50 }
                ],
                equipment: [
                    { name: 'ğŸ”˜ è‡ªå®šç¾©è¼¸å…¥ (Pa)', value: 0 },
                    { name: 'ğŸŒ¬ï¸ AHU å…§éƒ¨å…¨å£“', value: 250 },
                    { name: 'ğŸ•¸ï¸ åˆæ•ˆæ¿¾ç¶² (Pre)', value: 60 },
                    { name: 'ğŸ•¸ï¸ ä¸­æ•ˆè¢‹å¼ (Bag)', value: 120 },
                    { name: 'ğŸ•¸ï¸ é«˜æ•ˆæ¿¾ç¶² (HEPA)', value: 250 },
                    { name: 'ğŸ”‡ æ¶ˆéŸ³å™¨ (Silencer)', value: 40 }
                ]
            }
        };

        const RHO_AIR = 1.204, MU_AIR = 1.81e-5, EPSILON_AIR = 0.00015; 
        const RHO_WATER = 998.2, MU_WATER = 0.001002, GRAVITY_ACCEL = 9.80665, EPSILON_WATER = 0.000045;

        function flow_m3h_to_m3s(q_h) { return (parseFloat(q_h) || 0) / 3600; }
        function toggleHelp() { document.getElementById('helpModal').classList.toggle('hidden'); }

        // æ ¸å¿ƒæ¸²æŸ“æ•¸å­¸å…¬å¼å‡½å¼
        function renderMath() {
            if (typeof renderMathInElement === 'function') {
                try {
                    renderMathInElement(document.body, {
                        delimiters: [
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                } catch (e) {
                    console.warn("KaTeX render failed", e);
                }
            }
        }

        function switchTab(newMode) {
            mode = newMode;
            document.getElementById('btnWater').className = (mode === 'water') ? 'tab-btn tab-active' : 'tab-btn';
            document.getElementById('btnAir').className = (mode === 'air') ? 'tab-btn tab-active' : 'tab-btn';
            document.getElementById('thFlow').innerText = (mode === 'water') ? 'è¨­è¨ˆæµé‡ (mÂ³/h)' : 'è¨­è¨ˆé¢¨é‡ (CMH)';
            document.getElementById('mainUnit').innerText = (mode === 'water') ? 'mH2O' : 'Pa';
            
            const elDyn = document.getElementById('dynamicPressureBox');
            const elAir = document.getElementById('airContext');
            const elWat = document.getElementById('waterContext');
            const elAirL = document.getElementById('airLogic');
            const elWatL = document.getElementById('waterLogic');
            const elTag = document.getElementById('currentSystemTag');

            if(elDyn) elDyn.classList.toggle('hidden', mode === 'water');
            if(elAir) elAir.classList.toggle('hidden', mode === 'water');
            if(elWat) elWat.classList.toggle('hidden', mode === 'air');
            if(elAirL) elAirL.classList.toggle('hidden', mode === 'water');
            if(elWatL) elWatL.classList.toggle('hidden', mode === 'air');
            
            if(elTag) {
                elTag.innerText = (mode === 'water') ? 'WATER SYSTEM' : 'AIR SYSTEM';
                elTag.className = (mode === 'water') ? 'px-3 py-1 rounded-lg bg-blue-600 text-white text-[10px] font-black' : 'px-3 py-1 rounded-lg bg-indigo-600 text-white text-[10px] font-black';
            }

            rows = []; 
            addRow('pipe'); 
            updateCalculations();
        }

        function addRow(type) {
            const row = {
                id: Date.now(),
                type: type,
                name: type === 'pipe' ? `P-${rows.length+1}` : (type === 'fitting' ? `F-${rows.length+1}` : `E-${rows.length+1}`),
                d1: mode === 'water' ? 50 : 300, 
                d2: mode === 'air' ? 300 : 0,   
                shape: 'circular',
                length: 10,
                flow: 0,
                lossType: 'k', 
                libSelection: 'ğŸ”˜ è‡ªå®šç¾©è¼¸å…¥',
                kValue: 0,
                leq: 0,
                cValue: 120,
                fixedLoss: 0
            };
            if (rows.length === 0 && type === 'pipe') row.flow = mode === 'water' ? 10 : 1200;
            rows.push(row);
            renderTable();
            updateCalculations();
        }

        function removeRow(id) { 
            rows = rows.filter(r => r.id !== id); 
            renderTable(); 
            updateCalculations(); 
        }
        
        function updateRow(id, field, value) {
            const row = rows.find(r => r.id === id);
            if (row) {
                if (field === 'libSelection') {
                    const lib = row.type === 'fitting' ? LIBRARIES[mode].fittings : LIBRARIES[mode].equipment;
                    const selected = lib.find(item => item.name === value);
                    row.libSelection = value;
                    if (selected && !value.includes('è‡ªå®šç¾©')) {
                        if (row.type === 'fitting') row.kValue = selected.value;
                        else row.fixedLoss = selected.value;
                    }
                } else {
                    row[field] = (field === 'name' || field === 'shape' || field === 'lossType') ? value : parseFloat(value) || 0;
                }
                renderTable();
                updateCalculations();
            }
        }

        function getEffectiveFlow(currentRow, index) {
            if (currentRow.flow > 0) return currentRow.flow;
            for (let i = index - 1; i >= 0; i--) {
                if (rows[i].type === 'pipe' && rows[i].flow > 0) return rows[i].flow;
            }
            return 0;
        }

        function getFrictionFactor(re, d, epsilon) {
            if (re < 2320) return re > 0 ? 64 / re : 0;
            return 0.25 / Math.pow(Math.log10((epsilon / (3.7 * d)) + (5.74 / Math.pow(re, 0.9))), 2);
        }

        function calculateRow(row, index) {
            let res = { loss: 0, v: 0, re: 0, vRisk: false, flowUsed: 0 };
            if (row.type === 'equipment') { res.loss = row.fixedLoss; return res; }
            if (row.d1 <= 0 || (row.shape === 'rectangular' && row.d2 <= 0)) return res;

            const effectiveFlow_h = getEffectiveFlow(row, index);
            res.flowUsed = effectiveFlow_h;
            const q_m3s = flow_m3h_to_m3s(effectiveFlow_h);

            let v = 0, dh = 0, area = 0;
            if (mode === 'water') {
                dh = row.d1 / 1000;
                area = Math.PI * Math.pow(dh/2, 2);
                v = q_m3s / area;
                res.re = (RHO_WATER * v * dh) / MU_WATER;
                res.vRisk = (v > 2.4 || v < 0.6);
            } else {
                if (row.shape === 'circular') {
                    dh = row.d1 / 1000;
                    area = Math.PI * Math.pow(dh/2, 2);
                } else {
                    const a = row.d1 / 1000, b = row.d2 / 1000;
                    dh = (2 * a * b) / (a + b);
                    area = a * b;
                }
                v = q_m3s / area;
                res.re = (RHO_AIR * v * dh) / MU_AIR;
                res.vRisk = (v > 12.0 || v < 2.5);
            }
            res.v = v;

            if (row.type === 'pipe') {
                if (mode === 'water') {
                    if (res.re >= 10000) {
                        res.loss = (10.67 * row.length * Math.pow(q_m3s, 1.852)) / (Math.pow(row.cValue, 1.852) * Math.pow(dh, 4.8704));
                    } else {
                        const f = getFrictionFactor(res.re, dh, EPSILON_WATER);
                        res.loss = (f * (row.length / dh) * (v * v) / (2 * GRAVITY_ACCEL));
                    }
                } else {
                    const f = getFrictionFactor(res.re, dh, EPSILON_AIR);
                    res.loss = f * (row.length / dh) * (RHO_AIR * v * v / 2);
                }
            } else if (row.type === 'fitting') {
                if (row.lossType === 'k') {
                    res.loss = (mode === 'water') ? (row.kValue * v * v / (2 * GRAVITY_ACCEL)) : (row.kValue * RHO_AIR * v * v / 2);
                } else {
                    if (mode === 'water') {
                        res.loss = (res.re >= 10000) ? (10.67 * row.leq * Math.pow(q_m3s, 1.852)) / (Math.pow(row.cValue, 1.852) * Math.pow(dh, 4.8704)) : (getFrictionFactor(res.re, dh, EPSILON_WATER) * (row.leq / dh) * (v * v) / (2 * GRAVITY_ACCEL));
                    } else {
                        res.loss = getFrictionFactor(res.re, dh, EPSILON_AIR) * (row.leq / dh) * (RHO_AIR * v * v / 2);
                    }
                }
            }
            return res;
        }

        function updateCalculations() {
            let fricTotal = 0, fitTotal = 0, eqTotal = 0, vMax = 0, warnings = [];
            rows.forEach((row, idx) => {
                const r = calculateRow(row, idx);
                if (row.type === 'pipe') fricTotal += r.loss;
                else if (row.type === 'fitting') fitTotal += r.loss;
                else eqTotal += r.loss;
                if (r.v > vMax) vMax = r.v;
                if (r.flowUsed <= 0 && row.type !== 'equipment') warnings.push(`[${row.name}] æœªå¡«æµé‡æ•¸æ“šã€‚`);
            });

            const sf = parseFloat(document.getElementById('sfValue').value) || 1.0;
            const total = (fricTotal + fitTotal) * sf + eqTotal;
            
            document.getElementById('resFriction').innerText = fricTotal.toFixed(3);
            document.getElementById('resFitting').innerText = fitTotal.toFixed(3);
            document.getElementById('resEquip').innerText = eqTotal.toFixed(2);
            document.getElementById('totalResult').innerText = total.toFixed(2);
            
            const elDynVal = document.getElementById('resDynamic');
            if (elDynVal) elDynVal.innerText = (RHO_AIR * vMax * vMax / 2).toFixed(0);

            const warnContainer = document.getElementById('warningsContainer');
            if (warnContainer) {
                warnContainer.innerHTML = '';
                if (warnings.length > 0) {
                    [...new Set(warnings)].forEach(w => {
                        const d = document.createElement('div');
                        d.className = "text-[10px] text-red-800 bg-red-100/50 p-2 rounded-lg border border-red-200 mb-1 font-bold animate-slide";
                        d.innerHTML = `<span class="bg-red-600 text-white px-1 mr-1 rounded-sm uppercase italic">Risk</span> ${w}`;
                        warnContainer.appendChild(d);
                    });
                } else if (rows.length > 0) {
                    warnContainer.innerHTML = '<p class="text-[10px] text-green-700 font-bold bg-green-50 p-2 rounded-lg border border-green-100 flex items-center gap-2">âœ“ ç¬¦åˆæ©Ÿé›»å¯©æŸ¥è¨­è¨ˆåŸºæº–</p>';
                }
            }
            renderMath();
        }

        function renderTable() {
            const tbody = document.getElementById('calcBody'); if (!tbody) return;
            tbody.innerHTML = '';
            rows.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = "pro-card bg-white hover:bg-slate-50 transition-all align-top animate-slide";
                
                let geomHTML = '';
                if (row.type === 'pipe') {
                    if (mode === 'water') geomHTML = `<div class="flex flex-col gap-1"><label class="text-[9px] font-black text-slate-400">INNER DN</label><input type="number" value="${row.d1}" onchange="updateRow(${row.id}, 'd1', this.value)" class="input-pro"></div>`;
                    else geomHTML = `<div class="flex flex-col gap-1"><select onchange="updateRow(${row.id}, 'shape', this.value)" class="text-[9px] h-6 py-0 font-black bg-slate-100 rounded-lg border-none"><option value="circular" ${row.shape === 'circular' ? 'selected' : ''}>ROUND</option><option value="rectangular" ${row.shape === 'rectangular' ? 'selected' : ''}>RECT</option></select><div class="flex gap-1"><input type="number" value="${row.d1}" onchange="updateRow(${row.id}, 'd1', this.value)" class="input-pro w-full font-bold">${row.shape === 'rectangular' ? `<input type="number" value="${row.d2}" onchange="updateRow(${row.id}, 'd2', this.value)" class="input-pro w-full font-bold">` : ''}</div></div>`;
                } else if (row.type === 'fitting' && row.lossType === 'leq') {
                    geomHTML = `<div class="flex flex-col gap-1"><label class="text-[9px] font-black text-slate-400">REF DN</label><input type="number" value="${row.d1}" onchange="updateRow(${row.id}, 'd1', this.value)" class="input-pro"></div>`;
                } else { geomHTML = '<div class="h-12 flex items-center"><span class="text-slate-300 italic text-[10px] font-bold tracking-widest uppercase">Inherited</span></div>'; }

                let lossHTML = '';
                if (row.type === 'fitting') {
                    const libOptions = LIBRARIES[mode].fittings.map(item => `<option value="${item.name}" ${row.libSelection === item.name ? 'selected' : ''}>${item.name}</option>`).join('');
                    lossHTML = `
                        <div class="flex flex-col gap-1">
                            <select onchange="updateRow(${row.id}, 'libSelection', this.value)" class="text-[10px] h-7 py-0 font-bold bg-blue-50 text-blue-800 rounded-lg border-none">${libOptions}</select>
                            <div class="flex gap-2 items-center">
                                <select onchange="updateRow(${row.id}, 'lossType', this.value)" class="text-[9px] h-6 py-0 font-black bg-slate-100 rounded-lg border-none w-16"><option value="k" ${row.lossType === 'k' ? 'selected' : ''}>K</option><option value="leq" ${row.lossType === 'leq' ? 'selected' : ''}>LEQ</option></select>
                                <input type="number" step="0.01" value="${row.lossType === 'k' ? row.kValue : row.leq}" onchange="updateRow(${row.id}, row.lossType === 'k' ? 'kValue' : 'leq', this.value)" class="input-pro text-[11px] font-bold">
                            </div>
                        </div>`;
                } else if (row.type === 'equipment') {
                    const libOptions = LIBRARIES[mode].equipment.map(item => `<option value="${item.name}" ${row.libSelection === item.name ? 'selected' : ''}>${item.name}</option>`).join('');
                    lossHTML = `
                        <div class="flex flex-col gap-1">
                            <select onchange="updateRow(${row.id}, 'libSelection', this.value)" class="text-[10px] h-7 py-0 font-bold bg-amber-50 text-amber-800 rounded-lg border-none">${libOptions}</select>
                            <input type="number" value="${row.fixedLoss}" onchange="updateRow(${row.id}, 'fixedLoss', this.value)" class="input-pro font-black text-amber-600 bg-amber-50/20">
                        </div>`;
                } else {
                    lossHTML = `<div class="flex flex-col gap-1"><label class="text-[9px] font-black text-slate-400">C-COEFF</label><input type="number" value="${row.cValue}" onchange="updateRow(${row.id}, 'cValue', this.value)" class="input-pro font-bold"></div>`;
                }

                const res = calculateRow(row, idx);
                tr.innerHTML = `
                    <td class="p-4 pl-6"><input type="text" value="${row.name}" onchange="updateRow(${row.id}, 'name', this.value)" class="font-extrabold text-slate-800 bg-transparent border-none w-full focus:ring-0 text-sm"></td>
                    <td class="p-4">${geomHTML}</td>
                    <td class="p-4">${row.type !== 'equipment' ? `<div class="flex flex-col gap-1"><label class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Length</label><input type="number" value="${row.length}" onchange="updateRow(${row.id}, 'length', this.value)" class="input-pro w-20 font-bold"></div>` : '<span class="text-slate-300 font-bold">--</span>'}</td>
                    <td class="p-4">${row.type !== 'equipment' ? `<div class="flex flex-col gap-1"><label class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">Flow</label><input type="number" value="${row.flow}" onchange="updateRow(${row.id}, 'flow', this.value)" placeholder="Inherit" class="input-pro w-24 font-bold placeholder:font-normal"></div>` : '<span class="text-slate-300 font-bold">--</span>'}</td>
                    <td class="p-4">${lossHTML}</td>
                    <td class="p-4 pr-6">
                        <div class="text-[10px] mono text-slate-500 space-y-1.5 flex flex-col items-center">
                            <div class="flex justify-between w-full border-b border-slate-100 pb-1 italic font-bold">V: <span class="font-bold ${res.vRisk ? 'text-red-600' : 'text-blue-700'}">${res.v.toFixed(2)} m/s</span></div>
                            <div class="font-black text-slate-900 flex justify-between w-full uppercase">Î”P: <span class="text-blue-600 font-bold">${res.loss.toFixed(4)}</span></div>
                        </div>
                    </td>
                    <td class="p-4 text-right pr-6 no-print">
                        <button onclick="removeRow(${row.id})" class="text-slate-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-xl transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            renderMath();
        }

        window.onload = () => { 
            switchTab('water'); 
            // å»¶é²åŸ·è¡Œä¸€æ¬¡å…¨åŸŸå…¬å¼æ¸²æŸ“
            setTimeout(renderMath, 500);
        };
    </script>
</body>
</html>