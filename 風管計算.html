<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duct Master Pro - å°ˆæ¥­ç´šé¢¨ç®¡è¨ˆç®—ç³»çµ± v2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --eng-dark: #0f172a; --eng-accent: #0284c7; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .section-card { background: white; border: 1px solid #e2e8f0; border-radius: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .eng-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
        .eng-input:focus { border-color: var(--eng-accent); ring: 3px; ring-color: rgba(2, 132, 199, 0.1); outline: none; }
        .status-ok { color: #16a34a; background-color: #f0fdf4; border-color: #bbf7d0; }
        .status-warn { color: #d97706; background-color: #fffbeb; border-color: #fef3c7; }
        .status-crit { color: #dc2626; background-color: #fef2f2; border-color: #fee2e2; }
        .rect-option-row { cursor: pointer; transition: all 0.2s; border-bottom: 1px solid #f1f5f9; }
        .rect-option-row:hover { background-color: #f0f9ff; transform: scale(1.005); }
        .rect-option-row.selected { background-color: #e0f2fe; border: 2px solid #0ea5e9; }
        .noise-badge { padding: 0.2rem 0.5rem; border-radius: 0.5rem; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="py-8 px-4 md:px-6">

<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-6 bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-sky-500/10 rounded-full blur-3xl -mr-20 -mt-20"></div>
        <div class="flex items-center space-x-5 z-10">
            <div class="w-14 h-14 bg-sky-600 rounded-2xl flex items-center justify-center shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-black tracking-tight uppercase text-white">Duct Master <span class="text-sky-400">Pro</span> <span class="text-xs bg-slate-800 px-2 py-1 rounded ml-2">v2.2</span></h1>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">Engineering Design & Validation Suite (Cleanroom Optimized)</p>
            </div>
        </div>
        <div class="z-10 flex gap-6 text-right">
            <div>
                <p class="text-[10px] text-slate-500 font-black uppercase">Fluid</p>
                <p class="text-xs font-bold">Std. Air (1.2 kg/mÂ³)</p>
            </div>
            <div class="h-8 w-px bg-slate-700"></div>
            <div>
                <p class="text-[10px] text-slate-500 font-black uppercase">Methodology</p>
                <p class="text-xs font-bold uppercase">ASHRAE / MAU Specialized</p>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- 1. ä½¿ç”¨è€…è¼¸å…¥å€ -->
        <aside class="lg:col-span-4 space-y-6">
            <section class="section-card p-6 md:p-8">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6 flex items-center">
                    <span class="w-1.5 h-4 bg-sky-500 mr-2 rounded-full"></span>
                    è¨­è¨ˆåƒæ•¸è¨­å®š Inputs
                </h3>
                
                <div class="space-y-5">
                    <div>
                        <label class="text-[10px] font-black text-slate-500 mb-1 block uppercase">è¨­è¨ˆé¢¨é‡ Airflow</label>
                        <div class="flex gap-1">
                            <input type="number" id="airflow" value="15000" class="eng-input text-lg" oninput="calculate()">
                            <select id="airflowUnit" class="eng-input w-24 bg-slate-50" onchange="calculate()">
                                <option value="CMH">CMH</option>
                                <option value="CFM">CFM</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] font-black text-slate-500 mb-1 block uppercase">ç”¨é€” Application</label>
                            <select id="application" class="eng-input bg-amber-50 border-amber-200 text-amber-900" onchange="updateApplicationDefaults()">
                                <option value="mau">MAU (å¤–æ°£ç³»çµ±)</option>
                                <option value="main">ä¸€èˆ¬ä¸»å¹¹ç·š (Main)</option>
                                <option value="sub">æ¬¡å¹¹é“ (Sub-main)</option>
                                <option value="branch">åˆ†æ”¯ç®¡ (Branch)</option>
                                <option value="return">å›é¢¨ç®¡ (Return)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-500 mb-1 block uppercase">æè³ª Material</label>
                            <select id="material" class="eng-input bg-slate-50" onchange="calculate()">
                                <option value="0.00009">éé‹…é‹¼æ¿ (Galv)</option>
                                <option value="0.00015">ä¸é½é‹¼ (SS)</option>
                                <option value="0.0003">ä¿æº«å…§è¥¯ (Liner)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-black text-slate-500 mb-1 block uppercase">è¨­è¨ˆæ³• Design Method</label>
                        <select id="method" class="eng-input" onchange="toggleMethodFields()">
                            <option value="friction">Equal Friction (ç­‰æ‘©æ“¦æ³•)</option>
                            <option value="velocity">Equal Velocity (ç­‰æµé€Ÿæ³•)</option>
                        </select>
                    </div>

                    <div id="frictionInputGroup">
                        <label class="text-[10px] font-black text-slate-500 mb-1 block uppercase">æ‘©æ“¦æå¤±é™åˆ¶ Friction Limit</label>
                        <div class="flex gap-2">
                            <input type="number" id="targetFriction" value="1.0" step="0.1" class="eng-input text-sky-600 font-bold" oninput="calculate()">
                            <span class="eng-input w-20 bg-slate-100 text-center flex items-center justify-center text-[10px] font-bold">Pa/m</span>
                        </div>
                    </div>

                    <div id="velocityInputGroup" class="hidden">
                        <label class="text-[10px] font-black text-slate-500 mb-1 block uppercase">æµé€Ÿé™åˆ¶ Velocity Limit</label>
                        <div class="flex gap-2">
                            <input type="number" id="targetVelocity" value="12.0" step="0.5" class="eng-input text-sky-600 font-bold" oninput="calculate()">
                            <span class="eng-input w-20 bg-slate-100 text-center flex items-center justify-center text-[10px] font-bold">m/s</span>
                        </div>
                    </div>

                    <div class="pt-4 border-t">
                        <label class="text-[10px] font-black text-slate-500 mb-3 block uppercase tracking-widest">é¢¨ç®¡å½¢å¼ Duct Shape</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="setShape('round')" id="btn-round" class="p-3 rounded-xl border-2 border-sky-600 bg-sky-50 text-sky-700 font-bold text-xs transition-all">åœ“å½¢ç®¡ Round</button>
                            <button onclick="setShape('rect')" id="btn-rect" class="p-3 rounded-xl border-2 border-slate-200 text-slate-400 font-bold text-xs transition-all">çŸ©å½¢ç®¡ Rect</button>
                        </div>
                    </div>

                    <div id="preferredHeightGroup" class="hidden pt-2">
                        <label class="text-[10px] font-black text-slate-500 mb-1 block uppercase">å¸Œæœ›é«˜åº¦ Preferred Height</label>
                        <div class="flex gap-2">
                            <input type="number" id="preferredHeight" class="eng-input" placeholder="è‡ªå‹•é…ç½® (Auto)" oninput="calculate()">
                            <span class="eng-input w-20 bg-slate-100 text-center flex items-center justify-center text-[10px] font-bold">mm</span>
                        </div>
                    </div>
                </div>
            </section>
        </aside>

        <!-- 2. è¨ˆç®—çµæœèˆ‡å·¥ç¨‹å€™é¸æ–¹æ¡ˆ -->
        <main class="lg:col-span-8 space-y-6">
            
            <section class="section-card overflow-hidden">
                <div class="bg-slate-800 px-8 py-6 text-white flex justify-between items-center">
                    <div>
                        <h3 class="text-sm font-black uppercase tracking-widest text-sky-400">ä¸»è¦è¨ˆç®—çµæœ Main Result</h3>
                    </div>
                    <div id="noiseLevel" class="noise-badge bg-emerald-500 text-white">ğŸ”‡ ä½å™ªéŸ³</div>
                </div>
                
                <div class="p-8 grid grid-cols-1 md:grid-cols-3 gap-8 items-center border-b border-slate-50">
                    <div class="space-y-1">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">é¸å®šå°ºå¯¸ Size</p>
                        <div class="flex items-baseline gap-2">
                            <span id="res-mainSize" class="text-4xl font-black text-slate-800">--</span>
                            <span class="text-lg font-bold text-slate-300">mm</span>
                        </div>
                    </div>
                    <div class="space-y-1 border-l pl-8">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">å¯¦éš›æµé€Ÿ Velocity</p>
                        <div class="flex items-baseline gap-2">
                            <span id="res-velocity" class="text-3xl font-black text-slate-700">--</span>
                            <span class="text-sm font-bold text-slate-300">m/s</span>
                        </div>
                    </div>
                    <div class="space-y-1 border-l pl-8">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">å¯¦éš›å£“æ Friction</p>
                        <div class="flex items-baseline gap-2">
                            <span id="res-friction" class="text-3xl font-black text-slate-700">--</span>
                            <span class="text-sm font-bold text-slate-300">Pa/m</span>
                        </div>
                    </div>
                </div>

                <div id="rectTableContainer" class="p-8 bg-slate-50 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-xs font-black text-slate-600 uppercase tracking-tight" id="listTitle">çŸ©å½¢é¢¨ç®¡å€™é¸æ¸…å–®</h4>
                    </div>
                    <div class="overflow-hidden rounded-xl border border-slate-200 bg-white">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-100 text-slate-500 uppercase text-[9px] font-black">
                                <tr>
                                    <th class="px-4 py-3">å°ºå¯¸ (W x H)</th>
                                    <th class="px-4 py-3 text-center">å¯¬é«˜æ¯” (AR)</th>
                                    <th class="px-4 py-3 text-center">æµé€Ÿ (v)</th>
                                    <th class="px-4 py-3 text-center">å£“æ (Î”P)</th>
                                    <th class="px-4 py-3 text-right">è©•ä¼°</th>
                                </tr>
                            </thead>
                            <tbody id="rectOptionBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="engAdviseCard" class="p-6 rounded-3xl border-l-8 flex items-start gap-5 section-card transition-colors duration-300">
                <div id="adviseIcon" class="text-2xl mt-1"></div>
                <div>
                    <h4 id="adviseTitle" class="font-black text-sm uppercase mb-1"></h4>
                    <p id="adviseContent" class="text-xs font-medium leading-relaxed text-slate-500"></p>
                </div>
            </section>
        </main>
    </div>

    <!-- MAU è¨­è¨ˆå°ˆå€èªªæ˜ -->
    <section class="mt-8 bg-sky-900 p-8 rounded-[2rem] text-white shadow-xl">
        <div class="flex items-center gap-3 mb-6">
            <div class="w-1.5 h-6 bg-sky-400 rounded-full"></div>
            <h3 class="text-lg font-bold tracking-tight uppercase">MAU è¨­è¨ˆå°ˆæ¥­æç¤º (Cleanroom Design Tips)</h3>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-xs leading-relaxed text-sky-100">
            <div class="space-y-4">
                <p>â— <b class="text-sky-300">é«˜é¢¨é€Ÿæ‡‰ç”¨ï¼š</b> åœ¨ç„¡å¡µå®¤ MAU ç³»çµ±ä¸­ï¼Œä¸»å¹¹ç·šé¢¨é€Ÿè¨­å®šåœ¨ $12 \sim 15\text{ m/s}$ æ˜¯å¸¸è¦‹çš„ã€‚é€™èƒ½é¡¯è‘—ç¸®æ¸›é¢¨ç®¡ä½”ç”¨çš„ç©ºé–“ï¼Œä½†å¿…é ˆç¢ºä¿æ©Ÿæˆ¿èˆ‡é¢¨ç®¡å…·å‚™è¶³å¤ çš„æ¶ˆéŸ³èˆ‡æ¸›æŒ¯æªæ–½ã€‚</p>
                <p>â— <b class="text-sky-300">ç­‰æ‘©æ“¦æ³•å»ºè­°ï¼š</b> MAU çš„ç¸½å£“åŠ›æå¤±é€šå¸¸è¼ƒå¤§ã€‚å»ºè­°å°‡ç­‰æ‘©æ“¦ææ§åˆ¶åœ¨ $1.2 \sim 1.5\text{ Pa/m}$ ä¹‹é–“ä»¥å„ªåŒ–é¢¨æ©ŸåŠŸç‡éœ€æ±‚ã€‚</p>
            </div>
            <div class="space-y-4">
                <p>â— <b class="text-sky-300">ä¸é½é‹¼ç®¡æ ¡æ ¸ï¼š</b> MAU é€é¢¨å´è‹¥ç‚º Class 100 ç­‰ç´šï¼Œå¸¸ä½¿ç”¨ä¸é½é‹¼ç®¡ (SS304)ã€‚è«‹å°‡ã€Œæè³ªã€åˆ‡æ›è‡³ä¸é½é‹¼ï¼Œç³»çµ±æœƒè‡ªå‹•è€ƒé‡è¼ƒé«˜çš„å£é¢æ‘©æ“¦åŠ›ã€‚</p>
                <p>â— <b class="text-sky-300">å¤§é¢¨é‡è€ƒæ…®ï¼š</b> ç•¶é¢¨é‡è¶…é $20,000\text{ CMH}$ æ™‚ï¼Œå‹™å¿…æ³¨æ„é¢¨ç®¡åŠ å¼·è‚‹ (Stiffener) çš„ä½ˆç½®ï¼Œä»¥é˜²æ­¢é«˜å£“ä¸‹çš„é¢¨ç®¡éœ‡å‹•ï¼ˆBooming Effectï¼‰ã€‚</p>
            </div>
        </div>
    </section>
</div>

<script>
    // --- å·¥ç¨‹ç‰©ç†å¸¸æ•¸ (ASHRAE Standard Air) ---
    const RHO = 1.2;          // ç©ºæ°£å¯†åº¦ (kg/mÂ³)
    const MU = 1.81e-5;       // å‹•é»æ»¯ä¿‚æ•¸ (PaÂ·s)
    let currentShape = 'round';
    let candidates = [];

    const APP_LIMITS = {
        mau: { v_max: 15.0, f_max: 1.8, name: "MAU ç³»çµ±", noise_offset: 4.0 },
        main: { v_max: 9.0, f_max: 1.2, name: "ä¸»å¹¹ç·š", noise_offset: 0 },
        sub: { v_max: 7.0, f_max: 1.0, name: "æ¬¡å¹¹é“", noise_offset: 0 },
        branch: { v_max: 5.0, f_max: 0.8, name: "åˆ†æ”¯ç®¡", noise_offset: 0 },
        return: { v_max: 6.0, f_max: 0.8, name: "å›é¢¨ç®¡", noise_offset: 0 }
    };

    /**
     * 1ï¸âƒ£ è¨ˆç®—æ‘©æ“¦å› å­ f (Colebrook-White via Swamee-Jain é¡¯å¼è§£)
     */
    function calcFrictionFactor(Re, D, epsilon) {
        if (Re < 2300) return 64 / Re;
        const term1 = epsilon / (3.7 * D);
        const term2 = 5.74 / Math.pow(Re, 0.9);
        return 0.25 / Math.pow(Math.log10(term1 + term2), 2);
    }

    /**
     * 2ï¸âƒ£ è¨ˆç®—å£“åŠ›æå¤±æ ¸å¿ƒ (Darcyâ€“Weisbach)
     */
    function calcPressureLossCore(V, D_re, D_pf, epsilon) {
        const Re = (RHO * V * D_re) / MU;
        const f = calcFrictionFactor(Re, D_re, epsilon);
        return f * (RHO * Math.pow(V, 2) / 2) * (1 / D_pf);
    }

    /**
     * 3ï¸âƒ£ ç­‰æ‘©æ“¦æ³•å°ºå¯¸æœå°‹ (Equal Friction Search)
     * è§£æåº¦ 0.01m (10mm)ï¼Œç¯„åœè‡ªé©æ‡‰ Q
     */
    function findEqualFrictionDiameter(Q, targetPf, epsilon) {
        let bestD = 0.15;
        let minDiff = Infinity;
        const maxD = Q > 8 ? 3.0 : 2.5; 
        
        for (let d = 0.15; d <= maxD; d += 0.01) {
            const V = Q / (Math.PI * Math.pow(d, 2) / 4);
            const currentPf = calcPressureLossCore(V, d, d, epsilon);
            const diff = Math.abs(currentPf - targetPf);
            if (diff < minDiff) {
                minDiff = diff;
                bestD = d;
            }
        }
        return bestD;
    }

    function updateApplicationDefaults() {
        const app = document.getElementById('application').value;
        const limits = APP_LIMITS[app];
        const method = document.getElementById('method').value;
        if (method === 'friction') document.getElementById('targetFriction').value = limits.f_max;
        else document.getElementById('targetVelocity').value = limits.v_max;
        calculate();
    }

    function toggleMethodFields() {
        const method = document.getElementById('method').value;
        document.getElementById('frictionInputGroup').classList.toggle('hidden', method === 'velocity');
        document.getElementById('velocityInputGroup').classList.toggle('hidden', method === 'friction');
        updateApplicationDefaults();
    }

    function setShape(shape) {
        currentShape = shape;
        document.getElementById('btn-round').className = `p-3 rounded-xl border-2 font-bold text-xs transition-all ${shape === 'round' ? 'border-sky-600 bg-sky-50 text-sky-700 shadow-inner' : 'border-slate-200 text-slate-400 bg-white'}`;
        document.getElementById('btn-rect').className = `p-3 rounded-xl border-2 font-bold text-xs transition-all ${shape === 'rect' ? 'border-sky-600 bg-sky-50 text-sky-700 shadow-inner' : 'border-slate-200 text-slate-400 bg-white'}`;
        document.getElementById('preferredHeightGroup').classList.toggle('hidden', shape !== 'rect');
        document.getElementById('rectTableContainer').classList.toggle('hidden', shape !== 'rect');
        calculate();
    }

    function calculate() {
        const airflowVal = parseFloat(document.getElementById('airflow').value) || 0;
        const Q = (document.getElementById('airflowUnit').value === 'CMH') ? airflowVal / 3600 : (airflowVal * 1.699) / 3600;
        if (Q <= 0) return;

        const epsilon = parseFloat(document.getElementById('material').value);
        const method = document.getElementById('method').value;
        let De_theoretical = 0;

        if (method === 'friction') {
            const targetPf = parseFloat(document.getElementById('targetFriction').value);
            De_theoretical = findEqualFrictionDiameter(Q, targetPf, epsilon);
        } else {
            const targetV = parseFloat(document.getElementById('targetVelocity').value);
            De_theoretical = Math.sqrt((4 * Q) / (Math.PI * targetV));
        }

        if (currentShape === 'round') {
            const suggestedD_mm = Math.ceil((De_theoretical * 1000) / 25) * 25;
            const realD = suggestedD_mm / 1000;
            const v = Q / (Math.PI * Math.pow(realD, 2) / 4);
            const pf = calcPressureLossCore(v, realD, realD, epsilon);
            
            document.getElementById('res-mainSize').innerText = `Ã˜ ${suggestedD_mm}`;
            updateMainDisplay(v, pf);
        } else {
            generateRectOptions(Q, De_theoretical, epsilon);
        }
    }

    function generateRectOptions(Q, De_target, epsilon) {
        const preferredH_mm = parseFloat(document.getElementById('preferredHeight').value);
        const hasFixedHeight = !isNaN(preferredH_mm) && preferredH_mm > 0;
        const body = document.getElementById('rectOptionBody');
        body.innerHTML = '';
        candidates = [];

        if (hasFixedHeight) {
            const H = preferredH_mm / 1000;
            let baseW = H; 
            for(let w = 0.1; w <= 5.0; w += 0.01) {
                let currentDe = 1.3 * Math.pow(w * H, 0.625) / Math.pow(w + H, 0.25);
                if(currentDe >= De_target) {
                    baseW = Math.ceil(w * 1000 / 25) * 25 / 1000;
                    break;
                }
            }
            const baseW_mm = Math.round(baseW * 1000);
            [baseW_mm - 50, baseW_mm - 25, baseW_mm, baseW_mm + 25, baseW_mm + 50].forEach(w_mm => {
                if (w_mm > 0) addCandidate(Q, w_mm / 1000, H, epsilon);
            });
            document.getElementById('listTitle').innerText = `MAU å›ºå®šé«˜åº¦æ–¹æ¡ˆ (H=${preferredH_mm}mm)`;
        } else {
            const standardWidths = [300, 400, 500, 600, 750, 900, 1000, 1200, 1500, 1800, 2100, 2400];
            standardWidths.forEach(w_mm => {
                const W = w_mm / 1000;
                let foundH = 0.15;
                for(let h = 0.15; h <= 3.0; h += 0.01) {
                    let currentDe = 1.3 * Math.pow(W * h, 0.625) / Math.pow(W + h, 0.25);
                    if(currentDe >= De_target) {
                        foundH = Math.ceil(h * 1000 / 25) * 25 / 1000;
                        break;
                    }
                }
                addCandidate(Q, W, foundH, epsilon);
            });
            document.getElementById('listTitle').innerText = "MAU è‡ªå‹•å»ºè­°å°ºå¯¸çŸ©é™£";
        }

        const finalOptions = candidates.filter(c => c.AR <= 4.5).sort((a,b) => a.AR - b.AR).slice(0, 5);
        finalOptions.forEach((opt, idx) => {
            const isGood = opt.V <= APP_LIMITS[document.getElementById('application').value].v_max && opt.AR <= 3.5;
            const row = document.createElement('tr');
            row.className = `rect-option-row ${idx === 0 ? 'selected' : ''}`;
            row.innerHTML = `
                <td class="px-4 py-3 font-bold text-slate-700">${opt.w_mm} x ${opt.h_mm}</td>
                <td class="px-4 py-3 text-center text-slate-500">${opt.AR.toFixed(1)} : 1</td>
                <td class="px-4 py-3 text-center font-mono font-bold">${opt.V.toFixed(2)}</td>
                <td class="px-4 py-3 text-center font-mono">${opt.Pf.toFixed(2)}</td>
                <td class="px-4 py-3 text-right">
                    <span class="text-[9px] font-black uppercase ${isGood ? 'text-emerald-500' : 'text-amber-500'}">
                        ${isGood ? 'âœ” æ¨ä»‹' : 'âš  è­¦å‘Š'}
                    </span>
                </td>
            `;
            row.onclick = () => {
                document.querySelectorAll('.rect-option-row').forEach(r => r.classList.remove('selected'));
                row.classList.add('selected');
                applyOption(opt);
            };
            body.appendChild(row);
        });
        if (finalOptions.length > 0) applyOption(finalOptions[0]);
    }

    /**
     * ğŸ”§ æ ¸å¿ƒä¿®æ­£ï¼šaddCandidate()
     * Re è¨ˆç®—æ¡ç”¨ç­‰æ•ˆç›´å¾‘ Deï¼Œå£“æè¨ˆç®—å›æ­¸æ°´åŠ›ç›´å¾‘ Dh
     */
    function addCandidate(Q, W, H, epsilon) {
        const A = W * H;
        const V = Q / A;

        // ç­‰æ•ˆç›´å¾‘ (ASHRAE Equal Friction Equivalence)
        const De = 1.3 * Math.pow(W * H, 0.625) / Math.pow(W + H, 0.25);
        // æ°´åŠ›ç›´å¾‘ (Actual Friction Calculation)
        const Dh = (2 * W * H) / (W + H);

        // æ ¸å¿ƒè¨ˆç®—
        const Pf = calcPressureLossCore(V, De, Dh, epsilon);

        const AR = Math.max(W / H, H / W);
        candidates.push({
            w_mm: Math.round(W * 1000),
            h_mm: Math.round(H * 1000),
            AR,
            V,
            Pf
        });
    }

    function applyOption(opt) {
        document.getElementById('res-mainSize').innerText = `${opt.w_mm} x ${opt.h_mm}`;
        updateMainDisplay(opt.V, opt.Pf);
    }

    function updateMainDisplay(v, f) {
        document.getElementById('res-velocity').innerText = v.toFixed(2);
        document.getElementById('res-friction').innerText = f.toFixed(2);

        const app = document.getElementById('application').value;
        const limits = APP_LIMITS[app];
        const v_eff = v - (limits.noise_offset || 0);
        const noiseBadge = document.getElementById('noiseLevel');

        if (v_eff < 6.5) { 
            noiseBadge.innerText = "ğŸ”‡ è¾¦å…¬ç´š (ä½å™ªéŸ³)"; 
            noiseBadge.className = "noise-badge bg-emerald-500 text-white"; 
        } else if (v_eff <= 11.0) { 
            noiseBadge.innerText = "ğŸ”ˆ æ©Ÿæˆ¿ç´š (ä¸€èˆ¬å™ªéŸ³)"; 
            noiseBadge.className = "noise-badge bg-amber-500 text-white"; 
        } else { 
            noiseBadge.innerText = "ğŸ”Š å·¥æ¥­ç´š (éœ€æ¶ˆéŸ³)"; 
            noiseBadge.className = "noise-badge bg-red-600 text-white"; 
        }

        const adviseCard = document.getElementById('engAdviseCard');
        const icon = document.getElementById('adviseIcon');
        const title = document.getElementById('adviseTitle');
        const content = document.getElementById('adviseContent');

        if (v <= limits.v_max && f <= limits.f_max * 1.05) {
            adviseCard.className = "p-6 rounded-3xl border-l-8 flex items-start gap-5 status-ok section-card";
            icon.innerText = "âœ…";
            title.innerText = `å·¥ç¨‹æ ¡æ ¸ï¼š${limits.name} é€šé`;
            content.innerText = `æ­¤é…ç½®å®Œå…¨ç¬¦åˆ Darcy-Colebrook ç‰©ç†æ¨¡å‹ã€‚å£“æèª¤å·®åœ¨ Â±5% å…§ï¼Œæµé€Ÿèˆ‡å£“æå¹³è¡¡è‰¯å¥½ï¼Œé©ç”¨æ–¼ç„¡å¡µå®¤é«˜æ¨™æº–ç’°å¢ƒã€‚`;
        } else {
            adviseCard.className = "p-6 rounded-3xl border-l-8 flex items-start gap-5 status-crit section-card";
            icon.innerText = "ğŸ›‘";
            title.innerText = `å·¥ç¨‹æ ¡æ ¸ï¼šè¶…å‡º ${limits.name} å»ºè­°`;
            content.innerText = `è­¦å‘Šï¼šå¯¦éš›å£“æ(${f.toFixed(2)} Pa/m)æˆ–æµé€Ÿè¶…å‡ºå»ºè­°ä¸Šé™ã€‚é€™å°‡é¡¯è‘—å¢åŠ é¢¨æ©Ÿè€—åŠŸä¸¦å¼•ç™¼æ°£æµå†ç”Ÿå™ªéŸ³ï¼Œå¼·çƒˆå»ºè­°åŠ å¤§é¢¨ç®¡æˆªé¢ã€‚`;
        }
    }

    toggleMethodFields();
</script>

</body>
</html>
