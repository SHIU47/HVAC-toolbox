<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Master Pro v1.7 - 冷卻水塔計算系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #334155; }
        .sticky-col { position: sticky; left: 0; background: inherit; z-index: 20; border-right: 2px solid #e2e8f0; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .input-glow:focus { border-color: #0ea5e9; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15); outline: none; }
        .row-input { background-color: #fffbeb; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="py-6 px-4 md:px-8">

<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6 bg-slate-900 p-8 rounded-[2rem] text-white shadow-xl relative overflow-hidden">
        <div class="flex items-center gap-5 z-10">
            <div class="bg-sky-600 w-16 h-16 rounded-2xl text-white flex items-center justify-center shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
            </div>
            <div>
                <h1 class="text-3xl font-black tracking-tight uppercase">CT Master <span class="text-sky-400">Pro</span></h1>
                <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mt-1">v1.7 工程師顧問版 </p>
            </div>
        </div>
        <div class="flex items-center gap-3 bg-slate-800 px-5 py-3 rounded-2xl border border-slate-700 no-print">
            <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
            <span class="text-[10px] font-black text-slate-300 uppercase tracking-tighter leading-none">Auto-Calculate: Enabled</span>
        </div>
    </header>

    <!-- Main Table Container -->
    <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-2xl overflow-hidden mb-10">
        <div class="table-container overflow-x-auto relative">
            <table class="w-full text-left border-collapse" id="mainCalcTable">
                <thead>
                    <tr class="bg-slate-900 text-white text-[10px] uppercase tracking-[0.2em] font-black" id="tableHeader">
                        <th class="p-5 border-r border-slate-800 sticky-col bg-slate-900 z-30 w-64 shadow-xl text-center">計算項目 \ 案例案例</th>
                        <!-- 案例標題由 JS 動態生成 -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- 表格內容由 JS 動態生成 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Footer Summary & Basis -->
    <footer class="mt-10 grid grid-cols-1 lg:grid-cols-3 gap-8 text-[11px] text-slate-500 leading-relaxed no-print">
        <div class="lg:col-span-2 bg-white p-8 rounded-[2rem] border border-slate-200 shadow-sm">
            <h3 class="font-black text-slate-800 uppercase mb-4 flex items-center gap-2">
                <div class="w-1 h-4 bg-sky-500 rounded-full"></div> 設計基準與物料平衡 (Design Basis)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <p>● <span class="font-bold text-slate-700">熱力學常數：</span>1 RT = 3.51685 kW，水比熱 $C_p = 4.186$ kJ/kg·K。</p>
                    <p>● <span class="font-bold text-slate-700">循環量公式：</span>$Flow = (RT \times 3.517 \times HRF) / (4.186 \times \Delta T)$。</p>
                    <p>● <span class="font-bold text-slate-700">蒸發損失量：</span>採用 ASHRAE 潛熱估算法，係數取 0.00153。</p>
                </div>
                <div class="space-y-2">
                    <p>● <span class="font-bold text-slate-700">Windage 損失：</span>單位為 %。程式自動將輸入值除以 100 進行運算。</p>
                    <p>● <span class="font-bold text-slate-700">補水安全係數：</span>設計值取「計算需求」或「2% 循環量」之較大值。</p>
                    <p>● <span class="font-bold text-slate-700">流洩判定：</span>若計算流洩量為負，代表自然飄水已足以維持濃縮倍率。</p>
                </div>
            </div>
        </div>
        <div class="bg-slate-900 p-8 rounded-[2rem] text-white flex flex-col justify-between shadow-2xl">
            <div>
                <h3 class="font-black text-sky-400 uppercase mb-4 flex items-center gap-2 tracking-widest text-sm">
                    工程邊際校核
                </h3>
                <div class="space-y-3 opacity-80">
                    <p>1. <span class="text-amber-400 font-bold">風損警告</span>：若飄水損失過大導致不需排汙，流洩量將標示為 0 並提示「自然排放已足」。</p>
                    <p>2. <span class="text-red-400 font-bold">無效輸入</span>：$\Delta T$、RT 或 HRF 必須大於 0，否則系統將顯示 Error。</p>
                </div>
            </div>
            <div class="mt-8 pt-4 border-t border-slate-800 text-[9px] font-mono text-slate-500 uppercase tracking-widest">
                System Build 1.7 • Stable Preview
            </div>
        </div>
    </footer>
</div>

<script>
    // --- 工程常數 ---
    const RT_TO_KW = 3.51685;
    const WATER_CP = 4.186;

    const initialCases = [
        { rt: 1000, hrf: 1.25, dt: 5, coc: 4, windage: 0.05 },
        { rt: 800,  hrf: 1.3,  dt: 5, coc: 5, windage: 0.05 },
        { rt: 500,  hrf: 1.2,  dt: 5, coc: 3, windage: 0.1 },
        { rt: 1200, hrf: 1.25, dt: 6, coc: 4, windage: 0.05 },
        { rt: 600,  hrf: 1.25, dt: 5, coc: 4, windage: 0.05 },
        { rt: 2000, hrf: 1.25, dt: 5, coc: 6, windage: 0.02 }
    ];

    // --- 初始化表格結構 ---
    function initTable() {
        const header = document.getElementById('tableHeader');
        const body = document.getElementById('tableBody');
        
        initialCases.forEach((_, i) => {
            const th = document.createElement('th');
            th.className = "p-5 text-center min-w-[170px] border-r border-slate-800";
            th.innerText = `Case-${i+1}`;
            header.appendChild(th);
        });

        const rows = [
            { id: 'in_rt', label: '1. 冰水主機能力 (RT)', type: 'input', key: 'rt', placeholder: '1000' },
            { id: 'in_hrf', label: '2. HRF (塞熱因數)', type: 'input', key: 'hrf', step: 0.01, placeholder: '1.25' },
            { id: 'in_dt', label: '3. 冷卻水溫差 ΔT (°C)', type: 'input', key: 'dt', placeholder: '5' },
            { id: 'in_coc', label: '4. 設定濃縮倍率 COC', type: 'input', key: 'coc', placeholder: '4' },
            { id: 'in_wind', label: '5. 飄水損失 Windage (%)', type: 'input', key: 'windage', step: 0.001, placeholder: '例: 0.05% 填 0.05' },
            { id: 'sep_a', label: '核心計算區 A：理論模型 (LPS)', type: 'separator', color: 'bg-sky-600' },
            { id: 'res_circ', label: '循環水量 Circulation', type: 'display', key: 'circ' },
            { id: 'res_evap', label: '蒸發量 Evaporation', type: 'display', key: 'evap', dec: 3 },
            { id: 'res_wind', label: '飄水損失量 Windage', type: 'display', key: 'wind', dec: 3 },
            { id: 'res_blow', label: '人為流洩量 Blowdown', type: 'display', key: 'blow', dec: 3, checkWarn: true },
            { id: 'res_makeup_a', label: '補給水量需求 Makeup-A', type: 'display', key: 'makeupA', bold: true },
            { id: 'sep_b', label: '核心計算區 B：自然平衡', type: 'separator', color: 'bg-emerald-600' },
            { id: 'res_eqcoc', label: '等效濃縮倍率 (COC eq)', type: 'display', key: 'eqcoc', suffix: 'x' },
            { id: 'res_makeup_b', label: '無流洩補水量 Makeup-B', type: 'display', key: 'makeupB' },
            { id: 'sep_c', label: '最終設計決策 (Design Result)', type: 'separator', color: 'bg-indigo-900', rowClass: 'h-16 shadow-lg' },
            { id: 'res_design', label: '設計總補水量 (LPS)', type: 'final', key: 'design' },
            { id: 'res_source', label: '判定依據 Source', type: 'source', key: 'source' }
        ];

        rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.id = `row_${row.id}`;
            
            if (row.type === 'separator') {
                tr.className = `${row.color} text-white font-black text-[9px] uppercase tracking-widest ${row.rowClass || ''}`;
                tr.innerHTML = `<td class="p-4 sticky-col ${row.color}">${row.label}</td><td colspan="${initialCases.length}" class="p-3"></td>`;
                body.appendChild(tr);
                return;
            }

            let labelClass = "p-4 text-xs font-bold border-r border-slate-100 sticky-col bg-white z-10";
            if (row.type === 'input') labelClass = "p-5 text-xs font-black border-r border-amber-100 sticky-col bg-amber-50 z-10 text-amber-900";
            if (row.type === 'final') labelClass = "p-6 text-sm font-black border-r border-indigo-800 sticky-col bg-indigo-900 text-white z-10";
            
            let html = `<td class="${labelClass}">${row.label}</td>`;

            initialCases.forEach((c, i) => {
                const caseIdx = i + 1;
                if (row.type === 'input') {
                    // 直接在標籤內加入 oninput 確保即時觸發
                    html += `<td class="p-3 border-r border-amber-100 bg-amber-50/40">
                        <input type="number" step="${row.step || 'any'}" 
                               placeholder="${row.placeholder || ''}"
                               data-case="${caseIdx}" data-key="${row.key}" value="${c[row.key]}" 
                               oninput="calculate()"
                               class="w-full bg-white border border-amber-200 rounded-xl p-2.5 text-center font-bold text-amber-700 input-glow shadow-sm">
                    </td>`;
                } else if (row.type === 'final') {
                    html += `<td id="val_${row.key}_${caseIdx}" class="p-6 text-center border-r border-indigo-800 font-black text-3xl text-emerald-400 bg-slate-900">--</td>`;
                } else if (row.type === 'source') {
                    html += `<td id="val_${row.key}_${caseIdx}" class="p-3 text-center border-r border-slate-200 text-[9px] font-bold text-indigo-500 italic bg-slate-50/50 leading-tight">--</td>`;
                } else {
                    let cellClass = `p-4 text-center border-r border-slate-100 font-mono text-sm ${row.bold ? 'font-black text-slate-800 bg-slate-50/30' : ''}`;
                    html += `<td id="val_${row.key}_${caseIdx}" class="${cellClass}">--</td>`;
                }
            });

            tr.innerHTML = html;
            body.appendChild(tr);
        });
    }

    // --- 核心計算邏輯 ---
    function calculate() {
        const caseCount = initialCases.length;

        for (let i = 1; i <= caseCount; i++) {
            const inputs = document.querySelectorAll(`input[data-case="${i}"]`);
            const vals = {};
            inputs.forEach(input => vals[input.dataset.key] = parseFloat(input.value) || 0);
            
            const rt = vals.rt;
            const hrf = vals.hrf;
            const dt = vals.dt;
            const coc = vals.coc;
            const windageRatio = vals.windage / 100; // 0.05% -> 0.0005

            const isError = (dt <= 0 || rt <= 0 || hrf <= 0);
            
            let data = { circ: 0, evap: 0, wind: 0, blow: 0, makeupA: 0, eqcoc: 0, makeupB: 0, design: 0, source: "--", blowWarn: false };

            if (!isError) {
                // A 區：理論平衡
                data.circ = (rt * RT_TO_KW * hrf) / (WATER_CP * dt);
                data.evap = data.circ * dt * 0.00153; 
                data.wind = data.circ * windageRatio;
                
                const rawBlow = coc > 1 ? (data.evap / (coc - 1)) - data.wind : 0;
                if (rawBlow < 0) {
                    data.blow = 0;
                    data.blowWarn = true; 
                } else {
                    data.blow = rawBlow;
                }
                
                data.makeupA = data.evap + data.wind + data.blow;

                // B 區：自然平衡
                data.eqcoc = data.wind > 0 ? (data.evap + data.wind) / data.wind : 0; 
                data.makeupB = data.evap + data.wind;

                // C 區：設計決策
                const rule2Pct = data.circ * 0.02;
                if (data.makeupA >= rule2Pct) {
                    data.design = data.makeupA;
                    data.source = "A區計算需求值";
                } else {
                    data.design = rule2Pct;
                    data.source = "2% 循環量規範";
                }
            }

            updateCaseUI(i, data, isError);
        }
    }

    function updateCaseUI(idx, data, isError) {
        const update = (key, val, dec = 2, suffix = "") => {
            const el = document.getElementById(`val_${key}_${idx}`);
            if (!el) return;
            if (isError) {
                el.innerText = "Error";
                el.classList.add('text-red-500');
            } else {
                el.classList.remove('text-red-500');
                if (key === 'eqcoc' && val === 0) {
                    el.innerText = "無自然濃縮";
                    el.classList.add('text-[10px]', 'text-slate-400');
                } else {
                    el.classList.remove('text-[10px]', 'text-slate-400');
                    el.innerText = val.toFixed(dec) + (suffix ? " " + suffix : "");
                }
            }
        };

        update('circ', data.circ);
        update('evap', data.evap, 3);
        update('wind', data.wind, 3);
        
        // 流洩量警示邏輯
        const blowEl = document.getElementById(`val_blow_${idx}`);
        if (!isError && data.blowWarn) {
            blowEl.innerHTML = `<div class="flex flex-col"><span class="text-amber-500 font-bold">0.000</span><span class="text-[8px] font-bold text-amber-600 tracking-tighter">自然排放已足</span></div>`;
        } else {
            update('blow', data.blow, 3);
        }

        update('makeupA', data.makeupA);
        update('eqcoc', data.eqcoc, 1, "x");
        update('makeupB', data.makeupB);
        update('design', data.design, 2, "LPS");
        
        const sourceEl = document.getElementById(`val_source_${idx}`);
        sourceEl.innerText = isError ? "數據不足" : data.source;
    }

    // --- 啟動 ---
    window.onload = () => {
        initTable();
        calculate();
    };
</script>

</body>

</html>
